<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Karaoke Sub Tool v3</title>
<link rel="icon" type="image/x-icon" href="/static/favicon/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/static/favicon/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/favicon-180x180.png">
<link rel="manifest" href="/static/favicon/site.webmanifest">
<meta name="theme-color" content="#00ffb4">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0c0e14;--bg2:#13161f;--bg3:#191d29;--bg4:#1e2333;--border:#262b3d;
  --text:#e2e4ea;--dim:#7a7f94;--accent:#00e5a0;--accent2:#00b8ff;
  --fg:#e2e4ea;--surface:#191d29;
  --danger:#ff4466;--warn:#ffaa22;--purple:#a855f7;--r:10px;
  --font:'Outfit',system-ui,sans-serif;--mono:'JetBrains Mono',monospace;
}
/* ‚îÄ‚îÄ Theme: Neon ‚îÄ‚îÄ */
[data-theme="neon"]{
  --bg:#0a0015;--bg2:#120025;--bg3:#1a0035;--bg4:#220045;--border:#3a1a6a;
  --text:#f0e0ff;--dim:#9070b8;--accent:#ff00ff;--accent2:#00ffff;
  --danger:#ff2050;--warn:#ff8800;--purple:#b040ff;
}
/* ‚îÄ‚îÄ Theme: Light ‚îÄ‚îÄ */
[data-theme="light"]{
  --bg:#f5f6fa;--bg2:#ecedf2;--bg3:#e3e4ec;--bg4:#d8dae4;--border:#c0c4d6;
  --text:#1a1d2e;--dim:#6b7094;--accent:#00b87a;--accent2:#0088cc;
  --danger:#e03050;--warn:#d48a00;--purple:#7c3aed;
}
[data-theme="light"] .btn{color:#fff}
[data-theme="light"] .hdr h1{-webkit-text-fill-color:transparent}
/* ‚îÄ‚îÄ Theme: Warm ‚îÄ‚îÄ */
[data-theme="warm"]{
  --bg:#1a1410;--bg2:#221a14;--bg3:#2a201a;--bg4:#332820;--border:#4a3a2a;
  --text:#f0e6d8;--dim:#a0907a;--accent:#ff9f43;--accent2:#ee5a24;
  --danger:#ff4466;--warn:#ffc048;--purple:#c56cf0;
}
/* ‚îÄ‚îÄ Theme Switcher ‚îÄ‚îÄ */
.theme-sw{display:flex;gap:3px;margin-left:8px}
.theme-sw button{width:18px;height:18px;border-radius:50%;border:2px solid transparent;padding:0;cursor:pointer;transition:all .2s}
.theme-sw button:hover{transform:scale(1.3)}
.theme-sw button.on{border-color:var(--text);box-shadow:0 0 8px var(--accent)}
.tsw-dark{background:linear-gradient(135deg,#0c0e14,#191d29)}
.tsw-neon{background:linear-gradient(135deg,#0a0015,#ff00ff)}
.tsw-light{background:linear-gradient(135deg,#f5f6fa,#00b87a)}
.tsw-warm{background:linear-gradient(135deg,#1a1410,#ff9f43)}
/* ‚îÄ‚îÄ Audio Spectrum ‚îÄ‚îÄ */
.spectrum{position:relative;height:32px;margin-top:2px;border-radius:4px;overflow:hidden;cursor:pointer}
.spectrum canvas{width:100%;height:100%;display:block}
/* ‚îÄ‚îÄ A/B Loop ‚îÄ‚îÄ */
.loop-region{position:absolute;top:0;height:100%;background:var(--accent);opacity:.12;pointer-events:none;z-index:2;border-left:2px solid var(--accent);border-right:2px solid var(--accent)}
.loop-label{position:absolute;top:-14px;font-size:8px;font-family:var(--mono);color:var(--accent);font-weight:700;pointer-events:none;z-index:3}
/* ‚îÄ‚îÄ Tap-to-Time ‚îÄ‚îÄ */
.ttt-overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:1000;display:none;flex-direction:column;align-items:center;justify-content:center;font-family:var(--font)}
.ttt-overlay.open{display:flex}
.ttt-counter{font-size:5rem;font-weight:700;font-family:var(--mono);background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:20px;transition:transform .08s}
.ttt-counter.pulse{transform:scale(1.15)}
.ttt-line{font-size:1.5rem;color:var(--text);max-width:80vw;text-align:center;opacity:.6;transition:opacity .15s,transform .15s}
.ttt-line.active{opacity:1;transform:scale(1.05);color:var(--accent)}
.ttt-line.done{opacity:.25;font-size:1rem;transform:scale(.9)}
.ttt-hint{font-size:.75rem;color:var(--dim);margin-top:30px}
.ttt-progress{width:60vw;height:4px;background:var(--bg4);border-radius:2px;margin-top:12px;overflow:hidden}
.ttt-progress-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .1s linear;border-radius:2px}
.ttt-flash{position:fixed;inset:0;background:var(--accent);opacity:0;pointer-events:none;z-index:1001;transition:opacity .06s}
/* ‚îÄ‚îÄ Fullscreen Karaoke ‚îÄ‚îÄ */
.fsk{position:fixed;inset:0;background:#000;z-index:900;display:none;flex-direction:column;align-items:center;justify-content:center;cursor:none}
.fsk.open{display:flex}
.fsk-text{font-size:3.5rem;font-weight:700;color:#fff;text-align:center;max-width:90vw;line-height:1.3;text-shadow:0 0 40px rgba(0,229,160,.3)}
.fsk-next{font-size:1.4rem;color:rgba(255,255,255,.2);margin-top:20px;max-width:80vw;text-align:center}
.fsk-progress{position:fixed;bottom:0;left:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .05s linear}
.fsk-time{position:fixed;bottom:12px;right:20px;font-family:var(--mono);font-size:.8rem;color:rgba(255,255,255,.3)}
.fsk-word{display:inline-block;transition:color .1s}
.fsk-word.hl{color:var(--accent);text-shadow:0 0 20px var(--accent)}
.fsk-word.fsk-fill{background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:none}
html{font-size:14px}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
a{color:var(--accent2);text-decoration:none}
button{font-family:var(--font);cursor:pointer;border:none;border-radius:6px;padding:7px 14px;font-weight:500;font-size:.82rem;transition:all .15s}
.btn{background:var(--accent);color:#0c0e14;font-weight:600}
.btn:hover{filter:brightness(1.15);transform:translateY(-1px)}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none;filter:none}
.btn-s{background:var(--bg4);color:var(--text);border:1px solid var(--border)}
.btn-s:hover{background:var(--border)}
.btn-d{background:var(--danger);color:#fff}
.btn-sm{padding:4px 9px;font-size:.75rem}
input,select,textarea{font-family:var(--font);background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:7px 10px;font-size:.82rem;width:100%;transition:border-color .15s}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent)}
label{display:block;font-size:.72rem;font-weight:500;color:var(--dim);margin-bottom:3px;text-transform:uppercase;letter-spacing:.04em}
.app{display:grid;grid-template-columns:290px 1fr;grid-template-rows:auto 1fr;min-height:100vh}
.hdr{grid-column:1/-1;display:flex;align-items:center;gap:14px;padding:10px 20px;background:var(--bg2);border-bottom:1px solid var(--border)}
.hdr h1{font-size:1.1rem;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
.hdr .v{font-family:var(--mono);font-size:.6rem;background:var(--bg4);color:var(--dim);padding:2px 6px;border-radius:4px}
.hdr .dot{width:8px;height:8px;border-radius:50%;margin-left:auto}
.dot-ok{background:var(--accent)}.dot-err{background:var(--danger)}
.side{background:var(--bg2);border-right:1px solid var(--border);overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:12px}
.main{overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:14px}
.card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:12px}
.card-h{font-weight:600;font-size:.82rem;margin-bottom:8px;display:flex;align-items:center;gap:7px}
.dz{border:2px dashed var(--border);border-radius:var(--r);padding:22px 12px;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg3)}
.dz:hover,.dz.over{border-color:var(--accent);background:rgba(0,229,160,.04)}
.dz .ic{font-size:1.6rem;display:block;margin-bottom:4px}
.dz .hn{font-size:.7rem;color:var(--dim);margin-top:3px}
.sg{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.sg .f{grid-column:1/-1}
.tg{display:flex;align-items:center;gap:6px;cursor:pointer;font-size:.78rem}
.tg input{width:auto;accent-color:var(--accent)}
.ji{display:flex;align-items:center;gap:8px;padding:8px;border-radius:7px;cursor:pointer;transition:background .15s;border:1px solid transparent}
.ji:hover{background:var(--bg4)}
.ji.active{border-color:var(--accent);background:var(--bg4)}
.jic{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.85rem;flex-shrink:0}
.jic.p{background:rgba(122,127,148,.15);color:var(--dim)}
.jic.r{background:rgba(0,184,255,.12);color:var(--accent2)}
.jic.c{background:rgba(0,229,160,.12);color:var(--accent)}
.jic.f{background:rgba(255,68,102,.12);color:var(--danger)}
.jic.x{background:rgba(255,68,102,.08);color:var(--dim)}
.jm{flex:1;min-width:0}
.jn{font-weight:500;font-size:.78rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.js{font-size:.65rem;color:var(--dim)}
.ji-cancel{background:none;border:none;color:var(--dim);cursor:pointer;font-size:.75rem;padding:2px 6px;border-radius:4px;opacity:.6;transition:all .15s;flex-shrink:0}
.ji-cancel:hover{opacity:1;color:var(--danger);background:rgba(255,68,102,.12)}
.pb{height:3px;background:var(--border);border-radius:2px;margin-top:4px;overflow:hidden}
.pf{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .3s}
.player{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:12px}
.player-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap}
.player-row button{padding:4px 10px;font-size:.75rem}
.player-time{font-family:var(--mono);font-size:.72rem;color:var(--dim);min-width:90px}
.waveform{width:100%;height:56px;background:var(--bg);border-radius:6px;cursor:crosshair;position:relative;overflow:hidden}
.waveform canvas{width:100%;height:100%;border-radius:6px}
.wf-cursor{position:absolute;top:0;width:2px;height:100%;background:var(--accent);pointer-events:none;transition:left .05s linear}
/* Karaoke live display */
.karaoke-live{background:var(--bg);border:1px solid var(--border);border-radius:var(--r);padding:16px 20px;min-height:52px;font-size:1.1rem;font-weight:500;text-align:center;transition:all .2s;overflow:hidden;cursor:pointer;position:relative}
.karaoke-live:hover::after{content:'‚úèÔ∏è Doppelklick zum Bearbeiten';position:absolute;top:2px;right:8px;font-size:.55rem;color:var(--dim);font-weight:400}
.karaoke-live .kw{display:inline;transition:color .15s}
.karaoke-live .kw.active{color:var(--accent)}
.karaoke-live .kw.past{color:var(--accent);opacity:.7}
.karaoke-live .kw.fill{background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:inline}
/* Offset Control */
.offset-row{display:flex;align-items:center;gap:6px;margin-top:4px;font-size:.65rem;user-select:none}
.offset-row .offset-btns{display:flex;gap:2px}
.offset-row .offset-btn{padding:2px 6px;font-size:.6rem;font-family:var(--mono);border-radius:4px;background:var(--bg3);color:var(--dim);border:1px solid var(--border);cursor:pointer;transition:all .15s}
.offset-row .offset-btn:hover{color:var(--fg);border-color:var(--accent);background:var(--bg4)}
.offset-row .offset-val{font-family:var(--mono);font-size:.7rem;min-width:52px;text-align:center;font-weight:600;padding:2px 6px;border-radius:4px;transition:color .15s}
.offset-row .offset-val.neg{color:var(--warn)}
.offset-row .offset-val.pos{color:var(--accent)}
.offset-row .offset-val.zero{color:var(--dim)}
.offset-row .offset-apply{padding:2px 8px;font-size:.6rem;border-radius:4px;background:var(--accent);color:var(--bg);border:none;cursor:pointer;font-weight:600;opacity:.8;transition:opacity .15s}
.offset-row .offset-apply:hover{opacity:1}
.offset-row .offset-lbl{color:var(--dim);font-size:.6rem}
/* Minimap */
.minimap{height:18px;background:var(--bg);border-radius:4px;position:relative;cursor:pointer;margin-top:4px}
.mm-seg{position:absolute;top:2px;height:14px;border-radius:2px;background:var(--accent2);opacity:.3;transition:opacity .1s}
.mm-seg.mm-low{background:var(--warn)}
.mm-seg.mm-pin{background:var(--purple)}
.mm-cur{position:absolute;top:0;width:2px;height:100%;background:var(--accent);pointer-events:none}
/* Segments */
.segs{display:flex;flex-direction:column;gap:5px;max-height:50vh;overflow-y:auto}
.si{display:grid;grid-template-columns:44px 1fr 52px 46px;gap:6px;align-items:center;padding:7px 9px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;font-size:.8rem;transition:all .15s}
.si:hover{border-color:var(--accent2)}
.si.low{border-left:3px solid var(--warn)}
.si.active{border-color:var(--accent);background:rgba(0,229,160,.04)}
.si.overlap{border-right:3px solid var(--danger)}
.si.pinned{border-left:3px solid var(--purple)}
.sidx{font-family:var(--mono);font-size:.65rem;color:var(--dim);text-align:center;cursor:pointer}
.sidx:hover{color:var(--accent)}
.stm{font-family:var(--mono);font-size:.6rem;color:var(--dim);display:block}
.stm-edit{background:transparent;border:none;color:var(--dim);font-family:var(--mono);font-size:.6rem;width:55px;padding:0;cursor:pointer}
.stm-edit:hover{color:var(--accent2)}
.stm-edit:focus{color:var(--text);border-bottom:1px solid var(--accent)}
.stx{position:relative}
.stx textarea{min-height:30px;resize:vertical;font-size:.8rem;line-height:1.3;background:var(--bg4);border:1px solid transparent;border-radius:4px;padding:4px 6px;transition:border-color .15s,background .15s}
.stx textarea:hover{border-color:var(--border);background:var(--bg3)}
.stx textarea:focus{border-color:var(--accent);background:var(--bg2);outline:none}
.stx .save-ok{position:absolute;top:4px;left:4px;font-size:.6rem;color:var(--accent);opacity:0;transition:opacity .3s}
.stx .speaker-tag{position:absolute;top:2px;right:2px;font-size:.55rem;background:var(--purple);color:#fff;padding:1px 5px;border-radius:3px;cursor:pointer}
.stx .cps-warn{position:absolute;bottom:2px;right:2px;font-size:.55rem;color:var(--warn);font-family:var(--mono)}
.scf{font-family:var(--mono);font-size:.6rem;padding:2px 4px;border-radius:3px;text-align:center}
.ch{background:rgba(0,229,160,.12);color:var(--accent)}
.cm{background:rgba(255,170,34,.12);color:var(--warn)}
.cl{background:rgba(255,68,102,.12);color:var(--danger)}
.sbtns{display:flex;flex-wrap:wrap;gap:2px}
.sbtns button{padding:2px 4px;font-size:.6rem;background:var(--bg4);color:var(--dim);border:1px solid var(--border)}
.sbtns button:hover{color:var(--text);border-color:var(--accent)}
.dls{display:flex;gap:5px;flex-wrap:wrap;align-items:center}
.dl{display:inline-flex;align-items:center;gap:4px;padding:5px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:.72rem;font-weight:500;cursor:pointer;transition:all .15s}
.dl:hover{border-color:var(--accent);background:var(--bg4)}
.dl .x{font-family:var(--mono);font-size:.55rem;background:var(--accent);color:#0c0e14;padding:1px 3px;border-radius:2px;font-weight:700}
.tabs{display:flex;gap:2px;background:var(--bg);padding:2px;border-radius:7px}
.tab{padding:5px 12px;border-radius:5px;font-size:.72rem;font-weight:500;color:var(--dim);cursor:pointer;transition:all .15s;background:transparent}
.tab.on{background:var(--bg3);color:var(--text)}
.tab:hover:not(.on){color:var(--text)}
.empty{text-align:center;padding:36px;color:var(--dim)}
.empty .ic{font-size:2rem;margin-bottom:8px;display:block;opacity:.4}
.empty p{font-size:.82rem;max-width:260px;margin:0 auto}
.toolbar{display:flex;gap:5px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
.toolbar .sep{width:1px;height:18px;background:var(--border)}
.search-box{display:flex;gap:3px;align-items:center}
.search-box input{width:110px;font-size:.72rem;padding:4px 7px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px}
.stat{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:8px;text-align:center}
.stat-val{font-size:1.15rem;font-weight:700;color:var(--accent)}
.stat-val.warn{color:var(--warn)}
.stat-label{font-size:.6rem;color:var(--dim);text-transform:uppercase;margin-top:1px}
.kbd{font-family:var(--mono);font-size:.55rem;background:var(--bg4);color:var(--dim);padding:1px 4px;border-radius:3px;border:1px solid var(--border)}
/* Filter bar */
.filters{display:flex;gap:4px;font-size:.7rem}
.fil{padding:3px 8px;border-radius:4px;cursor:pointer;background:var(--bg4);color:var(--dim);border:1px solid transparent}
.fil.on{border-color:var(--accent);color:var(--accent)}
.fil:hover{color:var(--text)}
/* Dictionary panel */
.dict-row{display:flex;gap:4px;align-items:center;margin-bottom:4px}
.dict-row input{flex:1;padding:4px 6px;font-size:.72rem}
.toast-c{position:fixed;bottom:14px;right:14px;z-index:999;display:flex;flex-direction:column;gap:5px}
.toast{padding:7px 12px;border-radius:7px;font-size:.78rem;font-weight:500;animation:si .3s ease;max-width:320px}
.toast-ok{background:rgba(0,229,160,.15);color:var(--accent);border:1px solid rgba(0,229,160,.3)}
.toast-err{background:rgba(255,68,102,.15);color:var(--danger);border:1px solid rgba(255,68,102,.3)}
@keyframes si{from{transform:translateX(80px);opacity:0}to{transform:translateX(0);opacity:1}}
@media(max-width:900px){.app{grid-template-columns:1fr}.side{border-right:none;border-bottom:1px solid var(--border)}}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
/* Modal */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);z-index:900;display:none;align-items:center;justify-content:center;padding:20px}
.modal-bg.open{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:14px;width:100%;max-width:720px;max-height:85vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.modal-head{display:flex;align-items:center;gap:10px;padding:16px 20px;border-bottom:1px solid var(--border)}
.modal-head h2{font-size:1rem;font-weight:700;flex:1}
.modal-close{background:var(--bg4);color:var(--dim);width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:1rem;cursor:pointer;border:1px solid var(--border);transition:all .15s}
.modal-close:hover{color:var(--text);border-color:var(--accent)}
.modal-body{overflow-y:auto;padding:20px;font-size:.82rem;line-height:1.7}
.modal-body h3{font-size:.88rem;font-weight:700;color:var(--accent);margin:16px 0 6px;display:flex;align-items:center;gap:6px}
.modal-body h3:first-child{margin-top:0}
.modal-body p{color:var(--text);margin-bottom:8px}
.modal-body .hd{color:var(--dim);font-size:.72rem;margin-bottom:2px}
.htable{width:100%;border-collapse:collapse;margin:6px 0 12px;font-size:.78rem}
.htable th{text-align:left;padding:5px 8px;background:var(--bg4);color:var(--dim);font-weight:600;font-size:.68rem;text-transform:uppercase;letter-spacing:.03em;border:1px solid var(--border)}
.htable td{padding:5px 8px;border:1px solid var(--border);vertical-align:top}
.htable tr:hover td{background:rgba(0,229,160,.02)}
.htable code{font-family:var(--mono);font-size:.72rem;background:var(--bg);padding:1px 4px;border-radius:3px;color:var(--accent2)}
.htag{display:inline-block;padding:1px 6px;border-radius:3px;font-size:.62rem;font-weight:600;margin-left:4px}
.htag-api{background:rgba(0,184,255,.12);color:var(--accent2)}
.htag-local{background:rgba(168,85,247,.12);color:var(--purple)}
.htag-both{background:rgba(0,229,160,.12);color:var(--accent)}
.help-btn{background:var(--bg4);color:var(--dim);border:1px solid var(--border);width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.85rem;cursor:pointer;transition:all .15s;padding:0;flex-shrink:0}
.help-btn:hover{color:var(--accent);border-color:var(--accent)}
/* Chat Panel */
.chat-btn{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0c0e14;border:none;width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.85rem;cursor:pointer;transition:all .15s;padding:0;flex-shrink:0;font-weight:700}
.chat-btn:hover{filter:brightness(1.15);transform:translateY(-1px)}
.chat-btn.disabled{opacity:.3;cursor:not-allowed;filter:none;transform:none}
.chat-panel{position:fixed;top:0;right:0;width:400px;max-width:90vw;height:100vh;background:var(--bg2);border-left:1px solid var(--border);z-index:800;display:flex;flex-direction:column;transform:translateX(100%);transition:transform .25s ease;box-shadow:-4px 0 20px rgba(0,0,0,.3)}
.chat-panel.open{transform:translateX(0)}
.chat-head{display:flex;align-items:center;gap:8px;padding:12px 14px;border-bottom:1px solid var(--border);flex-shrink:0}
.chat-head h3{font-size:.88rem;font-weight:700;flex:1;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
.chat-head .ai-model{font-family:var(--mono);font-size:.55rem;background:var(--bg4);color:var(--dim);padding:2px 6px;border-radius:3px}
.chat-close{background:var(--bg4);color:var(--dim);border:1px solid var(--border);width:24px;height:24px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:.8rem;cursor:pointer;padding:0}
.chat-close:hover{color:var(--text);border-color:var(--accent)}
.chat-cmds{display:flex;gap:3px;padding:8px 14px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap}
.chat-cmd{padding:3px 8px;border-radius:4px;font-size:.62rem;cursor:pointer;background:var(--bg4);color:var(--dim);border:1px solid var(--border);transition:all .15s;font-weight:500}
.chat-cmd:hover{border-color:var(--accent);color:var(--accent)}
.chat-cmd:disabled{opacity:.4;cursor:not-allowed}
.chat-msgs{flex:1;overflow-y:auto;padding:12px 14px;display:flex;flex-direction:column;gap:8px}
.chat-msg{max-width:92%;padding:8px 11px;border-radius:8px;font-size:.78rem;line-height:1.55;word-wrap:break-word;overflow-wrap:break-word}
.chat-msg.user{background:var(--bg4);align-self:flex-end;border:1px solid var(--border);border-bottom-right-radius:2px}
.chat-msg.model{background:var(--bg3);align-self:flex-start;border:1px solid var(--border);border-bottom-left-radius:2px}
.chat-msg.model code{font-family:var(--mono);font-size:.72rem;background:var(--bg);padding:1px 4px;border-radius:3px}
.chat-msg.model pre{background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:6px 8px;margin:4px 0;overflow-x:auto;font-family:var(--mono);font-size:.68rem}
.chat-msg.model p{margin:3px 0}
.chat-msg.model strong{color:var(--accent)}
.chat-msg.model ul,.chat-msg.model ol{padding-left:16px;margin:3px 0}
.chat-msg.model li{margin:1px 0}
.chat-typing{align-self:flex-start;color:var(--dim);font-size:.72rem;padding:4px 8px}
.chat-typing::after{content:'...';animation:dots 1.2s steps(3,end) infinite}
@keyframes dots{0%{content:'.'}33%{content:'..'}66%{content:'...'}}
.chat-input{display:flex;gap:4px;padding:10px 14px;border-top:1px solid var(--border);flex-shrink:0;background:var(--bg3)}
.chat-input input{flex:1;padding:8px 10px;font-size:.8rem;border-radius:7px}
.chat-input button{padding:8px 14px;border-radius:7px;font-weight:600}
.chat-no-ai{padding:20px;text-align:center;color:var(--dim);font-size:.78rem}
.chat-no-ai code{font-family:var(--mono);font-size:.7rem;background:var(--bg);padding:1px 4px;border-radius:3px;display:inline-block;margin-top:4px}
/* Ref correction diff */
.ref-diff{padding:8px 10px;border-radius:8px;font-size:.72rem;background:var(--bg3);border:1px solid var(--border);align-self:stretch}
.ref-diff-head{font-weight:700;margin-bottom:6px;color:var(--accent)}
.ref-diff-summary{font-size:.65rem;color:var(--dim);margin-bottom:8px}
.ref-diff-item{padding:4px 6px;margin:3px 0;border-radius:4px;border-left:3px solid var(--accent2);background:var(--bg)}
.ref-diff-item .seg-num{font-family:var(--mono);font-size:.6rem;color:var(--dim);margin-bottom:2px}
.ref-diff-item .old-text{color:var(--warn);text-decoration:line-through;opacity:.7;font-size:.68rem}
.ref-diff-item .new-text{color:var(--accent);font-weight:500;font-size:.7rem}
.ref-diff-actions{display:flex;gap:6px;margin-top:8px;justify-content:flex-end}
.ref-diff-actions button{padding:5px 14px;font-size:.72rem;border-radius:6px;font-weight:600}
/* Merge diff */
.merge-diff{padding:8px 10px;border-radius:8px;font-size:.72rem;background:var(--bg3);border:1px solid var(--border);align-self:stretch}
.merge-diff-head{font-weight:700;margin-bottom:6px;color:var(--accent2)}
.merge-diff-summary{font-size:.65rem;color:var(--dim);margin-bottom:8px}
.merge-item{padding:5px 6px;margin:3px 0;border-radius:4px;border-left:3px solid var(--accent2);background:var(--bg)}
.merge-item.skip{border-left-color:var(--warn);opacity:.7}
.merge-item .m-head{display:flex;gap:6px;align-items:center;font-size:.62rem;color:var(--dim);margin-bottom:2px;font-family:var(--mono)}
.merge-item .m-head .m-badge{padding:1px 5px;border-radius:3px;font-size:.55rem;font-weight:700;text-transform:uppercase}
.merge-item .m-badge.ok{background:var(--accent2);color:var(--bg)}
.merge-item .m-badge.no{background:var(--warn);color:var(--bg)}
.merge-item .m-texts{font-size:.68rem}
.merge-item .m-old{color:var(--dim);opacity:.7}
.merge-item .m-arrow{color:var(--accent2);font-weight:600}
.merge-item .m-new{color:var(--fg);font-weight:500}
.merge-item .m-reason{font-size:.58rem;color:var(--warn);margin-top:2px;font-style:italic}
.merge-actions{display:flex;gap:6px;margin-top:8px;justify-content:flex-end}
.merge-actions button{padding:5px 14px;font-size:.72rem;border-radius:6px;font-weight:600}
.ref-upload-bar{display:flex;gap:4px;padding:6px 14px;border-bottom:1px solid var(--border);flex-shrink:0;align-items:center;background:var(--bg3)}
.ref-upload-bar label{font-size:.6rem;color:var(--dim);cursor:pointer;display:flex;align-items:center;gap:4px;padding:3px 8px;border:1px dashed var(--border);border-radius:4px;transition:all .15s}
.ref-upload-bar label:hover{border-color:var(--accent);color:var(--accent)}
.ref-upload-bar .ref-filename{font-family:var(--mono);font-size:.58rem;color:var(--accent);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
/* Library Modal */
.lib-btn{background:var(--bg4);color:var(--dim);border:1px solid var(--border);width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.85rem;cursor:pointer;transition:all .15s;padding:0;flex-shrink:0}
.lib-btn:hover{color:var(--accent);border-color:var(--accent)}
.lib-list{max-height:55vh;overflow-y:auto;display:flex;flex-direction:column;gap:4px}
.lib-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg3);cursor:pointer;transition:all .12s;font-size:.75rem}
.lib-item:hover{border-color:var(--accent);background:var(--bg4)}
.lib-item .li-title{flex:1;font-weight:600;font-size:.8rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lib-item .li-meta{color:var(--dim);font-family:var(--mono);font-size:.6rem;display:flex;gap:6px;flex-shrink:0}
.lib-item .li-badge{font-size:.55rem;padding:1px 5px;border-radius:3px;font-weight:600}
.lib-item .li-badge.rev{background:#f5a62333;color:#f5a623}
.lib-item .li-del{background:none;border:none;color:var(--dim);cursor:pointer;font-size:.8rem;padding:2px 4px;border-radius:3px;flex-shrink:0}
.lib-item .li-del:hover{color:#e74c3c;background:#e74c3c22}
.lib-search{margin-bottom:8px}
.lib-empty{text-align:center;color:var(--dim);padding:30px 0;font-size:.8rem}
/* Video Render */
.vr-zone{border:1px dashed var(--border);border-radius:7px;padding:10px;margin-top:6px;display:none}
.vr-zone.show{display:block}
.vr-row{display:flex;gap:5px;margin-bottom:4px;align-items:center}
.vr-row label{font-size:.65rem;color:var(--dim);min-width:40px}
.vr-row select,.vr-row input[type=file]{flex:1;font-size:.72rem}
/* Tag Modal */
.tag-form{display:flex;flex-direction:column;gap:6px}
.tag-row{display:flex;align-items:center;gap:8px}
.tag-row label{min-width:60px;font-size:.7rem;color:var(--dim);text-align:right}
.tag-row input,.tag-row select{flex:1;font-size:.75rem;padding:5px 8px;border-radius:5px;background:var(--bg3);border:1px solid var(--border);color:var(--fg)}
.tag-row input:disabled{opacity:.5;cursor:not-allowed}
.tag-ro{font-size:.6rem;color:var(--dim);text-align:right;padding-right:4px}
.tag-actions{display:flex;gap:6px;justify-content:flex-end;margin-top:8px;padding-top:8px;border-top:1px solid var(--border)}
/* Quick Actions */
.qa-btn{display:flex;flex-direction:column;align-items:flex-start;gap:2px;padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:var(--bg3);color:var(--fg);cursor:pointer;transition:all .15s;text-align:left}
.qa-btn:hover{border-color:var(--accent);background:var(--bg4);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,229,160,.08)}
.qa-btn:active{transform:translateY(0)}
.qa-icon{font-size:1.1rem}
.qa-label{font-weight:600;font-size:.75rem}
.qa-desc{font-size:.6rem;color:var(--dim);line-height:1.2}
/* Rhyme scheme */
.rhyme-grid{display:flex;flex-wrap:wrap;gap:3px;font-family:var(--mono);font-size:.65rem}
.rhyme-line{display:flex;align-items:center;gap:4px;padding:3px 6px;border-radius:4px;border:1px solid var(--border);background:var(--bg3);min-width:0}
.rhyme-label{font-weight:700;width:16px;text-align:center;flex-shrink:0}
.rhyme-text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px}
.rhyme-end{font-weight:600;margin-left:auto;padding-left:4px;flex-shrink:0}
.rhyme-pair{display:inline-flex;align-items:center;gap:4px;padding:2px 6px;border-radius:10px;font-size:.6rem;font-family:var(--mono);border:1px solid}
.rhyme-pair.end{border-color:var(--accent);color:var(--accent);background:rgba(0,229,160,.06)}
/* ‚îÄ‚îÄ Text Editor Modal ‚îÄ‚îÄ */
.sube-bg{position:fixed;inset:0;background:rgba(0,0,0,.78);backdrop-filter:blur(6px);z-index:950;display:none;align-items:center;justify-content:center;padding:12px}
.sube-bg.open{display:flex}
.sube{background:var(--bg2);border:1px solid var(--border);border-radius:14px;width:100%;max-width:900px;height:85vh;display:flex;flex-direction:column;box-shadow:0 24px 80px rgba(0,0,0,.6)}
.sube-head{display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
.sube-head h2{font-size:1rem;font-weight:700;flex:1;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
.sube-head .sube-info{font-family:var(--mono);font-size:.6rem;color:var(--dim);background:var(--bg4);padding:2px 6px;border-radius:4px}
.sube-body{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:0}
.sube-hint{font-size:.6rem;color:var(--dim);padding:6px 16px;background:var(--bg3);border-bottom:1px solid var(--border);flex-shrink:0}
.sube-ta{flex:1;width:100%;resize:none;font-family:var(--mono);font-size:.82rem;line-height:1.6;padding:12px 16px;border:none;outline:none;background:var(--bg);color:var(--text);tab-size:2}
.sube-ta:focus{background:var(--bg)}
.sube-foot{display:flex;align-items:center;gap:6px;padding:8px 16px;border-top:1px solid var(--border);flex-shrink:0;background:var(--bg3)}
.sube-foot .sube-stats{font-size:.65rem;color:var(--dim);flex:1;font-family:var(--mono)}
.sube-foot button{padding:5px 12px;font-size:.75rem}
.sube-dirty{color:var(--warn) !important}
.rhyme-pair.internal{border-color:#b8a0ff;color:#b8a0ff;background:rgba(184,160,255,.06)}
.rhyme-pair.multi{border-color:#ffd700;color:#ffd700;background:rgba(255,215,0,.06)}
/* Gap scanner */
.gap-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:5px;font-size:.7rem;cursor:pointer;transition:background .1s}
.gap-item:hover{background:var(--bg4)}
.gap-item.gap{border-left:3px solid #f5a623}
.gap-item.overlap{border-left:3px solid #e74c3c}
.gap-badge{font-size:.6rem;padding:1px 6px;border-radius:3px;font-weight:600;font-family:var(--mono)}
.gap-badge.warn{background:#f5a62333;color:#f5a623}
.gap-badge.err{background:#e74c3c33;color:#e74c3c}
</style>
</head>
<body>
<div class="app">
<header class="hdr">
  <h1>‚ô™ Karaoke Sub Tool</h1><span class="v">v3.2</span>
  <div class="theme-sw">
    <button class="tsw-dark on" onclick="setTheme('dark')" title="Dark"></button>
    <button class="tsw-neon" onclick="setTheme('neon')" title="Neon"></button>
    <button class="tsw-light" onclick="setTheme('light')" title="Light"></button>
    <button class="tsw-warm" onclick="setTheme('warm')" title="Warm"></button>
  </div>
  <div style="display:flex;gap:3px;margin-left:6px" id="bb"></div>
  <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
    <button class="btn-s btn-sm" onclick="clearAll()" title="Alles zur√ºcksetzen" style="color:var(--danger)">üóëÔ∏è Clear</button>
    <button class="btn-s btn-sm" onclick="toggleTapToTime()" title="Tap-to-Time Modus (T)">üé§ Tap</button>
    <button class="btn-s btn-sm" onclick="toggleFSKaraoke()" title="Fullscreen Karaoke (F)">üñ•Ô∏è</button>
    <button class="lib-btn" onclick="toggleLibrary()" title="Library">üìö</button>
    <a id="navEditor" href="/editor" class="btn-s btn-sm" style="text-decoration:none;display:inline-flex;align-items:center;gap:3px" title="Video Editor">üé¨ Editor</a>
    <a id="navFiles" href="/files" class="btn-s btn-sm" style="text-decoration:none;display:inline-flex;align-items:center;gap:3px" title="File Explorer">üìÅ Files</a>
    <button class="chat-btn disabled" id="chatBtn" onclick="toggleChat()" title="AI Chat">ü§ñ</button>
    <button class="help-btn" onclick="toggleHelp()" title="Hilfe (F1)">?</button>
    <span style="font-size:.68rem;color:var(--dim)" id="hTxt"></span>
    <div class="dot" id="hDot"></div>
  </div>
</header>
<div id="projBanner" style="display:none;padding:6px 16px;background:var(--bg3);border-bottom:1px solid var(--border);font-size:.75rem;color:var(--dim);align-items:center;gap:8px">
  <span style="color:var(--accent)">üìå</span>
  <span>Projekt ge√∂ffnet: <b id="projBannerName" style="color:var(--fg)"></b></span>
  <a id="projBannerEditor" href="/editor" class="btn-s btn-sm" style="text-decoration:none;font-size:.65rem;padding:2px 8px;margin-left:auto">üé¨ Im Editor √∂ffnen</a>
  <button class="btn-s btn-sm" style="font-size:.65rem;padding:2px 8px;color:var(--dim)" onclick="exitProjectMode()">‚úï Projektmodus verlassen</button>
</div>
<aside class="side">
  <div class="dz" id="dz" onclick="document.getElementById('fi').click()" title="Audio-Datei(en) hier ablegen oder klicken ‚Äî unterst√ºtzt MP3, WAV, FLAC, M4A, OGG, AAC. Auch SRT/VTT/LRC zum Reimport.">
    <span class="ic">üìÇ</span><b>Audio hochladen</b>
    <div class="hn">mp3 wav flac m4a ogg ‚Ä¢ Drag & Drop</div>
    <input type="file" id="fi" accept=".mp3,.wav,.flac,.m4a,.aac,.ogg,.srt,.vtt,.lrc" multiple hidden>
  </div>
  <div style="display:flex;align-items:center;gap:6px;padding:2px 0">
    <div style="flex:1;height:1px;background:var(--border)"></div>
    <span style="font-size:.58rem;color:var(--dim)">optional</span>
    <div style="flex:1;height:1px;background:var(--border)"></div>
  </div>
  <div style="display:flex;align-items:center;gap:6px;padding:4px 8px;background:var(--bg3);border:1px dashed var(--border);border-radius:6px;cursor:pointer;transition:all .15s" onclick="document.getElementById('lyFi').click()" onmouseover="this.style.borderColor='var(--purple)'" onmouseout="this.style.borderColor='var(--border)'" title="Lyrics-Textdatei hochladen ‚Äî Zeilenstruktur wird f√ºr Untertitel √ºbernommen, W√∂rter werden an ASR-Timestamps aligned">
    <span style="font-size:.9rem">üìù</span>
    <div style="flex:1;min-width:0">
      <div style="font-size:.7rem;font-weight:600" id="lyLabel">Lyrics (.txt/.lrc) hochladen</div>
      <div style="font-size:.55rem;color:var(--dim)" id="lyHint">Zeilenstruktur wird f√ºr SRT/ASS √ºbernommen</div>
    </div>
    <button style="font-size:.55rem;padding:2px 5px;display:none;background:var(--bg4);color:var(--dim);border:1px solid var(--border);border-radius:3px" id="lyDel" onclick="event.stopPropagation();clearLyrics()" title="Hochgeladene Lyrics entfernen">‚úï</button>
    <input type="file" id="lyFi" accept=".txt,.lrc" hidden>
  </div>
  <div id="lyOpts" style="display:none;padding:4px 8px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;margin-top:-2px;font-size:.65rem">
    <div style="display:flex;gap:6px;align-items:center;margin-bottom:3px">
      <label style="color:var(--dim)">Template</label>
      <select id="sLTM" style="flex:1;font-size:.65rem"><option value="lyrics_source_of_truth" title="Lyrics-Text wird 1:1 √ºbernommen, ASR-Timestamps zugeordnet">Source of Truth</option><option value="layout_only_reflow" title="ASR-Text beibehalten, nur Zeilenumbr√ºche aus Lyrics √ºbernehmen">Layout Only</option><option value="hybrid_mark_differences" title="Lyrics-Text verwenden, Abweichungen zum ASR markieren">Hybrid</option></select>
    </div>
    <div style="display:flex;gap:6px;align-items:center">
      <label style="color:var(--dim)">Match</label>
      <select id="sMatch" style="flex:1;font-size:.65rem"><option value="lenient" title="Tolerantes Matching ‚Äî leichte Schreib-Unterschiede werden akzeptiert">Lenient</option><option value="strict" title="Striktes Matching ‚Äî W√∂rter m√ºssen exakt √ºbereinstimmen">Strict</option></select>
      <label class="tg" style="font-size:.6rem" title="Leere Zeilen in Lyrics als Segment-Trenner beibehalten"><input type="checkbox" id="sEL"> Empty Lines</label>
    </div>
  </div>
  <button class="btn-s" id="tagBtn" style="display:none;width:100%;margin-top:3px;font-size:.65rem" onclick="openTagModal()" title="ID3/MP4/Vorbis-Tags der Audio-Datei lesen und bearbeiten">üè∑Ô∏è Tags bearbeiten</button>
  <div class="card">
    <div class="card-h">‚öô Settings</div>
    <div class="sg">
      <div title="Transkriptions-Engine: Voxtral (Mistral AI), OpenAI Whisper, Local Whisper (offline), WhisperX (beste Word-Timestamps)"><label>Backend</label><select id="sB">
        <option value="voxtral" title="Mistral AI Voxtral ‚Äî schnell, gute Qualit√§t, Cloud">Voxtral</option><option value="openai_whisper" title="OpenAI Whisper API ‚Äî zuverl√§ssig, Cloud">OpenAI</option>
        <option value="local_whisper" title="faster-whisper lokal ‚Äî kein API-Key, GPU optional">Local Whisper</option><option value="whisperx" title="WhisperX ‚Äî pr√§ziseste Word-Timestamps, Forced Alignment">WhisperX</option>
      </select></div>
      <div title="Sprache des Audios. Auto erkennt automatisch."><label>Sprache</label><select id="sL">
        <option value="auto">Auto</option><option value="de">DE</option><option value="en">EN</option>
        <option value="fr">FR</option><option value="es">ES</option><option value="ja">JA</option>
      </select></div>
      <div title="Karaoke-Modus: Fill f√ºllt W√∂rter progressiv, Highlight markiert sofort, Outline-Wipe wischt den Umriss"><label>Mode</label><select id="sK"><option value="kf" title="Progressives F√ºllen ‚Äî Wort wird von links nach rechts eingef√§rbt">Fill (progressiv)</option><option value="k" title="Sofort-Highlight ‚Äî ganzes Wort wird auf einmal markiert">Highlight (sofort)</option><option value="ko" title="Outline-Wipe ‚Äî Umriss wird progressiv sichtbar">Outline-Wipe</option></select></div>
      <div title="ASS-Preset: Schriftart, Gr√∂√üe, Aufl√∂sung, Farben. Beeinflusst das Aussehen der Untertitel."><label>Preset</label><select id="sP"><option value="classic" title="Klassisch ‚Äî wei√ü auf schwarz, gut lesbar">Classic</option><option value="neon" title="Neon ‚Äî leuchtende Farben, dunkler Hintergrund">Neon</option><option value="high_contrast" title="Hoher Kontrast ‚Äî maximale Lesbarkeit">Hi-Con</option><option value="landscape_1080p" title="Landscape 1920√ó1080 ‚Äî YouTube Standard">Land</option><option value="portrait_1080x1920" title="Portrait 1080√ó1920 ‚Äî TikTok/Reels/Shorts">Port</option><option value="mobile_safe" title="Mobilsicher ‚Äî gro√üe Schrift, wenig Text">Mobile</option></select></div>
      <div class="f" title="CPS = Characters Per Second (Lesegeschwindigkeit). Max Chars = maximale Zeichen pro Zeile. Segmente werden automatisch gesplittet wenn √ºberschritten.">
        <label>CPS / Max Chars</label>
        <div style="display:flex;gap:5px;align-items:center"><input type="number" id="sC" value="18" min="5" max="40" style="width:40%" title="CPS-Limit: 12‚Äì18 f√ºr Untertitel, 20‚Äì25 f√ºr Rap/Karaoke"><input type="number" id="sMC" value="42" min="20" max="80" style="width:40%" title="Max Zeichen pro Zeile. Bei 2 Zeilen: max 84 Zeichen gesamt."><button type="button" class="btn-s" id="btnAutoBpm" onclick="autoBpmParams()" title="CPS und Max Chars automatisch aus BPM berechnen ‚Äî erkennt BPM aus Audio oder manuelle Eingabe" style="width:20%;font-size:.6rem;padding:2px 4px">‚ö°BPM</button></div>
      </div>
      <label class="tg f" title="Voice Activity Detection ‚Äî erkennt Sprachpausen und schneidet Stille heraus. Verbessert Transkription bei langen Pausen/Intros."><input type="checkbox" id="sVAD" checked> VAD</label>
      <label class="tg f" title="Lautst√§rke-Normalisierung auf -16 LUFS. Gleicht leise/laute Aufnahmen aus f√ºr bessere Erkennung."><input type="checkbox" id="sN" checked> Normalize</label>
      <label class="tg f" title="ASS-Untertitel mit Karaoke-Tags erzeugen. Enth√§lt Wort-f√ºr-Wort-Highlighting."><input type="checkbox" id="sA" checked> ASS</label>
      <label class="tg f" title="Zus√§tzlich WebVTT-Format exportieren ‚Äî kompatibel mit HTML5 Video und Web-Playern."><input type="checkbox" id="sVTT"> +VTT</label>
      <label class="tg f" title="Zus√§tzlich Enhanced LRC-Format ‚Äî f√ºr Karaoke-Apps und Musik-Player mit Lyrics-Anzeige."><input type="checkbox" id="sLRC"> +LRC</label>
      <label class="tg f" title="Zus√§tzlich reinen Text exportieren ‚Äî ohne Zeitmarken, nur der transkribierte Text."><input type="checkbox" id="sTXT"> +TXT</label>
      <label class="tg f" title="Vocal Isolation via Demucs ‚Äî trennt Gesang von Instrumenten vor der Transkription. Hilft bei lauter Musik."><input type="checkbox" id="sVO"> Vocal Iso</label>
      <button type="button" class="btn-s" onclick="openDemucsModal()" title="Eigenst√§ndige Stem-Separation: Vocals, Drums, Bass, Other als separate Dateien extrahieren" style="width:100%;margin-top:2px;font-size:.6rem;padding:2px 4px">üéµ Demucs Separation</button>
      <label class="tg f" title="Beat-Grid Snap ‚Äî erkennt BPM und richtet Segment-/Wort-Grenzen am Beat aus. F√ºr Rap/Songs mit klarem Rhythmus."><input type="checkbox" id="sBT"> BPM Snap</label>
      <label class="tg f" title="AI-Korrektur ‚Äî nutzt ein LLM um Lyrics zu korrigieren (Rechtschreibung, fehlende W√∂rter, Interpunktion)."><input type="checkbox" id="sAI"> AI Correct</label>
    </div>
    <button class="btn-s" onclick="document.getElementById('vrZone').classList.toggle('show')" style="width:100%;margin-top:4px;font-size:.65rem" title="Karaoke-Video mit Hintergrund und eingebrannten Untertiteln rendern">üé¨ Video Render ‚ñæ</button>
    <div class="vr-zone" id="vrZone">
      <div class="vr-row" title="Hintergrundbild oder -video f√ºr das gerenderte Karaoke-Video"><label>BG</label><input type="file" id="vrBg" accept="image/*,video/*"></div>
      <div class="vr-row" title="Audio-Datei die im Video verwendet wird (optional ‚Äî sonst wird das Job-Audio genommen)"><label>Audio</label><input type="file" id="vrAudio" accept="audio/*"></div>
      <div class="vr-row"><label title="Render-Qualit√§t: YouTube (1080p), Mobile (720p vertikal), Draft (schnell, niedrige Qualit√§t)">Preset</label><select id="vrPreset"><option value="youtube" title="1920√ó1080, hohe Qualit√§t">YouTube</option><option value="mobile" title="1080√ó1920, f√ºr TikTok/Reels">Mobile</option><option value="draft" title="Schnelle Vorschau, niedrige Qualit√§t">Draft</option></select>
      <label style="margin-left:4px" title="Vertikale Position der Untertitel im Video">Pos</label><select id="vrPos"><option value="bottom" title="Untertitel am unteren Rand">Bottom</option><option value="middle" title="Untertitel in der Mitte">Middle</option><option value="top" title="Untertitel am oberen Rand">Top</option></select></div>
      <button class="btn" onclick="startRender()" style="width:100%;margin-top:4px;font-size:.72rem" title="Rendert ein Video mit eingebrannten Karaoke-Untertiteln (ffmpeg)">üé¨ Render Video</button>
    </div>
    <div id="wxO" style="display:none;margin-top:6px"><div class="sg">
      <div title="WhisperX Modellgr√∂√üe: large-v3 = beste Qualit√§t, medium = schneller, small = am schnellsten"><label>Model</label><select id="sWXM"><option value="large-v3" title="Gr√∂√ütes Modell ‚Äî beste Erkennung, braucht ~6 GB VRAM">large-v3</option><option value="medium" title="Mittleres Modell ‚Äî guter Kompromiss aus Qualit√§t und Geschwindigkeit">medium</option><option value="small" title="Kleinstes Modell ‚Äî schnell, weniger genau">small</option></select></div>
      <div title="Rechengenauigkeit: fp16 = schneller auf GPU, int8 = weniger VRAM-Verbrauch"><label>Compute</label><select id="sWXC"><option value="float16" title="Float16 ‚Äî Standard, schnell auf GPU">fp16</option><option value="int8" title="Int8-Quantisierung ‚Äî weniger VRAM, etwas langsamer">int8</option></select></div>
    </div></div>
  </div>
  <button class="btn" style="width:100%;padding:9px" id="btnGo" disabled title="Transkription starten ‚Äî Audio hochladen und mit gew√§hltem Backend verarbeiten">‚ñ∂ Start</button>
  <div style="flex:1;overflow-y:auto">
    <div class="card-h" style="padding:0 0 5px">üìã Jobs</div>
    <div id="jl"></div>
  </div>
  <div style="font-size:.55rem;color:var(--dim);text-align:center;line-height:1.6">
    <span class="kbd">Space</span> Play <span class="kbd">S</span> Split <span class="kbd">T</span> Tap
    <span class="kbd">F</span> Fullscreen <span class="kbd">Ctrl+Z/Y</span> Undo
  </div>
</aside>
<main class="main" id="mc">
  <div class="empty" id="es"><span class="ic">üé§</span><p>Audio hochladen und transkribieren lassen.</p></div>
  <div id="jd" style="display:none">
    <!-- Status -->
    <div class="card" id="sc">
      <div class="card-h"><span id="dI">‚è≥</span> <span id="dF"></span><span style="margin-left:auto;font-size:.72rem;color:var(--dim)" id="dS"></span></div>
      <div class="pb"><div class="pf" id="dP" style="width:0%"></div></div>
      <div style="font-size:.72rem;color:var(--dim);margin-top:5px" id="dSt"></div>
    </div>
    <!-- Player -->
    <div class="player" id="playerSec" style="display:none">
      <div class="player-row">
        <button class="btn-s btn-sm" onclick="togglePlay()" title="Play/Pause (Leertaste)">‚èØ</button>
        <button class="btn-s btn-sm" onclick="skipTo(-5)" title="5 Sekunden zur√ºckspulen">-5s</button>
        <button class="btn-s btn-sm" onclick="skipTo(5)" title="5 Sekunden vorspulen">+5s</button>
        <select id="pbSpeed" onchange="setSpeed(this.value)" style="width:55px;padding:3px;font-size:.65rem" title="Wiedergabegeschwindigkeit">
          <option value="0.5">0.5x</option><option value="0.75">0.75x</option>
          <option value="1" selected>1x</option><option value="1.25">1.25x</option>
          <option value="1.5">1.5x</option><option value="2">2x</option>
        </select>
        <input type="range" id="vol" min="0" max="1" step="0.05" value="0.8" style="width:60px" oninput="au.volume=this.value" title="Lautst√§rke">
        <span class="player-time" id="pTime">0:00 / 0:00</span>
        <button class="btn-s btn-sm" id="loopBtn" onclick="toggleLoop()" style="opacity:.4" title="A/B-Loop: Markierten Bereich endlos wiederholen (L)">üîÅ</button>
        <button class="btn-s btn-sm" onclick="clearABLoop()" id="abClear" style="display:none;opacity:.6" title="A/B Loop l√∂schen">‚úïAB</button>
        <button class="btn-s btn-sm" onclick="splitAtPlayhead()" title="Segment an der aktuellen Playhead-Position teilen (S)">‚úÇÔ∏è</button>
      </div>
      <div class="waveform" id="wfC" onclick="seekWF(event)" onmousedown="loopDragStart(event)" onmousemove="loopDragMove(event)" onmouseup="loopDragEnd(event)" title="Klicken zum Spulen ¬∑ Ziehen f√ºr A/B-Loop">
        <canvas id="wfCv"></canvas>
        <div class="wf-cursor" id="wfCur" style="left:0"></div>
        <div class="loop-region" id="loopRegion" style="display:none"></div>
        <span class="loop-label" id="loopLabelA" style="display:none">A</span>
        <span class="loop-label" id="loopLabelB" style="display:none">B</span>
      </div>
      <div class="spectrum" id="specC"><canvas id="specCv"></canvas></div>
      <div class="minimap" id="mm" onclick="seekMM(event)" title="Klicken zum Spulen (Minimap)"><div class="mm-cur" id="mmCur"></div></div>
      <div class="offset-row" id="offsetRow">
        <span class="offset-lbl" title="Subtitle-Offset: Verschiebt die Karaoke/Highlight-Anzeige relativ zum Audio. Negativ = Untertitel fr√ºher, Positiv = Untertitel sp√§ter">‚è± Offset:</span>
        <div class="offset-btns">
          <button class="offset-btn" onclick="adjOffset(-50)" title="Untertitel 50ms fr√ºher">‚àí50</button>
          <button class="offset-btn" onclick="adjOffset(-10)" title="Untertitel 10ms fr√ºher">‚àí10</button>
        </div>
        <span class="offset-val zero" id="offsetVal" title="Aktueller Preview-Offset in Millisekunden (wird beim Anwenden auf die Segmente geschrieben)">0 ms</span>
        <div class="offset-btns">
          <button class="offset-btn" onclick="adjOffset(10)" title="Untertitel 10ms sp√§ter">+10</button>
          <button class="offset-btn" onclick="adjOffset(50)" title="Untertitel 50ms sp√§ter">+50</button>
        </div>
        <button class="offset-btn" onclick="resetOffset()" title="Offset zur√ºcksetzen (Preview)">‚Ü∫</button>
        <button class="offset-apply" onclick="applyOffset()" title="Offset permanent auf alle Segmente anwenden (Time-Shift)">Anwenden</button>
      </div>
      <div class="karaoke-live" id="kLive" ondblclick="editKaraokeLine()"></div>
    </div>
    <!-- Downloads -->
    <div id="dlSec" style="display:none">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
        <span class="card-h" style="margin:0">üíæ Downloads</span>
        <a class="dl" id="zipDl" style="margin-left:auto" title="Alle Job-Dateien als ZIP herunterladen"><span class="x">ZIP</span>Alle</a>
      </div>
      <div class="dls" id="dlBtns"></div>
    </div>
    <!-- Editor -->
    <div id="edSec" style="display:none">
      <div class="tabs">
        <div class="tab on" data-tab="seg" onclick="stab('seg')" title="Segment-Liste: Bearbeiten, Timing, Text, Split, Merge">Segments</div>
        <div class="tab" data-tab="stats" onclick="stab('stats')" title="Statistiken: CPS, W√∂rter, Confidence, Gaps, Overlaps">Stats</div>
        <div class="tab" data-tab="rhyme" onclick="stab('rhyme')" title="Reimschema-Analyse f√ºr DE/EN Lyrics">Rhyme</div>
        <div class="tab" data-tab="quick" onclick="stab('quick')" title="Schnellzugriff: Export-Presets, CPS Fix, Heatmap, Gap Filler">‚ö° Actions</div>
        <div class="tab" data-tab="dict" onclick="stab('dict')" title="Eigenes W√∂rterbuch: Falsche‚ÜíKorrekte W√∂rter definieren">Dictionary</div>
        <div class="tab" data-tab="rep" onclick="stab('rep')" title="Qualit√§ts-Report: Confidence-Scores pro Segment">Report</div>
      </div>
      <!-- Segments Tab -->
      <div id="tSeg" style="margin-top:8px">
        <div class="toolbar">
          <span style="font-size:.75rem;color:var(--dim)" id="segCnt"></span>
          <div class="sep"></div>
          <div class="filters" id="filBar">
            <div class="fil on" data-f="all" onclick="setFil('all')" title="Alle Segmente anzeigen">Alle</div>
            <div class="fil" data-f="low" onclick="setFil('low')" title="Nur Segmente mit Confidence < 80% (unsichere Erkennung)">‚ö† Low</div>
            <div class="fil" data-f="pinned" onclick="setFil('pinned')" title="Nur manuell angepinnte Segmente">üìå Pinned</div>
            <div class="fil" data-f="overlap" onclick="setFil('overlap')" title="Nur Segmente mit Zeit√ºberlappungen oder negativen Gaps">üî¥ Overlap</div>
          </div>
          <div class="sep"></div>
          <div class="search-box">
            <input type="text" id="srchIn" placeholder="Suchen..." title="Suchbegriff in Segmenten">
            <input type="text" id="replIn" placeholder="Ersetzen..." title="Ersetzungstext">
            <button class="btn-s btn-sm" onclick="doReplace()" title="Suchen & Ersetzen in allen Segmenten">‚áÑ</button>
          </div>
          <div class="sep"></div>
          <button class="btn-s btn-sm" onclick="doUndo()" title="Ctrl+Z">‚Ü©</button>
          <button class="btn-s btn-sm" onclick="doRedo()" title="Ctrl+Y">‚Ü™</button>
          <button class="btn-s btn-sm" onclick="tShift()" title="Alle Timestamps um X Millisekunden verschieben (positiv/negativ)">‚è± Shift</button>
          <button class="btn-s btn-sm" onclick="fixGaps()" title="L√ºcken zwischen Segmenten automatisch mit Mindestabstand (80ms) korrigieren">üîß Fix Gaps</button>
          <button class="btn-s btn-sm" onclick="applyDict()" title="Custom Dictionary auf alle Segmente anwenden (falsch‚Üíkorrekt)">üìñ Dict</button>
          <div style="margin-left:auto;display:flex;gap:3px">
            <button class="btn btn-sm" onclick="openSubEditor()" title="Subtitle-Editor √∂ffnen">üìù Editor</button>
            <button class="btn-s btn-sm" onclick="regenFmt()" title="ASS/VTT/LRC aus aktuellen Segmenten neu generieren">üîÑ Regen</button>
            <button class="btn-s btn-sm" onclick="copyC('srt')" title="SRT-Untertitel in die Zwischenablage kopieren">üìãSRT</button>
            <button class="btn-s btn-sm" onclick="copyC('ass')" title="ASS-Untertitel in die Zwischenablage kopieren">üìãASS</button>
            <button class="btn-s btn-sm" onclick="downloadJobZip()" title="Alle Job-Dateien (SRT, ASS, Audio, Report) als ZIP herunterladen">üì¶ ZIP</button>
            <button class="btn-s btn-sm" onclick="exportProject()" title="Projekt-Daten als JSON exportieren (Segments + Metadaten)">üíæ Export</button>
          </div>
        </div>
        <div class="segs" id="segList"></div>
      </div>
      <!-- Stats Tab -->
      <div id="tStats" style="display:none;margin-top:8px"><div class="stats-grid" id="statsGrid"></div></div>
      <!-- Rhyme Tab -->
      <div id="tRhyme" style="display:none;margin-top:8px">
        <div class="card">
          <div class="card-h" style="display:flex;align-items:center;gap:8px">
            üéµ Reimschema-Analyse
            <button class="btn-s btn-sm" onclick="analyzeRhyme()" style="margin-left:auto" title="Reimschema in den Lyrics erkennen (Paarreim, Kreuzreim, etc.)">Analysieren</button>
          </div>
          <div id="rhymeScheme" style="margin-top:8px"></div>
          <div id="rhymeStats" style="margin-top:8px"></div>
          <div id="rhymeMap" style="margin-top:8px;overflow-x:auto"></div>
        </div>
      </div>
      <!-- Quick Actions Bar -->
      <div id="tQuick" style="display:none;margin-top:8px">
        <div class="card">
          <div class="card-h">‚ö° Quick Actions</div>
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;margin-top:8px">
            <button class="qa-btn" onclick="doAutoFixCps()" title="Segmente die das CPS-Limit √ºberschreiten automatisch intelligent splitten">
              <span class="qa-icon">üèéÔ∏è</span>
              <span class="qa-label">Auto CPS Fix</span>
              <span class="qa-desc">Schnelle Segmente splitten</span>
            </button>
            <button class="qa-btn" onclick="doKaraokeHtml('dark')" title="Standalone HTML-Datei mit eingebautem Karaoke-Player (dunkles Theme)">
              <span class="qa-icon">üé§</span>
              <span class="qa-label">Karaoke HTML</span>
              <span class="qa-desc">Standalone Player (Dark)</span>
            </button>
            <button class="qa-btn" onclick="doKaraokeHtml('neon')" title="Standalone HTML-Datei mit eingebautem Karaoke-Player (Neon-Glow)">
              <span class="qa-icon">üíú</span>
              <span class="qa-label">Neon Karaoke</span>
              <span class="qa-desc">Standalone Player (Neon)</span>
            </button>
            <button class="qa-btn" onclick="doKaraokeHtml('cinema')" title="Standalone HTML-Datei mit eingebautem Karaoke-Player (Gold auf Schwarz)">
              <span class="qa-icon">üé¨</span>
              <span class="qa-label">Cinema Karaoke</span>
              <span class="qa-desc">Gold auf Schwarz</span>
            </button>
            <button class="qa-btn" onclick="applyPreset('youtube')" title="SRT exportieren, max 42 Zeichen/Zeile, CPS auf 20 ‚Äî optimiert f√ºr YouTube-Untertitel">
              <span class="qa-icon">‚ñ∂Ô∏è</span>
              <span class="qa-label">YouTube Export</span>
              <span class="qa-desc">SRT, max 42 chars, 20 CPS</span>
            </button>
            <button class="qa-btn" onclick="applyPreset('tiktok')" title="ASS bold zentriert, 1 Zeile ‚Äî optimiert f√ºr TikTok/Instagram Reels/YouTube Shorts">
              <span class="qa-icon">üì±</span>
              <span class="qa-label">TikTok/Reels</span>
              <span class="qa-desc">ASS bold center, 1 Zeile</span>
            </button>
            <button class="qa-btn" onclick="applyPreset('spotify')" title="Enhanced LRC mit Wort-Level-Tags ‚Äî kompatibel mit Spotify Synced Lyrics">
              <span class="qa-icon">üéß</span>
              <span class="qa-label">Spotify LRC</span>
              <span class="qa-desc">Synced Lyrics</span>
            </button>
            <button class="qa-btn" onclick="applyPreset('karaoke')" title="Alle Karaoke-Formate auf einmal: ASS + SRT + LRC + Standalone HTML">
              <span class="qa-icon">‚ú®</span>
              <span class="qa-label">Karaoke Full</span>
              <span class="qa-desc">ASS+SRT+LRC+HTML</span>
            </button>
            <button class="qa-btn" onclick="doGapScan()" title="Zeitl√ºcken > 500ms und √úberlappungen zwischen Segmenten finden und anzeigen">
              <span class="qa-icon">üîç</span>
              <span class="qa-label">Gap Scanner</span>
              <span class="qa-desc">L√ºcken &amp; Overlaps finden</span>
            </button>
            <button class="qa-btn" onclick="doSegHeatmap()" title="Visuelle Darstellung der Lesegeschwindigkeit √ºber die gesamte Timeline">
              <span class="qa-icon">üå°Ô∏è</span>
              <span class="qa-label">CPS Heatmap</span>
              <span class="qa-desc">Confidence + Speed Map</span>
            </button>
            <button class="qa-btn" onclick="doFillGaps()" title="Stille L√ºcken zwischen Segmenten mit ‚ô™-Platzhaltern auff√ºllen">
              <span class="qa-icon">üîó</span>
              <span class="qa-label">Gap Filler</span>
              <span class="qa-desc">L√ºcken mit ‚ô™ f√ºllen</span>
            </button>
            <button class="qa-btn" onclick="doRedistribute()" title="Segment-Timestamps gleichm√§√üig √ºber die Audiodauer neu verteilen">
              <span class="qa-icon">‚è±Ô∏è</span>
              <span class="qa-label">Timing Reset</span>
              <span class="qa-desc">Timestamps neu verteilen</span>
            </button>
            <button class="qa-btn" onclick="doTextStats()" title="Textstatistik: Type-Token-Ratio, Hapax, Silbenzahl, Flow-Score">
              <span class="qa-icon">üìä</span>
              <span class="qa-label">Text Analyse</span>
              <span class="qa-desc">Wortschatz, Flow, Silben</span>
            </button>
            <button class="qa-btn" onclick="doRemoveShort()" title="Extrem kurze Segmente l√∂schen (unter 2 Zeichen oder 0.3 Sekunden)">
              <span class="qa-icon">üßπ</span>
              <span class="qa-label">Kurze entfernen</span>
              <span class="qa-desc">&lt;2 Zeichen / &lt;0.3s</span>
            </button>
            <button class="qa-btn" onclick="doNormalizeText()" title="Gro√üschreibung am Satzanfang, doppelte Leerzeichen bereinigen, Interpunktion">
              <span class="qa-icon">‚úèÔ∏è</span>
              <span class="qa-label">Text normalisieren</span>
              <span class="qa-desc">Gro√ü/Klein, Interpunktion</span>
            </button>
            <button class="qa-btn" onclick="applyPreset('translation')" title="SRT + TXT + VTT exportieren ‚Äî f√ºr √úbersetzungsworkflows">
              <span class="qa-icon">üåç</span>
              <span class="qa-label">√úbersetzer-Export</span>
              <span class="qa-desc">SRT+TXT+VTT</span>
            </button>
            <button class="qa-btn" onclick="doExportAll()" title="Alle Untertitel-Formate auf einmal generieren und herunterladen">
              <span class="qa-icon">üì¶</span>
              <span class="qa-label">Alle Formate</span>
              <span class="qa-desc">SRT+ASS+VTT+LRC+TXT+HTML</span>
            </button>
          </div>
        </div>
        <!-- Gap Scanner Results -->
        <div id="gapResults" style="display:none;margin-top:8px" class="card">
          <div class="card-h">üîç Gap Scanner Ergebnisse</div>
          <div id="gapList" style="max-height:35vh;overflow:auto"></div>
        </div>
        <!-- CPS Heatmap -->
        <div id="heatmapCard" style="display:none;margin-top:8px" class="card">
          <div class="card-h">üå°Ô∏è CPS Heatmap</div>
          <canvas id="heatCv" style="width:100%;height:60px;border-radius:6px;cursor:pointer" onclick="seekHM(event)" title="CPS-Heatmap ‚Äî Klicken zum Spulen"></canvas>
          <div style="display:flex;justify-content:space-between;font-size:.6rem;color:var(--dim);margin-top:2px">
            <span>üü¢ &lt;15 CPS</span><span>üü° 15-20</span><span>üü† 20-25</span><span>üî¥ &gt;25</span>
          </div>
        </div>
        <!-- Text Stats Results -->
        <div id="textStatsCard" style="display:none;margin-top:8px" class="card">
          <div class="card-h">üìä Text Analyse</div>
          <div id="textStatsGrid" class="stats-grid"></div>
          <div id="textStatsWords" style="margin-top:8px"></div>
          <div id="textStatsSyl" style="margin-top:8px"></div>
        </div>
      </div>
      <!-- Dictionary Tab -->
      <div id="tDict" style="display:none;margin-top:8px">
        <div class="card">
          <div class="card-h">üìñ Custom Dictionary</div>
          <div id="dictList"></div>
          <button class="btn-s btn-sm" onclick="addDictRow()" style="margin-top:6px" title="Neues Wort-Paar hinzuf√ºgen (Falsch ‚Üí Korrekt)">+ Eintrag</button>
          <button class="btn btn-sm" onclick="saveDict()" style="margin-top:6px;margin-left:6px" title="Dictionary auf Server speichern (custom_words.txt)">Speichern</button>
        </div>
      </div>
      <!-- Report Tab -->
      <div id="tRep" style="display:none;margin-top:8px">
        <pre style="background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:12px;font-family:var(--mono);font-size:.7rem;overflow:auto;max-height:50vh" id="repC"></pre>
      </div>
    </div>
  </div>
</main>
</div>
<audio id="audioEl" preload="auto"></audio>
<div class="toast-c" id="toasts"></div>

<!-- Tag Modal -->
<div class="modal-bg" id="tagModal" onclick="if(event.target===this)closeTagModal()">
  <div class="modal" style="max-width:480px;width:90%">
    <div class="modal-head"><h2 style="font-size:1rem">üè∑Ô∏è Media Tags</h2>
      <div class="modal-close" onclick="closeTagModal()" title="Schlie√üen">‚úï</div>
    </div>
    <div class="modal-body" style="padding:12px">
      <div id="tagStatus" style="font-size:.65rem;color:var(--dim);margin-bottom:8px"></div>
      <div class="tag-form" id="tagForm"></div>
      <div class="tag-actions" id="tagActions" style="display:none">
        <button class="btn-s" onclick="closeTagModal()" title="Tag-Bearbeitung abbrechen und schlie√üen">Abbrechen</button>
        <button class="btn" onclick="saveTags()" title="Media-Tags in die Datei schreiben">üíæ Speichern</button>
      </div>
    </div>
  </div>
</div>

<!-- Library Modal -->
<div class="modal-bg" id="libModal" onclick="if(event.target===this)toggleLibrary()">
  <div class="modal" style="max-width:650px;width:95%">
    <div class="modal-head"><h2 style="font-size:1rem">üìö Transcriptions Library</h2>
      <div class="modal-close" onclick="toggleLibrary()" title="Schlie√üen">‚úï</div>
    </div>
    <div class="modal-body" style="padding:12px">
      <input type="text" class="lib-search" id="libSearch" placeholder="Suche nach Titel, Datei, Backend..." title="Library nach Titel, Datei oder Backend durchsuchen"
        oninput="clearTimeout(libST);libST=setTimeout(loadLibrary,400)" style="width:100%;padding:7px 10px;font-size:.78rem;border-radius:6px">
      <div class="lib-list" id="libList"><div class="lib-empty">Lade...</div></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;font-size:.65rem;color:var(--dim)">
        <span id="libCount">‚Äî</span>
        <div><button class="btn-s btn-sm" onclick="libPage=Math.max(0,libPage-1);loadLibrary()" id="libPrev" disabled title="Vorherige Seite">‚óÇ Prev</button>
        <button class="btn-s btn-sm" onclick="libPage++;loadLibrary()" id="libNext" title="N√§chste Seite">Next ‚ñ∏</button></div>
      </div>
    </div>
  </div>
</div>

<!-- Video Render Section in sidebar -->

<!-- Demucs Separation Modal -->
<div class="modal-bg" id="demucsModal" onclick="if(event.target===this)closeDemucsModal()">
  <div class="modal" style="max-width:560px;width:95%">
    <div class="modal-head"><h2 style="font-size:1rem">üéµ Vocal Separation (Demucs)</h2>
      <div class="modal-close" onclick="closeDemucsModal()" title="Schlie√üen">‚úï</div>
    </div>
    <div class="modal-body" style="padding:16px">
      <div id="demucsStatus" style="font-size:.7rem;color:var(--dim);margin-bottom:10px"></div>

      <div style="margin-bottom:10px">
        <label style="font-size:.75rem;color:var(--dim);display:block;margin-bottom:4px">Audio-Datei</label>
        <select id="demucsFile" style="width:100%;padding:6px 8px;font-size:.78rem;border-radius:6px;background:var(--bg3);color:var(--text);border:1px solid var(--border)" title="Audio-Datei f√ºr Stem-Separation w√§hlen">
          <option value="">‚Äî Datei w√§hlen ‚Äî</option>
        </select>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
        <div>
          <label style="font-size:.7rem;color:var(--dim);display:block;margin-bottom:3px">Stems</label>
          <select id="demucsStemMode" style="width:100%;padding:5px;font-size:.75rem;border-radius:5px;background:var(--bg3);color:var(--text);border:1px solid var(--border)" title="Stem-Modus: Nur Vocals oder alle Stems">
            <option value="vocals" selected>Nur Vocals</option>
            <option value="all">Alle (Vocals/Drums/Bass/Other)</option>
          </select>
        </div>
        <div>
          <label style="font-size:.7rem;color:var(--dim);display:block;margin-bottom:3px">Modell</label>
          <select id="demucsModel" style="width:100%;padding:5px;font-size:.75rem;border-radius:5px;background:var(--bg3);color:var(--text);border:1px solid var(--border)" title="Demucs-Modell: htdemucs (Standard), Fine-tuned, mdx_extra">
            <option value="htdemucs" selected>htdemucs (Standard)</option>
            <option value="htdemucs_ft">htdemucs_ft (Fine-tuned)</option>
            <option value="mdx_extra">mdx_extra</option>
          </select>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
        <div>
          <label style="font-size:.7rem;color:var(--dim);display:block;margin-bottom:3px">Device</label>
          <select id="demucsDevice" style="width:100%;padding:5px;font-size:.75rem;border-radius:5px;background:var(--bg3);color:var(--text);border:1px solid var(--border)" title="Rechenger√§t: CPU, GPU (CUDA) oder Auto">
            <option value="cpu" selected>CPU</option>
            <option value="cuda">GPU (CUDA)</option>
            <option value="auto">Auto</option>
          </select>
        </div>
        <div>
          <label style="font-size:.7rem;color:var(--dim);display:block;margin-bottom:3px">Shifts (Qualit√§t)</label>
          <input type="number" id="demucsShifts" value="1" min="1" max="10" style="width:100%;padding:5px;font-size:.75rem;border-radius:5px;background:var(--bg3);color:var(--text);border:1px solid var(--border)" title="Shifts: Mehr = bessere Qualit√§t, aber langsamer (1‚Äì10)">
        </div>
      </div>

      <label style="font-size:.7rem;display:flex;align-items:center;gap:5px;color:var(--dim);margin-bottom:12px">
        <input type="checkbox" id="demucsMp3" title="Ausgabe als MP3 statt WAV ‚Äî kleinere Dateien, leichter Qualit√§tsverlust"> Ausgabe als MP3 (statt WAV)
      </label>

      <!-- Progress -->
      <div id="demucsProgress" style="display:none;margin-bottom:10px">
        <div style="background:var(--bg3);border-radius:6px;overflow:hidden;height:20px;border:1px solid var(--border)">
          <div id="demucsBar" style="height:100%;background:var(--accent);width:0%;transition:width .3s;font-size:.6rem;line-height:20px;text-align:center;color:#000"></div>
        </div>
        <div id="demucsStage" style="font-size:.65rem;color:var(--dim);margin-top:3px;text-align:center"></div>
      </div>

      <!-- Results -->
      <div id="demucsResults" style="display:none;margin-bottom:10px">
        <div style="font-size:.78rem;font-weight:600;margin-bottom:6px;color:var(--accent)">‚úÖ Stems</div>
        <div id="demucsStemList" style="display:flex;flex-wrap:wrap;gap:6px"></div>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn-s" onclick="closeDemucsModal()" title="Demucs-Dialog schlie√üen">Schlie√üen</button>
        <button class="btn" id="demucsStartBtn" onclick="startDemucs()" title="Vocal Separation mit Demucs starten">üéµ Separation starten</button>
      </div>
    </div>
  </div>
</div>

<!-- AI Chat Panel -->
<div class="chat-panel" id="chatPanel">
  <div class="chat-head">
    <span style="font-size:1rem">ü§ñ</span>
    <h3>AI Assistant</h3>
    <span class="ai-model" id="aiModel">‚Äî</span>
    <button class="chat-close" onclick="clearChat()" title="Chat leeren">üóë</button>
    <button class="chat-close" onclick="toggleChat()" title="Chat schlie√üen">‚úï</button>
  </div>
  <div class="chat-cmds">
    <button class="chat-cmd" onclick="sendCmd('correct')" title="Transkriptionsfehler kontextbasiert fixen">üîß Korrigieren</button>
    <button class="chat-cmd" onclick="sendCmd('punctuate')" title="Satzzeichen und Formatierung">‚úèÔ∏è Interpunktion</button>
    <button class="chat-cmd" onclick="sendCmd('structure')" title="Verse/Hook/Bridge erkennen">üèóÔ∏è Struktur</button>
    <button class="chat-cmd" onclick="sendCmd('translate')" title="Lyrics uebersetzen">üåç Translate</button>
    <button class="chat-cmd" onclick="sendCmd('generate')" title="Fehlende Lyrics generieren">‚ú® Generate</button>
    <button class="chat-cmd" onclick="startMerge(true)" title="Kurze Segmente zusammenf√ºhren (Dry-Run)">üîó Merge</button>
  </div>
  <div class="ref-upload-bar">
    <label title="Referenztext hochladen (.txt/.lrc/.srt/.vtt)">üìÑ Referenztext
      <input type="file" id="refFileIn" accept=".txt,.lrc,.srt,.vtt" hidden onchange="onRefFileSelected(this)">
    </label>
    <span class="ref-filename" id="refFileName">‚Äî</span>
    <button class="btn-s btn-sm" onclick="startRefCorrect(false)" id="refDryRunBtn" disabled title="Dry-Run: √Ñnderungen anzeigen">üîç Pr√ºfen</button>
    <button class="btn-s btn-sm" onclick="pasteRefText()" title="Text aus Zwischenablage einf√ºgen">üìã</button>
  </div>
  <div class="chat-msgs" id="chatMsgs">
    <div class="chat-no-ai" id="chatWelcome">
      <div style="font-size:1.5rem;margin-bottom:6px">ü§ñ</div>
      <b>AI Audio Engineer</b><br>
      Korrigiert Lyrics, setzt Interpunktion, erkennt Songstrukturen, uebersetzt und generiert Texte.<br><br>
      Nutze die Buttons oben oder schreibe frei.
    </div>
  </div>
  <div class="chat-input">
    <input type="text" id="chatIn" placeholder="Nachricht..." onkeydown="if(event.key==='Enter'&&!event.shiftKey)sendChat()" title="Nachricht an AI Assistant eingeben">
    <button class="btn" id="chatSend" onclick="sendChat()" title="Nachricht senden (Enter)">‚Üë</button>
  </div>
</div>

<!-- Help Modal -->
<div class="modal-bg" id="helpModal" onclick="if(event.target===this)toggleHelp()">
<div class="modal">
<div class="modal-head">
  <span style="font-size:1.1rem">üìñ</span>
  <h2>Karaoke Sub Tool ‚Äî Hilfe</h2>
  <div class="modal-close" onclick="toggleHelp()" title="Schlie√üen">‚úï</div>
</div>
<div class="modal-body">

<h3>üöÄ Schnellstart</h3>
<p>Audio-Datei hochladen (Drag & Drop oder Klick), Settings w√§hlen, <b>‚ñ∂ Start</b> dr√ºcken. Die Transkription l√§uft serverseitig (API-Call oder lokal), danach kannst du Segmente im Editor bearbeiten und in verschiedenen Formaten exportieren.</p>

<h3>üìù Lyrics Upload (optional)</h3>
<p>Lade zus√§tzlich eine <code>.txt</code>-Datei mit den Song-Lyrics hoch. Jede Zeile in der Datei wird exakt als ein Untertitel-Segment √ºbernommen ‚Äî <b>Zeilenumbr√ºche, Satzl√§nge und Formatierung bestimmen die Segmentierung</b> in SRT und ASS.</p>
<table class="htable">
<tr><th>Ohne Lyrics-Datei</th><th>Mit Lyrics-Datei</th></tr>
<tr><td>Transkription bestimmt Text UND Segmentierung</td><td>Transkription liefert nur Timing, <b>Text kommt aus der .txt</b></td></tr>
<tr><td>CPS/Max Chars splitten automatisch</td><td>Zeilen werden exakt √ºbernommen, kein Auto-Split</td></tr>
<tr><td>Word-Timestamps aus Transkription</td><td>Word-Timestamps werden auf Lyrics-W√∂rter umverteilt</td></tr>
</table>
<p><b>Format:</b> Eine Zeile pro Segment. Leerzeilen und <code>[Section]</code>-Marker werden ignoriert. UTF-8-Encoding.</p>

<h3>üîß Settings ‚Äî Backends</h3>
<p>Das Backend bestimmt, welcher Dienst die Sprache-zu-Text-Umwandlung √ºbernimmt:</p>
<table class="htable">
<tr><th>Backend</th><th>Typ</th><th>Beschreibung</th><th>Word-Timestamps</th></tr>
<tr><td><b>Voxtral</b></td><td><span class="htag htag-api">Cloud API</span></td><td>Mistral AI ‚Äì schnell, gute Deutsch-Qualit√§t. Braucht <code>MISTRAL_API_KEY</code> in <code>.env</code>.</td><td>Segment-Level (Words werden approximiert)</td></tr>
<tr><td><b>OpenAI</b></td><td><span class="htag htag-api">Cloud API</span></td><td>OpenAI Whisper API. Braucht <code>OPENAI_API_KEY</code>.</td><td>‚úì Word-Level</td></tr>
<tr><td><b>Local Whisper</b></td><td><span class="htag htag-local">Lokal</span></td><td>L√§uft lokal via <code>faster-whisper</code>. Braucht GPU f√ºr Speed, CPU geht aber langsam.</td><td>‚úì Word-Level</td></tr>
<tr><td><b>WhisperX</b></td><td><span class="htag htag-local">Lokal</span></td><td>Forced Phoneme Alignment via wav2vec2 ‚Äî <b>beste Word-Timestamps</b> f√ºr Karaoke. Braucht <code>pip install whisperx torch</code>.</td><td>‚úì‚úì‚úì Phonem-pr√§zise</td></tr>
</table>

<h3>üåç Sprache</h3>
<table class="htable">
<tr><th>Option</th><th>Beschreibung</th></tr>
<tr><td><b>Auto</b></td><td>Automatische Spracherkennung (empfohlen f√ºr einzelne Sprachen)</td></tr>
<tr><td><b>DE / EN / FR / ES / JA</b></td><td>Sprache explizit vorgeben ‚Äî verbessert Genauigkeit bei bekannter Sprache</td></tr>
</table>

<h3>üé§ Karaoke Mode</h3>
<p>Bestimmt den ASS-Karaoke-Tag-Stil f√ºr die Wort-Animation:</p>
<table class="htable">
<tr><th>Mode</th><th>ASS-Tag</th><th>Effekt</th></tr>
<tr><td><b>kf</b></td><td><code>\kf</code></td><td><b>Fill-Effekt</b> ‚Äî Wort wird progressiv von links nach rechts gef√ºllt. Standard f√ºr Karaoke.</td></tr>
<tr><td><b>k</b></td><td><code>\k</code></td><td><b>Instant Highlight</b> ‚Äî Wort springt sofort auf Highlight-Farbe um.</td></tr>
<tr><td><b>ko</b></td><td><code>\ko</code></td><td><b>Outline-Wipe</b> ‚Äî Outline wird progressiv gef√ºllt, Text bleibt.</td></tr>
</table>

<h3>üé® Preset (Theme)</h3>
<p>Voreinstellungen f√ºr Schriftart, Gr√∂√üe, Farben und Aufl√∂sung der ASS-Datei:</p>
<table class="htable">
<tr><th>Preset</th><th>Aufl√∂sung</th><th>Schrift</th><th>Einsatz</th></tr>
<tr><td><b>Classic</b></td><td>1920√ó1080</td><td>Arial Bold</td><td>Standard-Karaoke, YouTube</td></tr>
<tr><td><b>Neon</b></td><td>1920√ó1080</td><td>Trebuchet MS</td><td>Leuchtende Farben, Club-Style</td></tr>
<tr><td><b>High Contrast</b></td><td>1920√ó1080</td><td>Impact</td><td>Maximale Lesbarkeit</td></tr>
<tr><td><b>Landscape</b></td><td>1920√ó1080</td><td>Arial</td><td>16:9 Landscape</td></tr>
<tr><td><b>Portrait</b></td><td>1080√ó1920</td><td>Arial</td><td>9:16 TikTok / Reels / Shorts</td></tr>
<tr><td><b>Mobile Safe</b></td><td>1080√ó1920</td><td>Arial</td><td>Gro√üe Schrift, Safe Area f√ºr UI-Elemente</td></tr>
</table>

<h3>üìä CPS / Max Chars</h3>
<table class="htable">
<tr><th>Setting</th><th>Default</th><th>Beschreibung</th></tr>
<tr><td><b>CPS</b></td><td>18</td><td><b>Characters Per Second</b> ‚Äî Maximale Lesegeschwindigkeit. Segmente werden aufgeteilt wenn CPS √ºberschritten wird. F√ºr Karaoke/Rap: 20‚Äì25, f√ºr Untertitel: 12‚Äì18.</td></tr>
<tr><td><b>Max Chars</b></td><td>42</td><td>Maximale Zeichen pro Zeile. Standard 42 f√ºr 16:9, 30‚Äì35 f√ºr Portrait/Mobile.</td></tr>
</table>

<h3>üîò Preprocessing Toggles</h3>
<table class="htable">
<tr><th>Option</th><th>Default</th><th>Was es tut</th></tr>
<tr><td><b>VAD</b></td><td>‚úì An</td><td><b>Voice Activity Detection</b> ‚Äî Entfernt Stille vor der Transkription. Beschleunigt den Prozess und verbessert Timestamps. Wird bei WhisperX automatisch √ºbersprungen (hat eigene VAD).</td></tr>
<tr><td><b>Normalize</b></td><td>‚úì An</td><td><b>Loudness Normalization</b> auf -16 LUFS via ffmpeg. Verbessert die Erkennung bei leisen oder √ºbersteuertem Audio.</td></tr>
<tr><td><b>ASS</b></td><td>‚úì An</td><td>Generiert ASS-Karaoke-Untertiteldatei mit gew√§hltem Preset und Mode.</td></tr>
<tr><td><b>+VTT</b></td><td>Aus</td><td>Zus√§tzlich WebVTT exportieren (f√ºr HTML5 Video/Browser).</td></tr>
<tr><td><b>+LRC</b></td><td>Aus</td><td>Zus√§tzlich LRC-Lyrics exportieren (f√ºr Musik-Player, mit Word-Tags).</td></tr>
<tr><td><b>+TXT</b></td><td>Aus</td><td>Zus√§tzlich reinen Text exportieren (ohne Timestamps).</td></tr>
<tr><td><b>Vocal Iso</b></td><td>Aus</td><td><b>Vocal Isolation</b> via Demucs ‚Äî trennt Gesang von Instrumenten vor der Transkription. Verbessert Ergebnisse bei Musik mit lauten Beats, braucht aber GPU.</td></tr>
<tr><td><b>BPM Snap</b></td><td>Aus</td><td><b>Beat-Grid Snap</b> ‚Äî Erkennt BPM (via Essentia/librosa) und snapped Segment-/Word-Grenzen auf den n√§chsten Beat. F√ºr Rap/Songs mit klarem Rhythmus.</td></tr>
<tr><td><b>AI Correct</b></td><td>Aus</td><td><b>KI-Lyrics-Korrektur</b> ‚Äî Nach der Transkription werden die Lyrics automatisch durch die Mistral API geschickt zur kontextbasierten Fehlerkorrektur. Beachtet Reimschemata, Slang und Sprache. Nutzt <code>MISTRAL_API_KEY</code> (gleicher Key wie Voxtral).</td></tr>
</table>

<h3>üéß Audio Player</h3>
<table class="htable">
<tr><th>Funktion</th><th>Bedienung</th></tr>
<tr><td>Play / Pause</td><td><code>‚èØ</code> Button oder <code>Space</code></td></tr>
<tr><td>Vor / Zur√ºck</td><td><code>-5s</code> / <code>+5s</code> Buttons oder <code>‚Üê</code> <code>‚Üí</code> Pfeiltasten (¬±2s)</td></tr>
<tr><td>Speed</td><td>Dropdown: 0.5x, 0.75x, 1x, 1.25x, 1.5x, 2x</td></tr>
<tr><td>Volume</td><td>Slider rechts</td></tr>
<tr><td>Loop üîÅ</td><td>Aktiviert Segment-Loop ‚Äî das aktuell fokussierte Segment wird in Schleife abgespielt</td></tr>
<tr><td>Waveform</td><td>Klicken = Seek zur Position. Zeigt Segment-Regionen als Overlay.</td></tr>
<tr><td>Minimap</td><td>Kompakte Segment-√úbersicht: <span style="color:var(--accent2)">‚ñ†</span> Normal <span style="color:var(--warn)">‚ñ†</span> Low Confidence <span style="color:var(--purple)">‚ñ†</span> Pinned</td></tr>
<tr><td>Karaoke Live</td><td>Echtzeit Wort-Highlight synchron zur Wiedergabe</td></tr>
</table>

<h3>‚úèÔ∏è Segment Editor</h3>
<table class="htable">
<tr><th>Funktion</th><th>Beschreibung</th></tr>
<tr><td><b>#Nr klicken</b></td><td>Spielt das Segment ab</td></tr>
<tr><td><b>Start/End editieren</b></td><td>Inline-Felder: Format <code>M:SS.ms</code>, Enter zum Speichern</td></tr>
<tr><td><b>Text editieren</b></td><td>Textarea direkt bearbeiten, wird beim Verlassen gespeichert</td></tr>
<tr><td><b>‚ñ∂</b></td><td>Segment abspielen (und bei Loop als Loop-Segment setzen)</td></tr>
<tr><td><b>‚úÇ Split</b></td><td>Segment an der Mitte teilen</td></tr>
<tr><td><b>‚äï Merge</b></td><td>Mit dem n√§chsten Segment zusammenf√ºhren</td></tr>
<tr><td><b>üìå Pin</b></td><td>Segment f√ºr Review markieren</td></tr>
<tr><td><b>üé§ Speaker</b></td><td>Speaker-Label zuweisen (z.B. ‚ÄûVerse1", ‚ÄûHook")</td></tr>
<tr><td><b>CPS-Warnung</b></td><td>Orange Zahl unten rechts wenn CPS > 22</td></tr>
<tr><td><b>Confidence %</b></td><td><span style="color:var(--accent)">Gr√ºn</span> ‚â•80%, <span style="color:var(--warn)">Orange</span> 60‚Äì80%, <span style="color:var(--danger)">Rot</span> <60%</td></tr>
</table>

<h3>üîç Filter & Suche</h3>
<table class="htable">
<tr><th>Filter</th><th>Zeigt</th></tr>
<tr><td><b>Alle</b></td><td>Alle Segmente</td></tr>
<tr><td><b>‚ö† Low</b></td><td>Nur Segmente mit Confidence < 60%</td></tr>
<tr><td><b>üìå Pinned</b></td><td>Nur manuell gepinnte Segmente</td></tr>
<tr><td><b>üî¥ Overlap</b></td><td>Nur Segmente mit Timing-√úberlappungen</td></tr>
</table>
<p><b>Suchen/Ersetzen:</b> Text in alle Segmente suchen und ersetzen (case-insensitive).</p>

<h3>üõ† Toolbar</h3>
<table class="htable">
<tr><th>Button</th><th>Funktion</th></tr>
<tr><td><b>‚Ü© / ‚Ü™</b></td><td>Undo / Redo (bis zu 50 Schritte, auch via <code>Ctrl+Z</code> / <code>Ctrl+Y</code>)</td></tr>
<tr><td><b>‚è± Shift</b></td><td>Alle Segmente um ¬±ms verschieben (globaler Time-Shift)</td></tr>
<tr><td><b>üîß Fix Gaps</b></td><td>Automatisch L√ºcken und √úberlappungen reparieren (Split-Strategie)</td></tr>
<tr><td><b>üìñ Dict</b></td><td>Custom Dictionary auf alle Segmente anwenden</td></tr>
<tr><td><b>üîÑ Regen</b></td><td>SRT/ASS/VTT/LRC/TXT neu generieren nach Edits</td></tr>
<tr><td><b>üìã SRT / ASS</b></td><td>In Clipboard kopieren</td></tr>
<tr><td><b>üíæ Export</b></td><td>Gesamtes Projekt als JSON exportieren (Backup/Sharing)</td></tr>
</table>

<h3>üìñ Dictionary Tab</h3>
<p>Hier kannst du <b>Wort-Korrekturregeln</b> anlegen (z.B. h√§ufige Transkriptionsfehler). Format: <code>Falsch ‚Üí Richtig</code>. Wird in <code>custom_words.txt</code> gespeichert. √úber <b>üìñ Dict</b> in der Toolbar auf alle Segmente anwenden.</p>

<h3>üìä Stats Tab</h3>
<p>Zeigt Statistiken: Segment-Anzahl, W√∂rter, Zeichen, Dauer, ‚àÖ/Max/Min CPS, Confidence, Gaps, Overlaps, Pinned.</p>

<h3>üíæ Downloads</h3>
<table class="htable">
<tr><th>Format</th><th>Verwendung</th></tr>
<tr><td><b>SRT</b></td><td>Standard-Untertitel (VLC, YouTube, Premiere, DaVinci‚Ä¶)</td></tr>
<tr><td><b>ASS</b></td><td>Karaoke-Untertitel mit Wort-Animation (MPC-HC, mpv, Aegisub‚Ä¶)</td></tr>
<tr><td><b>VTT</b></td><td>Web Video Text Tracks (HTML5 &lt;track&gt;, Browser-Player)</td></tr>
<tr><td><b>LRC</b></td><td>Lyrics mit Timestamps (Musik-Player, Spotify-Style)</td></tr>
<tr><td><b>TXT</b></td><td>Reiner Text ohne Timestamps</td></tr>
<tr><td><b>ZIP</b></td><td>Alle Outputs zusammen herunterladen</td></tr>
</table>

<h3>‚å®Ô∏è Keyboard Shortcuts</h3>
<table class="htable">
<tr><th>Taste</th><th>Aktion</th></tr>
<tr><td><code>Space</code></td><td>Play / Pause</td></tr>
<tr><td><code>‚Üê</code> / <code>‚Üí</code></td><td>¬±2 Sekunden skippen</td></tr>
<tr><td><code>Ctrl+Z</code></td><td>Undo</td></tr>
<tr><td><code>Ctrl+Y</code></td><td>Redo</td></tr>
<tr><td><code>Ctrl+F</code></td><td>Suche fokussieren</td></tr>
<tr><td><code>S</code></td><td>Split bei Playhead</td></tr>
<tr><td><code>T</code></td><td>Tap-to-Time Modus</td></tr>
<tr><td><code>F</code></td><td>Fullscreen Karaoke</td></tr>
<tr><td><code>Shift+Drag</code></td><td>A/B Loop Region setzen</td></tr>
<tr><td><code>Shift+C</code></td><td>A/B Loop l√∂schen</td></tr>
<tr><td><code>F1</code></td><td>Diese Hilfe √∂ffnen/schlie√üen</td></tr>
<tr><td><code>Escape</code></td><td>Hilfe/Overlay schlie√üen</td></tr>
</table>

<h3>üí° Tipps</h3>
<p><b>F√ºr Rap/schnelle Texte:</b> CPS auf 22‚Äì25, WhisperX Backend (beste Word-Timestamps), BPM Snap an.</p>
<p><b>F√ºr Gesang:</b> CPS auf 15‚Äì18, Vocal Isolation an falls laute Instrumentals.</p>
<p><b>F√ºr Untertitel (kein Karaoke):</b> CPS 12‚Äì15, Max Chars 38, Mode egal (wird ignoriert bei reinem SRT).</p>
<p><b>Workflow:</b> Transkribieren ‚Üí Low-Confidence Segmente √ºber Filter pr√ºfen ‚Üí Fix Gaps ‚Üí Dictionary anwenden ‚Üí Regen ‚Üí Download.</p>

<h3>üÜï Neu in v3.2</h3>
<p><b>üé§ Tap-to-Time:</b> Audio abspielen und <code>Space</code> dr√ºcken f√ºr jede Textzeile ‚Äî setzt Timestamps manuell in Echtzeit. Perfekt f√ºr Rap-Texte wo ASR-Timing nicht stimmt.</p>
<p><b>üñ•Ô∏è Fullscreen Karaoke:</b> Immersiver Vollbild-Modus mit Wort-f√ºr-Wort Highlighting (wenn Word-Timestamps verf√ºgbar). Taste <code>F</code>.</p>
<p><b>üåä Audio Spektrum:</b> Echtzeit-Frequenzanalyse (Web Audio API FFT) √ºber der Waveform w√§hrend der Wiedergabe.</p>
<p><b>üé® Themes:</b> 4 Farbschemen (Dark, Neon, Light, Warm) ‚Äî Theme-Buttons im Header. Wird gespeichert.</p>
<p><b>‚úÇÔ∏è Split bei Playhead:</b> Taste <code>S</code> splittet das aktuelle Segment an der Playhead-Position.</p>
<p><b>üîÅ A/B Loop:</b> <code>Shift+Drag</code> auf der Waveform setzt eine Loop-Region. Audio loopt automatisch zwischen A und B.</p>

<h3>ü§ñ AI Chat</h3>
<p>Integrierter KI-Assistent der direkt auf die transkribierten Segmente zugreifen und sie bearbeiten kann. Konfiguriert √ºber <code>.env</code> mit einer einzigen Variable:</p>
<table class="htable">
<tr><th>Variable</th><th>Beschreibung</th><th>Beispiel</th></tr>
<tr><td><code>AI_MODEL</code></td><td>Modell im Format <code>provider:model</code></td><td><code>openai:gpt-5.2</code></td></tr>
<tr><td><code>OPENAI_API_KEY</code></td><td>API-Key f√ºr OpenAI-Modelle</td><td><code>sk-...</code></td></tr>
<tr><td><code>ANTHROPIC_API_KEY</code></td><td>API-Key f√ºr Anthropic</td><td><code>sk-ant-...</code></td></tr>
<tr><td><code>MISTRAL_API_KEY</code></td><td>API-Key f√ºr Mistral (wird auch f√ºr Voxtral-Transkription genutzt)</td><td><code>...</code></td></tr>
</table>
<p class="hd">Unterst√ºtzte Provider und Modelle:</p>
<table class="htable">
<tr><th>Provider</th><th>Modelle (Beispiele)</th><th>Reasoning</th></tr>
<tr><td><b>openai</b></td><td><code>gpt-5.2</code>, <code>gpt-5</code>, <code>o3-mini</code>, <code>o4-mini</code>, <code>gpt-4o</code></td><td>‚úì gpt-5*, o1*, o3*, o4*</td></tr>
<tr><td><b>anthropic</b></td><td><code>claude-sonnet-4-20250514</code>, <code>claude-opus-4-20250514</code></td><td>‚úì claude-opus-4*</td></tr>
<tr><td><b>mistral</b></td><td><code>mistral-large-latest</code>, <code>codestral-latest</code>, <code>mistral-medium-latest</code></td><td>‚Äî</td></tr>
<tr><td><b>google</b></td><td><code>gemini-2.0-flash</code>, <code>gemini-2.5-pro</code></td><td>‚úì *-thinking</td></tr>
</table>
<p>Reasoning wird <b>automatisch erkannt</b> anhand des Modellnamens ‚Äî keine separate Konfiguration n√∂tig.</p>
<p><b>AI-Befehle:</b></p>
<table class="htable">
<tr><th>Befehl</th><th>Was es tut</th><th>Model</th></tr>
<tr><td><b>üîß Korrigieren</b></td><td>Analysiert Reimschemata, Kontext, Slang und korrigiert Transkriptionsfehler automatisch</td><td>Reasoning</td></tr>
<tr><td><b>‚úèÔ∏è Interpunktion</b></td><td>Setzt Kommas, Punkte, Frage-/Ausrufezeichen ‚Äî ohne Wortlaut zu √§ndern</td><td>Standard</td></tr>
<tr><td><b>üèóÔ∏è Struktur</b></td><td>Erkennt Verse, Hook, Bridge, Outro und setzt Speaker-Labels automatisch</td><td>Reasoning</td></tr>
<tr><td><b>üåç Translate</b></td><td>√úbersetzt Lyrics unter Beibehaltung von Reimschema und Silbenanzahl</td><td>Reasoning</td></tr>
<tr><td><b>‚ú® Generate</b></td><td>Generiert fehlende Lyrics basierend auf Kontext, Genre und Flow</td><td>Standard</td></tr>
</table>
<p>Du kannst auch frei chatten ‚Äî die AI hat vollen Zugriff auf alle Segmente und kann sie direkt bearbeiten.</p>

<h3>üìö Transcriptions Library</h3>
<p>Jede fertige Transkription wird automatisch in einer SQLite-Datenbank gespeichert (<code>data/library.sqlite</code>). √úber den <b>üìö</b>-Button im Header √∂ffnet sich das Library-Modal:</p>
<table class="htable">
<tr><th>Aktion</th><th>Beschreibung</th></tr>
<tr><td><b>Suche</b></td><td>Filtert nach Titel, Dateiname oder Backend</td></tr>
<tr><td><b>Klick</b></td><td>√ñffnet die Transkription ‚Äî wenn der Job noch existiert, wird er im Editor geladen; sonst wird der SRT-Text im Report-Tab angezeigt</td></tr>
<tr><td><b>üóë L√∂schen</b></td><td>Soft-Delete mit Best√§tigung</td></tr>
</table>
<p>Deduplizierung: Bei erneutem Transkribieren derselben Datei wird der bestehende Eintrag aktualisiert statt ein Duplikat erstellt.</p>

<h3>üé¨ Video Rendering</h3>
<p>Erstellt ein fertiges Karaoke-Video aus der aktuellen Transkription. Klicke auf <b>üé¨ Video Render ‚ñæ</b> in der Sidebar:</p>
<table class="htable">
<tr><th>Feld</th><th>Beschreibung</th></tr>
<tr><td><b>BG</b></td><td>Hintergrundbild (jpg/png/webp) oder Video (mp4/mov/webm) ‚Äî wird geloopt wenn k√ºrzer als Audio</td></tr>
<tr><td><b>Audio</b></td><td>Optional ‚Äî wenn leer wird Audio aus dem Original-Job verwendet</td></tr>
<tr><td><b>Preset</b></td><td><code>youtube</code> (1080p, CRF 18), <code>mobile</code> (720p, CRF 23), <code>draft</code> (720p, CRF 28 ultrafast)</td></tr>
<tr><td><b>Pos</b></td><td>Subtitle-Position: bottom, middle, top</td></tr>
</table>
<p>Das Video erscheint als Job in der Liste und kann √ºber den normalen Download-Button heruntergeladen werden.</p>

</div>
</div>
</div>
<script>
const B='';let uploaded=[],aJobId=null,poll=null,wfPeaks=null,wfDur=0,cSegs=[],curFil='all',looping=false,loopSeg=null,subOffset=0;
let _projMode=null; // {pid, name, source_job_id} when opened via ?pid=
const au=document.getElementById('audioEl');
function toast(m,t='ok'){const e=document.createElement('div');e.className='toast toast-'+t;e.textContent=m;document.getElementById('toasts').appendChild(e);setTimeout(()=>e.remove(),3500)}
function esc(s){const e=document.createElement('span');e.textContent=s;return e.innerHTML}
function escAttr(s){return String(s).replace(/&/g,'&amp;').replace(/'/g,'&#39;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function fmt(s){if(!s&&s!==0)return'0:00';const m=Math.floor(s/60),sec=Math.floor(s%60);return m+':'+String(sec).padStart(2,'0')}
function fmtMs(s){const m=Math.floor(s/60),sec=(s%60).toFixed(2);return m+':'+sec.padStart(5,'0')}

// ‚îÄ‚îÄ Health ‚îÄ‚îÄ
async function checkH(){try{const r=await(await fetch(B+'/api/health')).json();
document.getElementById('hDot').className='dot dot-ok';
document.getElementById('bb').innerHTML=Object.entries(r.backends).map(([k,v])=>`<span style="font-size:.55rem;padding:2px 5px;border-radius:3px;background:${v?'rgba(0,229,160,.12)':'rgba(255,68,102,.1)'};color:${v?'var(--accent)':'var(--danger)'}">${k}</span>`).join('');
document.getElementById('hTxt').textContent='ffmpeg:'+(r.ffmpeg?'‚úì':'‚úó')}catch(e){document.getElementById('hDot').className='dot dot-err'}}

// ‚îÄ‚îÄ SSE ‚îÄ‚îÄ
let es=null;
function connectSSE(){if(es)es.close();es=new EventSource(B+'/api/events');
es.onmessage=e=>{const d=JSON.parse(e.data);if(['job_progress','job_completed','job_failed'].includes(d.type))refreshJobs();
if(d.type==='job_completed')toast('‚úÖ '+d.filename);if(d.type==='job_failed')toast('‚ùå '+(d.error||''),'err')};
es.onerror=()=>setTimeout(connectSSE,5000)}

// ‚îÄ‚îÄ Upload ‚îÄ‚îÄ
const dz=document.getElementById('dz'),fi=document.getElementById('fi');
['dragenter','dragover'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.add('over')}));
['dragleave','drop'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.remove('over')}));
dz.addEventListener('drop',ev=>{if(ev.dataTransfer.files.length)upF(ev.dataTransfer.files)});
fi.addEventListener('change',()=>{if(fi.files.length)upF(fi.files);fi.value=''});
async function upF(files){for(const f of files){const fd=new FormData();fd.append('file',f);
try{const r=await fetch(B+'/api/upload',{method:'POST',body:fd});const d=await r.json();
if(r.ok){uploaded.push(d.filename);toast(d.filename);document.getElementById('btnGo').disabled=false;
  if(d.media_id&&d.taggable){curMediaId=d.media_id;curMediaEditable=d.editable;
    document.getElementById('tagBtn').style.display='block';
    document.getElementById('tagBtn').textContent=d.editable?'\u{1F3F7}\uFE0F Tags bearbeiten':'\u{1F3F7}\uFE0F Tags anzeigen'}}
else toast(d.detail||'Err','err')}catch(e){toast(e.message,'err')}}}
let curMediaId='',curMediaEditable=false;

// ‚îÄ‚îÄ Lyrics Upload ‚îÄ‚îÄ
let lyricsFile=null;
const lyFi=document.getElementById('lyFi');
lyFi.addEventListener('change',async()=>{if(!lyFi.files.length)return;
const f=lyFi.files[0];lyFi.value='';
const fd=new FormData();fd.append('file',f);
try{const r=await fetch(B+'/api/upload',{method:'POST',body:fd});const d=await r.json();
if(r.ok){lyricsFile=d.filename;
document.getElementById('lyLabel').textContent=d.filename;
document.getElementById('lyHint').textContent=Math.round(d.size/1024)+' KB';
document.getElementById('lyDel').style.display='inline-block';
document.getElementById('lyOpts').style.display='block';
toast('Lyrics: '+d.filename)}
else toast(d.detail||'Err','err')}catch(e){toast(e.message,'err')}});
function clearLyrics(){lyricsFile=null;
document.getElementById('lyLabel').textContent='Lyrics (.txt/.lrc) hochladen';
document.getElementById('lyHint').textContent='Zeilenstruktur wird f\u00FCr SRT/ASS \u00FCbernommen';
document.getElementById('lyDel').style.display='none';
document.getElementById('lyOpts').style.display='none';toast('Lyrics entfernt')}

// ‚îÄ‚îÄ Settings ‚îÄ‚îÄ
document.getElementById('sB').onchange=function(){document.getElementById('wxO').style.display=this.value==='whisperx'?'block':'none'};
function gS(){const s={backend:$('sB'),language:$('sL'),vad:$c('sVAD'),normalize:$c('sN'),vocal_isolation:$c('sVO'),
generate_ass:$c('sA'),generate_vtt:$c('sVTT'),generate_lrc:$c('sLRC'),generate_txt:$c('sTXT'),
karaoke_mode:$('sK'),preset:$('sP'),cps:parseFloat($('sC'))||18,max_chars_per_line:parseInt($('sMC'))||42,
snap_to_beat:$c('sBT'),bpm:$c('sBT')?'detect':null,ai_correct:$c('sAI'),
whisperx_model_size:$('sWXM'),whisperx_compute_type:$('sWXC')};
if(lyricsFile){s.use_lyrics_template=true;s.lyrics_template_mode=$('sLTM');
s.match_mode=$('sMatch');s.preserve_empty_lines=$c('sEL')}
return s}
function $(id){return document.getElementById(id).value}
function $c(id){return document.getElementById(id).checked}

// ‚îÄ‚îÄ Tags Modal ‚îÄ‚îÄ
const TAG_FIELDS=['title','artist','album','album_artist','genre','year','track','disc','comment','composer'];
async function openTagModal(){if(!curMediaId)return;
const m=document.getElementById('tagModal');m.classList.add('open');
const form=document.getElementById('tagForm');form.innerHTML='<div style="color:var(--dim);font-size:.7rem">Lade Tags...</div>';
document.getElementById('tagActions').style.display='none';
try{const r=await(await fetch(B+'/api/media/'+curMediaId+'/tags')).json();
document.getElementById('tagStatus').textContent=r.filename+' ‚Äî '+(r.editable?'Bearbeitbar':'Nur Lesen')+(r.has_cover?' \u00B7 Cover \u2713':'');
form.innerHTML='';
for(const f of TAG_FIELDS){
  if(!r.supported_fields.includes(f))continue;
  const div=document.createElement('div');div.className='tag-row';
  const inp=document.createElement('input');inp.type='text';inp.id='tag_'+f;inp.value=r.tags[f]||'';
  if(!r.editable)inp.disabled=true;
  const lbl=document.createElement('label');lbl.textContent=f;
  div.appendChild(lbl);div.appendChild(inp);form.appendChild(div)}
if(r.editable)document.getElementById('tagActions').style.display='flex';
}catch(e){form.innerHTML='<div style="color:#e74c3c">'+e.message+'</div>'}}
function closeTagModal(){document.getElementById('tagModal').classList.remove('open')}
async function saveTags(){const tags={};
TAG_FIELDS.forEach(f=>{const el=document.getElementById('tag_'+f);if(el&&el.value.trim())tags[f]=el.value.trim()});
if(!Object.keys(tags).length){toast('Keine Tags','err');return}
try{const r=await fetch(B+'/api/media/'+curMediaId+'/tags',{method:'PUT',
headers:{'Content-Type':'application/json'},body:JSON.stringify({tags})});
const j=await r.json();if(r.ok){toast('Tags gespeichert');closeTagModal()}else toast(j.detail||'Err','err')
}catch(e){toast('Tags: '+e.message,'err')}}

// ‚îÄ‚îÄ Start ‚îÄ‚îÄ
document.getElementById('btnGo').onclick=async()=>{if(!uploaded.length)return;const fn=uploaded[uploaded.length-1],s=gS();
let url=B+'/api/transcribe?filename='+encodeURIComponent(fn);
if(lyricsFile)url+='&lyrics_file='+encodeURIComponent(lyricsFile);
try{const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(s)});
const j=await r.json();if(r.ok){toast('Job gestartet'+(lyricsFile?' (mit Lyrics)':''));selJob(j.job_id)}else toast(j.detail||'Err','err')}catch(e){toast(e.message,'err')}};

// ‚îÄ‚îÄ Jobs ‚îÄ‚îÄ
function startPoll(){if(poll)clearInterval(poll);poll=setInterval(refreshJobs,2500);refreshJobs()}
async function refreshJobs(){try{const jobs=await(await fetch(B+'/api/jobs')).json();rJL(jobs);
if(aJobId){const j=jobs.find(j=>j.job_id===aJobId);if(j)rDetail(j)}
if(!jobs.some(j=>!['completed','failed','cancelled'].includes(j.status))&&poll){clearInterval(poll);poll=null}}catch(e){}}
function rJL(jobs){const el=document.getElementById('jl');if(!jobs.length){el.innerHTML='<div style="font-size:.7rem;color:var(--dim);padding:5px">Keine Jobs</div>';return}
const ic={pending:'‚è≥',queued:'‚è≥',preprocessing:'üîß',transcribing:'üéô',refining:'‚ú®',exporting:'üì¶',rendering_preview:'üé¨',completed:'‚úÖ',failed:'‚ùå',cancelled:'‚õî'};
el.innerHTML=jobs.map(j=>{const c=['completed'].includes(j.status)?'c':['failed'].includes(j.status)?'f':['cancelled'].includes(j.status)?'x':['pending','queued'].includes(j.status)?'p':'r';
const running=['pending','queued','preprocessing','transcribing','refining','exporting','rendering_preview'].includes(j.status);
const cancelBtn=running?`<button class="ji-cancel" onclick="event.stopPropagation();cancelJob('${j.job_id}')" title="Abbrechen">‚úï</button>`:'';
return`<div class="ji${j.job_id===aJobId?' active':''}" onclick="selJob('${j.job_id}')"><div class="jic ${c}">${ic[j.status]||'‚è≥'}</div><div class="jm"><div class="jn">${esc(j.filename)}</div><div class="js">${j.stage} ${Math.round(j.progress*100)}%</div>${j.progress>0&&j.progress<1?`<div class="pb"><div class="pf" style="width:${j.progress*100}%"></div></div>`:''}</div>${cancelBtn}</div>`}).join('')}
function selJob(id){aJobId=id;_persistSession({job_id:id});document.getElementById('es').style.display='none';const jd=document.getElementById('jd');jd.style.display='flex';jd.style.flexDirection='column';jd.style.gap='12px';refreshJobs();if(!poll)startPoll()}

async function cancelJob(id){
  if(!confirm('Job wirklich abbrechen?'))return;
  try{const r=await fetch(B+'/api/jobs/'+id+'/cancel',{method:'POST'});
    if(r.ok){toast('Job abgebrochen');refreshJobs()}
    else{const d=await r.json();toast(d.detail||'Fehler','err')}}
  catch(e){toast('Fehler: '+e.message,'err')}}

async function rDetail(j){
const ic={pending:'‚è≥',queued:'‚è≥',preprocessing:'üîß',transcribing:'üéô',refining:'‚ú®',exporting:'üì¶',rendering_preview:'üé¨',completed:'‚úÖ',failed:'‚ùå',cancelled:'‚õî'};
document.getElementById('dI').textContent=ic[j.status]||'‚è≥';
document.getElementById('dF').textContent=j.filename;
document.getElementById('dS').textContent=j.status;
document.getElementById('dP').style.width=(j.progress*100)+'%';
const st=document.getElementById('dSt');st.textContent=j.error?'Error: '+j.error:j.stage;
st.style.color=j.status==='failed'?'var(--danger)':j.status==='cancelled'?'var(--warn)':'var(--dim)';
if(j.status==='completed'&&j.result){
  setupPlayer(j);
  // downloads
  document.getElementById('dlSec').style.display='block';
  document.getElementById('zipDl').href=B+'/api/jobs/'+j.job_id+'/download-zip';
  const r=j.result,bt=document.getElementById('dlBtns');let h='';
  for(const[k,l]of[['srt_file','SRT'],['ass_file','ASS'],['vtt_file','VTT'],['lrc_file','LRC'],['txt_file','TXT'],['report_file','Report']]){
    if(r[k])h+=`<a class="dl" href="${B}/api/jobs/${j.job_id}/download/${r[k]}" download><span class="x">${r[k].split('.').pop().toUpperCase()}</span>${l}</a>`}
  h+=`<span style="font-size:.65rem;color:var(--dim);margin-left:4px">${r.segments_count} seg ‚Ä¢ ${r.backend} ‚Ä¢ ${r.language}${r.word_timestamps_available?' ‚Ä¢ ‚úìwords':''}${r.needs_review?` ‚Ä¢ <b style="color:var(--warn)">${r.needs_review}‚ö†</b>`:''}</span>`;
  bt.innerHTML=h;
  document.getElementById('edSec').style.display='block';
  loadSegs(j.job_id);loadStats(j.job_id);loadRep(j.job_id);loadDict()
}else{document.getElementById('dlSec').style.display='none';document.getElementById('edSec').style.display='none';document.getElementById('playerSec').style.display='none'}}

// ‚îÄ‚îÄ Player ‚îÄ‚îÄ
function setupPlayer(j){au.src=B+'/data/output/'+j.job_id+'/'+j.filename;
au.onerror=()=>{au.src=B+'/data/uploads/'+j.filename};
document.getElementById('playerSec').style.display='block';loadWF(j.job_id);
au.onloadedmetadata=()=>updPT();
au.ontimeupdate=()=>{updPT();hlSeg();updKaraoke();if(looping&&loopSeg&&au.currentTime>=loopSeg.end)au.currentTime=loopSeg.start}}
function togglePlay(){au.paused?au.play():au.pause()}
function skipTo(s){au.currentTime=Math.max(0,au.currentTime+s)}
function subTime(){return au.currentTime+subOffset}
function adjOffset(ms){subOffset+=(ms/1000);_updOffsetUI()}
function resetOffset(){subOffset=0;_updOffsetUI()}
function _updOffsetUI(){const el=document.getElementById('offsetVal');const ms=Math.round(subOffset*1000);
el.textContent=(ms>=0?'+':'')+ms+' ms';el.className='offset-val '+(ms<0?'neg':ms>0?'pos':'zero')}
async function applyOffset(){if(!aJobId||subOffset===0)return;const ms=Math.round(subOffset*1000);
try{await fetch(B+'/api/jobs/'+aJobId+'/segments/time-shift',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({offset_ms:ms})});
toast('Offset '+ms+'ms angewendet');subOffset=0;_updOffsetUI();loadSegs(aJobId)}catch(e){toast('Offset-Fehler','err')}}
function setSpeed(v){au.playbackRate=parseFloat(v)}
function toggleLoop(){looping=!looping;document.getElementById('loopBtn').style.opacity=looping?'1':'.4';if(!looping)loopSeg=null}
function updPT(){const c=au.currentTime||0,d=au.duration||0;document.getElementById('pTime').textContent=fmt(c)+' / '+fmt(d);
if(wfDur>0){document.getElementById('wfCur').style.left=(c/wfDur*100)+'%';document.getElementById('mmCur').style.left=(c/wfDur*100)+'%'}}

async function loadWF(jid){try{const d=await(await fetch(B+'/api/jobs/'+jid+'/waveform')).json();wfPeaks=d.peaks;wfDur=d.duration;drawWF()}catch(e){wfPeaks=null}}
function drawWF(){const cv=document.getElementById('wfCv'),ctx=cv.getContext('2d'),rect=cv.parentElement.getBoundingClientRect();
cv.width=rect.width*2;cv.height=rect.height*2;ctx.clearRect(0,0,cv.width,cv.height);if(!wfPeaks||!wfPeaks.length)return;
const w=cv.width/wfPeaks.length,mid=cv.height/2;ctx.fillStyle='#00e5a044';
for(let i=0;i<wfPeaks.length;i++){const h=wfPeaks[i]*mid;ctx.fillRect(i*w,mid-h,Math.max(1,w-.5),h*2)}
if(cSegs.length&&wfDur>0){ctx.fillStyle='rgba(0,184,255,0.06)';for(const s of cSegs){const x1=s.start/wfDur*cv.width,x2=s.end/wfDur*cv.width;ctx.fillRect(x1,0,x2-x1,cv.height)}}}
function seekWF(ev){const r=ev.currentTarget.getBoundingClientRect();au.currentTime=(ev.clientX-r.left)/r.width*wfDur}
function seekMM(ev){const r=ev.currentTarget.getBoundingClientRect();au.currentTime=(ev.clientX-r.left)/r.width*wfDur}

// ‚îÄ‚îÄ Karaoke Live ‚îÄ‚îÄ
function _getKaraokeMode(){return document.getElementById('sK').value}
function _wordsMatch(seg){return seg.words&&seg.words.length&&seg.words.map(w=>w.word).join(' ').trim()===seg.text.trim()}
function updKaraoke(){if(!cSegs.length)return;const t=subTime();const el=document.getElementById('kLive');
const seg=cSegs.find(s=>t>=s.start&&t<=s.end);
if(!seg){el.innerHTML='<span style="color:var(--dim);font-size:.85rem">‚Äî</span>';el.dataset.segIdx='';return}
el.dataset.segIdx=cSegs.indexOf(seg);
const mode=_getKaraokeMode();
const hlC=getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()||'#00e5a0';
const baseC=getComputedStyle(el).color||'var(--text)';
const hasWords=_wordsMatch(seg);
if(hasWords){
  el.innerHTML=seg.words.map(w=>{
    if(t>=w.end)return`<span class="kw past">${esc(w.word)} </span>`;
    if(t>=w.start){
      if(mode==='kf'){
        const pct=Math.min(100,Math.round((t-w.start)/(w.end-w.start)*100));
        return`<span class="kw fill" style="background-image:linear-gradient(90deg,${hlC} ${pct}%,${baseC} ${pct}%)">${esc(w.word)} </span>`}
      return`<span class="kw active">${esc(w.word)} </span>`}
    return`<span class="kw">${esc(w.word)} </span>`}).join('')
}else{const pct=Math.min(1,(t-seg.start)/(seg.end-seg.start));
  if(mode==='kf'){
    const p=Math.round(pct*100);
    el.innerHTML=`<span class="kw fill" style="background-image:linear-gradient(90deg,${hlC} ${p}%,${baseC} ${p}%)">${esc(seg.text)}</span>`
  }else{
    const txt=seg.text,split=Math.floor(txt.length*pct);
    el.innerHTML=`<span class="kw active">${esc(txt.slice(0,split))}</span><span class="kw">${esc(txt.slice(split))}</span>`}}}

function editKaraokeLine(){
  if(!cSegs.length||!aJobId)return;
  const el=document.getElementById('kLive');
  const idx=parseInt(el.dataset.segIdx);
  if(isNaN(idx)||!cSegs[idx])return;
  const seg=cSegs[idx];
  const wasPlaying=!au.paused;if(wasPlaying)au.pause();
  el.innerHTML=`<input type="text" id="kEditInput" value="${escAttr(seg.text)}" 
    style="width:90%;font-size:1.1rem;font-weight:500;text-align:center;background:var(--bg3);color:var(--fg);border:2px solid var(--accent);border-radius:6px;padding:8px 12px;outline:none">`;
  const inp=document.getElementById('kEditInput');
  inp._cancelled=false;inp._wasPlaying=wasPlaying;
  inp.addEventListener('keydown',e=>{
    if(e.key==='Enter'){e.preventDefault();inp._cancelled=false;saveKaraokeEdit(idx,inp.value)}
    else if(e.key==='Escape'){inp._cancelled=true;cancelKaraokeEdit(wasPlaying)}});
  inp.addEventListener('blur',()=>{if(!inp._cancelled)saveKaraokeEdit(idx,inp.value)});
  inp.focus();inp.select()}

async function saveKaraokeEdit(idx,text){
  if(!aJobId||!cSegs[idx])return;
  cSegs[idx].text=text;
  try{await fetch(B+'/api/jobs/'+aJobId+'/segments',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({index:idx,text})})}catch(e){toast('Fehler','err')}
  renderSegs();updKaraoke();toast('‚úì Segment #'+(idx+1)+' gespeichert')}

function cancelKaraokeEdit(resume){
  // Re-render the karaoke display (don't leave it blank)
  updKaraoke();
  if(resume)au.play()}

// ‚îÄ‚îÄ Minimap ‚îÄ‚îÄ
function drawMM(){const el=document.getElementById('mm');
let h='<div class="mm-cur" id="mmCur" style="left:0"></div>';
if(cSegs.length&&wfDur>0){for(let i=0;i<cSegs.length;i++){const s=cSegs[i];
const l=s.start/wfDur*100,w=Math.max(0.3,(s.end-s.start)/wfDur*100);
let cls='mm-seg';if((s.confidence||1)<.6)cls+=' mm-low';if(s.pinned)cls+=' mm-pin';
h+=`<div class="${cls}" style="left:${l}%;width:${w}%"></div>`}}
el.innerHTML=h}

function hlSeg(){const t=subTime();document.querySelectorAll('.si').forEach(el=>{
const i=parseInt(el.dataset.idx);const s=cSegs[i];
if(s&&t>=s.start&&t<=s.end){el.classList.add('active');if(el.scrollIntoViewIfNeeded)el.scrollIntoViewIfNeeded(false)}
else el.classList.remove('active')})}

// ‚îÄ‚îÄ Segments ‚îÄ‚îÄ
let overlaps=new Set();
async function loadSegs(jid){try{cSegs=await(await fetch(B+'/api/jobs/'+jid+'/segments')).json();
// detect overlaps
overlaps=new Set();for(let i=0;i<cSegs.length-1;i++){if(cSegs[i+1].start<cSegs[i].end){overlaps.add(i);overlaps.add(i+1)}}
renderSegs();drawWF();drawMM()}catch(e){document.getElementById('segList').innerHTML='<div class="empty"><p>Fehler</p></div>'}}

function renderSegs(){
  let segs=cSegs.map((s,i)=>({...s,_i:i}));
  if(curFil==='low')segs=segs.filter(s=>(s.confidence||1)<.6);
  else if(curFil==='pinned')segs=segs.filter(s=>s.pinned);
  else if(curFil==='overlap')segs=segs.filter(s=>overlaps.has(s._i));
  document.getElementById('segCnt').textContent=cSegs.length+' seg'+(curFil!=='all'?' ('+segs.length+' shown)':'');
  const el=document.getElementById('segList');
  el.innerHTML=segs.map(s=>{const i=s._i;
    const conf=s.confidence||(s.words&&s.words.length?s.words.reduce((a,w)=>a+(w.confidence||1),0)/s.words.length:1);
    const cc=conf>=.8?'ch':conf>=.6?'cm':'cl';
    const dur=s.end-s.start;const cps=dur>0?s.text.length/dur:0;
    let cls='si';if(conf<.6)cls+=' low';if(overlaps.has(i))cls+=' overlap';if(s.pinned)cls+=' pinned';
    const spk=s.speaker?`<span class="speaker-tag" onclick="editSpeaker(${i})" title="Speaker-Label bearbeiten">${esc(s.speaker)}</span>`:'';
    const cpsW=cps>22?`<span class="cps-warn" title="Hohe Zeichenrate">${cps.toFixed(0)} cps!</span>`:'';
    return`<div class="${cls}" data-idx="${i}" id="seg${i}">
<div class="sidx" onclick="playSeg(${i})" title="Klick = Segment abspielen">#${i+1}<br>
<input class="stm-edit" value="${fmtMs(s.start)}" onchange="updTime(${i},'start',this.value)" title="Start">
<input class="stm-edit" value="${fmtMs(s.end)}" onchange="updTime(${i},'end',this.value)" title="End">
</div>
<div class="stx"><textarea rows="2" data-idx="${i}" onchange="updSeg(${i},this.value)" onfocus="loopSeg=cSegs[${i}]">${esc(s.text)}</textarea>${spk}${cpsW}</div>
<div class="scf ${cc}">${(conf*100).toFixed(0)}%</div>
<div class="sbtns">
<button onclick="playSeg(${i})" title="Play">‚ñ∂</button>
<button onclick="splitSeg(${i})" title="Split">‚úÇ</button>
<button onclick="mergeSeg(${i})" title="Merge‚Üì">‚äï</button>
<button onclick="togglePin(${i})" title="Pin">${s.pinned?'üìå':'üìç'}</button>
<button onclick="editSpeaker(${i})" title="Speaker">üé§</button>
</div></div>`}).join('')}

function setFil(f){curFil=f;document.querySelectorAll('.fil').forEach(e=>e.classList.toggle('on',e.dataset.f===f));renderSegs()}

async function updSeg(i,text){if(!aJobId)return;
  cSegs[i].text=text;
  try{await fetch(B+'/api/jobs/'+aJobId+'/segments',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({index:i,text})});
    // Flash save indicator
    const ta=document.querySelector(`[data-idx="${i}"]`);
    if(ta){ta.style.borderColor='var(--accent)';setTimeout(()=>ta.style.borderColor='',800)}
    toast('‚úì #'+(i+1)+' gespeichert')
  }catch(e){toast('Err','err')}}
async function updTime(i,field,val){if(!aJobId)return;const parts=val.split(':');if(parts.length!==2)return;
const secs=parseFloat(parts[0])*60+parseFloat(parts[1]);if(isNaN(secs))return;
const body={index:i};body[field]=secs;
try{await fetch(B+'/api/jobs/'+aJobId+'/segments',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});loadSegs(aJobId)}catch(e){toast('Err','err')}}
function playSeg(i){if(!cSegs[i])return;au.currentTime=cSegs[i].start;au.play();if(looping)loopSeg=cSegs[i]}
async function splitSeg(i){if(!aJobId||!cSegs[i])return;const s=cSegs[i];
try{await fetch(B+'/api/jobs/'+aJobId+'/segments/split',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({index:i,split_at:(s.start+s.end)/2})});toast('Split ‚úÇ');loadSegs(aJobId)}catch(e){toast('Err','err')}}
async function mergeSeg(i){if(!aJobId||i+1>=cSegs.length)return;
try{await fetch(B+'/api/jobs/'+aJobId+'/segments/merge',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({index_a:i,index_b:i+1})});toast('Merged ‚äï');loadSegs(aJobId)}catch(e){toast('Err','err')}}
async function togglePin(i){if(!aJobId)return;try{await fetch(B+'/api/jobs/'+aJobId+'/segments/toggle-pin?index='+i,{method:'POST'});loadSegs(aJobId)}catch(e){}}
async function editSpeaker(i){const sp=prompt('Speaker-Label:',cSegs[i].speaker||'');if(sp===null)return;
try{await fetch(B+'/api/jobs/'+aJobId+'/segments',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({index:i,speaker:sp})});loadSegs(aJobId)}catch(e){toast('Err','err')}}

// ‚îÄ‚îÄ Segment Operations ‚îÄ‚îÄ
async function doReplace(){if(!aJobId)return;const s=document.getElementById('srchIn').value,r=document.getElementById('replIn').value;
if(!s)return;try{const res=await(await fetch(B+'/api/jobs/'+aJobId+'/segments/search-replace',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({search:s,replace:r})})).json();toast(res.replaced_in_segments+' replaced');loadSegs(aJobId)}catch(e){toast('Err','err')}}
async function doUndo(){if(!aJobId)return;try{await fetch(B+'/api/jobs/'+aJobId+'/undo',{method:'POST'});toast('‚Ü© Undo');loadSegs(aJobId)}catch(e){toast('Nichts','err')}}
async function doRedo(){if(!aJobId)return;try{await fetch(B+'/api/jobs/'+aJobId+'/redo',{method:'POST'});toast('‚Ü™ Redo');loadSegs(aJobId)}catch(e){toast('Nichts','err')}}
async function tShift(){const ms=prompt('Offset in ms (¬±):','0');if(!ms)return;
try{await fetch(B+'/api/jobs/'+aJobId+'/segments/time-shift',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({offset_ms:parseFloat(ms)})});toast('Shifted '+ms+'ms');loadSegs(aJobId)}catch(e){toast('Err','err')}}
async function fixGaps(){if(!aJobId)return;try{const r=await(await fetch(B+'/api/jobs/'+aJobId+'/fix-gaps?strategy=split',{method:'POST'})).json();toast(r.fixed+' fixed');loadSegs(aJobId)}catch(e){toast('Err','err')}}
async function applyDict(){if(!aJobId)return;try{const r=await(await fetch(B+'/api/jobs/'+aJobId+'/apply-dictionary',{method:'POST'})).json();toast(r.applied+' korrigiert');loadSegs(aJobId)}catch(e){toast('Err','err')}}
async function regenFmt(){if(!aJobId)return;const s=gS();const fmts=["srt","ass"];if(s.generate_vtt)fmts.push("vtt");if(s.generate_lrc)fmts.push("lrc");if(s.generate_txt)fmts.push("txt");
try{const r=await(await fetch(B+'/api/jobs/'+aJobId+'/regenerate-ass',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({karaoke_mode:s.karaoke_mode,preset:s.preset,formats:fmts})})).json();toast('Generiert: '+r.regenerated.join(', '));refreshJobs()}catch(e){toast('Err','err')}}
async function copyC(ext){if(!aJobId)return;try{
  // Try to find the file: first from job files list, fallback to guessing stem
  let fn=null;
  try{const fl=await(await fetch(B+'/api/jobs/'+aJobId+'/files')).json();fn=fl.files[ext]}catch{}
  if(!fn){
    // Guess filename from existing download links or segments
    const dlLink=document.querySelector(`#dlBtns a[href*=".${ext}"]`);
    if(dlLink){const u=dlLink.getAttribute('href');fn=u.split('/').pop()}
  }
  if(!fn)return toast(ext.toUpperCase()+' nicht verf√ºgbar','err');
  const d=await(await fetch(B+'/api/jobs/'+aJobId+'/content/'+fn)).json();
  if(d.content!=null){await navigator.clipboard.writeText(d.content);toast(ext.toUpperCase()+' ‚Üí Clipboard')}
  else toast(ext.toUpperCase()+' nicht verf√ºgbar','err')
}catch(e){toast('Fehler: '+e.message,'err')}}
async function downloadJobZip(){if(!aJobId)return;try{
  toast('ZIP wird erstellt‚Ä¶');const resp=await fetch(B+'/api/jobs/'+aJobId+'/download-zip');
  if(!resp.ok){const e=await resp.json().catch(()=>({}));toast('ZIP Fehler: '+(e.detail||'Unbekannt'),'err');return}
  const blob=await resp.blob();const a=document.createElement('a');
  const cd=resp.headers.get('content-disposition')||'';const m=cd.match(/filename="([^"]+)"/);const fn=m?m[1]:aJobId+'_all.zip';
  a.href=URL.createObjectURL(blob);a.download=fn;a.click();URL.revokeObjectURL(a.href);
  toast('ZIP heruntergeladen')}catch(e){toast('ZIP Fehler: '+e.message,'err')}}
async function exportProject(){if(!aJobId)return;try{
  const resp=await fetch(B+'/api/jobs/'+aJobId+'/project-export');
  if(!resp.ok){const e=await resp.json().catch(()=>({}));toast('Export Fehler: '+(e.detail||'Unbekannt'),'err');return}
  const d=await resp.json();
  const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=aJobId+'_project.json';a.click();
  toast('Project exportiert')}catch(e){toast('Export Fehler: '+e.message,'err')}}

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ
async function loadStats(jid){try{const s=await(await fetch(B+'/api/jobs/'+jid+'/stats')).json();
const p=s.processing||{};
const procTags=Object.entries(p).filter(([k,v])=>k!=='bpm').map(([k,v])=>
  `<span style="color:${v?'var(--accent)':'var(--dim)'}">${v?'‚úì':'‚úó'} ${k}</span>`
).join(' ');
document.getElementById('statsGrid').innerHTML=[
sv(s.total_segments,'Segments'),sv(s.total_words,'W√∂rter'),sv(s.total_chars,'Zeichen'),
sv(fmt(s.duration_sec),'Dauer'),sv(s.avg_cps.toFixed(1),'‚àÖ CPS'),
sv(s.max_cps.toFixed(1),'Max CPS',s.max_cps>25),sv(s.min_cps.toFixed(1),'Min CPS'),
sv(s.avg_segment_duration.toFixed(2)+'s','‚àÖ Seg-Dauer'),
sv((s.avg_confidence*100).toFixed(0)+'%','‚àÖ Confidence'),
sv(s.segments_with_words,'Word-TS'),sv(s.segments_needing_review,'‚ö† Review',s.segments_needing_review>0),
sv(s.gaps,'Gaps',s.gaps>0),sv(s.overlaps,'Overlaps',s.overlaps>0),sv(s.pinned,'üìå Pinned'),
s.bpm>0?sv(s.bpm.toFixed(1),'‚ô© BPM'):'',
].join('')+
(procTags?`<div style="grid-column:1/-1;padding:6px 0;font-size:.7rem;border-top:1px solid var(--border);margin-top:4px">${procTags}</div>`:'')
}catch(e){}}
function sv(v,l,w){return`<div class="stat"><div class="stat-val${w?' warn':''}">${v}</div><div class="stat-label">${l}</div></div>`}

// ‚îÄ‚îÄ Dictionary ‚îÄ‚îÄ
async function loadDict(){try{const d=await(await fetch(B+'/api/dictionary')).json();
const el=document.getElementById('dictList');el.innerHTML='';
(d.entries||[]).forEach((e,i)=>{addDictUI(e.wrong,e.correct)})}catch(e){}}
function addDictRow(){addDictUI('','')}
function addDictUI(w,c){const el=document.getElementById('dictList');
const div=document.createElement('div');div.className='dict-row';
div.innerHTML=`<input placeholder="Falsch" value="${esc(w)}"><span style="color:var(--dim)">‚Üí</span><input placeholder="Korrekt" value="${esc(c)}"><button class="btn-s btn-sm" onclick="this.parentElement.remove()" title="Eintrag entfernen">‚úï</button>`;
el.appendChild(div)}
async function saveDict(){const rows=document.querySelectorAll('.dict-row');const entries=[];
rows.forEach(r=>{const inputs=r.querySelectorAll('input');if(inputs[0].value&&inputs[1].value)entries.push({wrong:inputs[0].value,correct:inputs[1].value})});
try{await fetch(B+'/api/dictionary',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(entries)});toast(entries.length+' gespeichert')}catch(e){toast('Err','err')}}

// ‚îÄ‚îÄ Report ‚îÄ‚îÄ
async function loadRep(jid){try{const d=await(await fetch(B+'/api/jobs/'+jid+'/report')).json();document.getElementById('repC').textContent=JSON.stringify(d,null,2)}catch(e){document.getElementById('repC').textContent='N/A'}}

// ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ
function stab(t){document.querySelectorAll('.tab').forEach(e=>e.classList.toggle('on',e.dataset.tab===t));
['tSeg','tStats','tRhyme','tQuick','tDict','tRep'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none'});
const map={seg:'tSeg',stats:'tStats',rhyme:'tRhyme',quick:'tQuick',dict:'tDict',rep:'tRep'};
const target=document.getElementById(map[t]);if(target)target.style.display='block'}

// ‚îÄ‚îÄ Help Modal ‚îÄ‚îÄ
function toggleHelp(){const m=document.getElementById('helpModal');m.classList.toggle('open')}

// ‚îÄ‚îÄ AI Chat ‚îÄ‚îÄ
let aiOk=false,chatBusy=false;
async function checkAI(){try{const r=await(await fetch(B+'/api/ai/health')).json();aiOk=r.available;
const btn=document.getElementById('chatBtn');btn.classList.toggle('disabled',!aiOk);
const label=r.model+(r.reasoning?' ‚ö°':'');
document.getElementById('aiModel').textContent=label;
if(!aiOk)document.getElementById('chatWelcome').innerHTML='<div style="font-size:1.5rem;margin-bottom:6px">‚ö†Ô∏è</div><b>AI nicht konfiguriert</b><br>Setze <code>AI_MODEL</code> + API-Key in <code>.env</code><br><code>AI_MODEL=openai:gpt-5.2</code><br><code>OPENAI_API_KEY=sk-...</code>'}catch(e){}}

function toggleChat(){if(!aiOk&&!document.getElementById('chatPanel').classList.contains('open'))return;
const p=document.getElementById('chatPanel');p.classList.toggle('open');
if(p.classList.contains('open')){loadChatHist();document.getElementById('chatIn').focus()}}

async function loadChatHist(){if(!aJobId)return;try{const r=await fetch(B+'/api/ai/chat/'+aJobId);
if(r.ok){const txt=await r.text();if(txt.trim())renderChatMsgs(txt)}}catch(e){}}

function renderChatMsgs(text){const el=document.getElementById('chatMsgs');
const lines=text.split('\n').filter(l=>l.length>1);
const msgs=lines.map(j=>JSON.parse(j)).filter(m=>m.content&&m.content!=='__SEGMENTS_UPDATED__');
if(!msgs.length)return;
document.getElementById('chatWelcome').style.display='none';
// Deduplicate by timestamp
for(const m of msgs){const id='cm-'+m.timestamp;
let div=document.getElementById(id);if(!div){div=document.createElement('div');div.id=id;div.className='chat-msg '+m.role;el.appendChild(div)}
div.innerHTML=m.role==='user'?esc(m.content):renderMd(m.content)}
el.scrollTop=el.scrollHeight}

function renderMd(text){
// Simple markdown: **bold**, `code`, ```blocks```, lists, paragraphs
text=text.replace(/```(\w*)\n([\s\S]*?)```/g,'<pre><code>$2</code></pre>')
.replace(/`([^`]+)`/g,'<code>$1</code>')
.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>')
.replace(/\*([^*]+)\*/g,'<em>$1</em>');
// Split paragraphs
return text.split('\n\n').map(p=>{
  p=p.trim();if(!p)return'';
  if(p.startsWith('<pre>'))return p;
  if(p.startsWith('- ')||p.startsWith('* '))return'<ul>'+p.split('\n').map(l=>'<li>'+l.replace(/^[-*] /,'')+'</li>').join('')+'</ul>';
  if(/^\d+\. /.test(p))return'<ol>'+p.split('\n').map(l=>'<li>'+l.replace(/^\d+\. /,'')+'</li>').join('')+'</ol>';
  return'<p>'+p.replace(/\n/g,'<br>')+'</p>'
}).join('')}

async function sendChat(){if(chatBusy||!aJobId)return;const inp=document.getElementById('chatIn');
const msg=inp.value.trim();if(!msg)return;inp.value='';inp.disabled=true;chatBusy=true;
document.getElementById('chatSend').disabled=true;
try{await streamChat({prompt:msg})}finally{inp.disabled=false;chatBusy=false;
document.getElementById('chatSend').disabled=false;inp.focus()}}

async function sendCmd(cmd){if(chatBusy||!aJobId)return;chatBusy=true;
document.querySelectorAll('.chat-cmd').forEach(b=>b.disabled=true);
let extra='';
if(cmd==='translate'){extra=prompt('Zielsprache:','English');if(!extra){chatBusy=false;document.querySelectorAll('.chat-cmd').forEach(b=>b.disabled=false);return}}
try{await streamChat({prompt:'',command:cmd,target_language:extra||'English'})}
finally{chatBusy=false;document.querySelectorAll('.chat-cmd').forEach(b=>b.disabled=false)}}

async function streamChat(body){const el=document.getElementById('chatMsgs');
document.getElementById('chatWelcome').style.display='none';
// Add typing indicator
const typing=document.createElement('div');typing.className='chat-typing';typing.textContent='Denkt nach';el.appendChild(typing);el.scrollTop=el.scrollHeight;
try{const r=await fetch(B+'/api/ai/chat/'+aJobId,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
if(!r.ok)throw new Error('HTTP '+r.status);
const reader=r.body.getReader();const dec=new TextDecoder();let text='';
while(true){const{done,value}=await reader.read();if(done)break;
text+=dec.decode(value);
// Remove typing indicator on first chunk
if(typing.parentElement)typing.remove();
renderChatMsgs(text);}}catch(e){toast('AI: '+e.message,'err')}
finally{if(typing.parentElement)typing.remove();
// Check if segments were updated
if(aJobId)loadSegs(aJobId)}}

async function clearChat(){if(!aJobId)return;if(!confirm('Chat-Verlauf loeschen?'))return;
try{await fetch(B+'/api/ai/chat/'+aJobId,{method:'DELETE'});
const el=document.getElementById('chatMsgs');el.innerHTML='';
document.getElementById('chatWelcome').style.display='block';toast('Chat geloescht')}catch(e){}}

// ‚îÄ‚îÄ Reference Text Correction ‚îÄ‚îÄ
let _refText='',_refFilename='‚Äî';
function onRefFileSelected(inp){
  if(!inp.files||!inp.files[0])return;
  const f=inp.files[0];
  if(f.size>1048576){toast('Datei zu gro√ü (max 1MB)','err');inp.value='';return}
  _refFilename=f.name;
  document.getElementById('refFileName').textContent=f.name;
  const reader=new FileReader();
  reader.onload=e=>{_refText=e.target.result;document.getElementById('refDryRunBtn').disabled=false};
  reader.readAsText(f,'UTF-8');
}
async function pasteRefText(){
  try{const t=await navigator.clipboard.readText();
    if(!t||!t.trim()){toast('Zwischenablage leer','err');return}
    _refText=t;_refFilename='clipboard';
    document.getElementById('refFileName').textContent='üìã Clipboard ('+t.split('\n').length+' Zeilen)';
    document.getElementById('refDryRunBtn').disabled=false;
    toast('Referenztext eingef√ºgt');
  }catch(e){toast('Clipboard nicht verf√ºgbar','err')}}

async function startRefCorrect(apply){
  if(!aJobId||!_refText){toast('Referenztext fehlt','err');return}
  const el=document.getElementById('chatMsgs');
  document.getElementById('chatWelcome').style.display='none';
  try{
    const r=await fetch(B+'/api/ai/chat/'+aJobId+'/refcorrect',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({reference_text:_refText,filename:_refFilename,apply})});
    if(!r.ok){const e=await r.json();toast(e.detail||'Fehler','err');return}
    const data=await r.json();
    if(!apply){
      // Dry-run: show diff
      _showRefDiff(data);
    }else{
      // Applied
      _showRefApplied(data);
      if(aJobId)loadSegs(aJobId);
    }
  }catch(e){toast('Ref-Korrektur: '+e.message,'err')}}

function _showRefDiff(data){
  const el=document.getElementById('chatMsgs');
  const div=document.createElement('div');div.className='ref-diff';
  if(!data.changes||!data.changes.length){
    div.innerHTML='<div class="ref-diff-head">üìÑ Referenz-Korrektur</div><p style="color:var(--dim);font-size:.72rem">Keine √Ñnderungen n√∂tig ‚Äî Texte stimmen √ºberein.</p>';
    el.appendChild(div);el.scrollTop=el.scrollHeight;return}
  let html='<div class="ref-diff-head">üìÑ Referenz-Korrektur ‚Äî Dry Run</div>';
  html+='<div class="ref-diff-summary">'+data.changes.length+' von '+data.total_segments+' Segmenten werden ge√§ndert ¬∑ '+data.unchanged+' unver√§ndert ¬∑ '+data.total_ref_lines+' Referenzzeilen</div>';
  for(const c of data.changes){
    html+='<div class="ref-diff-item">';
    html+='<div class="seg-num">#'+(c.index+1)+'</div>';
    html+='<div class="old-text">'+esc(c.old_text)+'</div>';
    html+='<div class="new-text">‚Üí '+esc(c.new_text)+'</div>';
    html+='</div>';
  }
  html+='<div class="ref-diff-actions">';
  html+='<button class="btn-s" onclick="this.closest(\'.ref-diff\').remove()" title="Vorgeschlagene Korrekturen verwerfen">‚úï Verwerfen</button>';
  html+='<button class="btn" onclick="applyRefCorrect()" title="Alle Korrekturen auf Segmente anwenden">‚úì Anwenden ('+data.changes.length+' √Ñnderungen)</button>';
  html+='</div>';
  div.innerHTML=html;
  el.appendChild(div);el.scrollTop=el.scrollHeight;
}

function _showRefApplied(data){
  const el=document.getElementById('chatMsgs');
  const div=document.createElement('div');div.className='chat-msg model';
  div.innerHTML='<strong>‚úì Referenz-Korrektur angewendet</strong><br>'+
    (data.changes?data.changes.length:0)+' Segmente aktualisiert.';
  el.appendChild(div);el.scrollTop=el.scrollHeight;
}

async function applyRefCorrect(){
  // Remove the diff preview
  document.querySelectorAll('.ref-diff').forEach(e=>e.remove());
  await startRefCorrect(true);
}

// ‚îÄ‚îÄ Segment Merge ‚îÄ‚îÄ
async function startMerge(dryRun){
  if(!aJobId){toast('Kein Job geladen','err');return}
  const el=document.getElementById('chatMsgs');
  document.getElementById('chatWelcome').style.display='none';
  if(dryRun){
    const loading=document.createElement('div');loading.className='chat-typing';loading.id='mergeLoading';
    loading.textContent='Merge-Analyse l√§uft';el.appendChild(loading);el.scrollTop=el.scrollHeight;
  }
  try{
    const r=await fetch(B+'/api/ai/segments/'+aJobId+'/merge',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({dry_run:dryRun})});
    const ld=document.getElementById('mergeLoading');if(ld)ld.remove();
    if(!r.ok){const e=await r.json();toast(e.detail||'Fehler','err');return}
    const data=await r.json();
    if(dryRun){
      _showMergeDiff(data);
    }else{
      _showMergeApplied(data);
      if(aJobId)loadSegs(aJobId);
    }
  }catch(e){
    const ld=document.getElementById('mergeLoading');if(ld)ld.remove();
    toast('Merge: '+e.message,'err');
  }
}

function _fmtTime(s){
  const m=Math.floor(s/60),sec=(s%60).toFixed(2);
  return m+':'+sec.padStart(5,'0');
}

function _showMergeDiff(data){
  const el=document.getElementById('chatMsgs');
  const div=document.createElement('div');div.className='merge-diff';
  if(!data.candidates||!data.candidates.length){
    div.innerHTML='<div class="merge-diff-head">üîó Segment-Merge</div>'+
      '<p style="color:var(--dim);font-size:.72rem">Keine Merge-Kandidaten gefunden.</p>';
    el.appendChild(div);el.scrollTop=el.scrollHeight;return;
  }
  const merges=data.candidates.filter(c=>c.decision==='MERGE');
  const skips=data.candidates.filter(c=>c.decision==='SKIP');
  let html='<div class="merge-diff-head">üîó Segment-Merge ‚Äî Dry Run</div>';
  html+='<div class="merge-diff-summary">'+data.candidates.length+' Kandidaten ¬∑ '+
    merges.length+' Merges ¬∑ '+skips.length+' √ºbersprungen ¬∑ '+
    data.total_segments+' ‚Üí '+data.result_segments+' Segmente</div>';
  for(const c of data.candidates){
    const isMerge=c.decision==='MERGE';
    html+='<div class="merge-item'+(isMerge?'':' skip')+'">';
    html+='<div class="m-head">';
    html+='<span class="m-badge '+(isMerge?'ok':'no')+'">'+c.decision+'</span>';
    html+='#'+(c.index_a+1)+'+#'+(c.index_b+1)+' ';
    html+='gap='+c.gap_ms.toFixed(0)+'ms ';
    html+='cps='+c.cps_after.toFixed(1);
    html+='</div>';
    html+='<div class="m-texts">';
    html+='<span class="m-old">'+esc(c.text_a)+'</span> + <span class="m-old">'+esc(c.text_b)+'</span>';
    html+='<br><span class="m-arrow">‚Üí</span> <span class="m-new">'+esc(c.merged_text)+'</span>';
    html+='</div>';
    if(c.skip_reason) html+='<div class="m-reason">'+esc(c.skip_reason)+'</div>';
    html+='</div>';
  }
  if(merges.length>0){
    html+='<div class="merge-actions">';
    html+='<button class="btn-s" onclick="this.closest(\'.merge-diff\').remove()" title="Vorgeschlagene Merges verwerfen">‚úï Verwerfen</button>';
    html+='<button class="btn" onclick="applyMerge()" title="Alle Merges auf Segmente anwenden">‚úì '+merges.length+' Merges anwenden</button>';
    html+='</div>';
  }
  div.innerHTML=html;
  el.appendChild(div);el.scrollTop=el.scrollHeight;
}

function _showMergeApplied(data){
  const el=document.getElementById('chatMsgs');
  const div=document.createElement('div');div.className='chat-msg model';
  div.innerHTML='<strong>‚úì Merge angewendet</strong><br>'+
    (data.changes||0)+' Segmente zusammengef√ºhrt. Neue Gesamtzahl: '+(data.new_total||'?')+'.';
  el.appendChild(div);el.scrollTop=el.scrollHeight;
}

async function applyMerge(){
  document.querySelectorAll('.merge-diff').forEach(e=>e.remove());
  await startMerge(false);
}

// ‚îÄ‚îÄ Keyboard ‚îÄ‚îÄ
document.addEventListener('keydown',e=>{
if(e.key==='F1'){e.preventDefault();toggleHelp();return}
// Close modals on Escape (unless in special modes ‚Äî handled by new handler)
if(e.key==='Escape'&&!tttActive&&!fskActive){
  const se=document.getElementById('subEditorBg');if(se.classList.contains('open')){closeSubEditor();return}
  const tm=document.getElementById('tagModal');if(tm.classList.contains('open')){tm.classList.remove('open');return}
  const lb=document.getElementById('libModal');if(lb.classList.contains('open')){lb.classList.remove('open');return}
  const m=document.getElementById('helpModal');if(m.classList.contains('open')){m.classList.remove('open');return}
  const c=document.getElementById('chatPanel');if(c.classList.contains('open')){c.classList.remove('open');return}
}
// Input fields: only undo/redo
if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'){if(e.ctrlKey&&e.key==='z'){e.preventDefault();doUndo()}if(e.ctrlKey&&e.key==='y'){e.preventDefault();doRedo()}return}
// Skip basic shortcuts when in special modes
if(tttActive||fskActive)return;
if(e.code==='Space'){e.preventDefault();togglePlay()}
if(e.ctrlKey&&e.key==='z'){e.preventDefault();doUndo()}
if(e.ctrlKey&&e.key==='y'){e.preventDefault();doRedo()}
if(e.ctrlKey&&e.key==='f'){e.preventDefault();document.getElementById('srchIn').focus()}
if(e.key==='ArrowLeft'){e.preventDefault();skipTo(-2)}
if(e.key==='ArrowRight'){e.preventDefault();skipTo(2)}})

// ‚îÄ‚îÄ Rhyme Scheme Analysis ‚îÄ‚îÄ
async function analyzeRhyme(){
if(!aJobId)return;
const el=document.getElementById('rhymeScheme');
const stats=document.getElementById('rhymeStats');
const map=document.getElementById('rhymeMap');
el.innerHTML='<div style="color:var(--dim);font-size:.75rem">Analysiere...</div>';
try{
const r=await(await fetch(B+'/api/jobs/'+aJobId+'/rhyme')).json();
// Scheme visualization
const colors=['#00e5a0','#00b8ff','#ff6b9d','#ffd700','#b8a0ff','#ff8c42','#42f5e0','#ff4242',
  '#a0ff60','#60a0ff','#ff60a0','#ffa060','#60ffa0','#a060ff','#ff6060','#60ff60'];
const labelColor={};let ci=0;
r.labels.forEach(l=>{if(!labelColor[l])labelColor[l]=colors[ci++%colors.length]});
// Get segment texts
const lines=cSegs.map(s=>s.text);
let schH='<div class="rhyme-grid">';
r.labels.forEach((l,i)=>{
  const txt=lines[i]||'';
  const endWord=txt.trim().split(/\s+/).pop()||'';
  const c=labelColor[l]||'var(--dim)';
  schH+=`<div class="rhyme-line" style="border-color:${c}30" onclick="playSeg(${i})" title="${esc(txt)}">
    <span class="rhyme-label" style="color:${c}">${l}</span>
    <span class="rhyme-text">${esc(txt.slice(0,45))}</span>
    <span class="rhyme-end" style="color:${c}">${esc(endWord)}</span></div>`});
schH+='</div>';
el.innerHTML=schH;
// Stats
let stH=`<div style="display:flex;flex-wrap:wrap;gap:8px;font-size:.7rem;margin-top:6px">`;
stH+=`<span>Muster: <b style="font-family:var(--mono);letter-spacing:1px">${esc(r.scheme.slice(0,60))}${r.scheme.length>60?'...':''}</b></span>`;
stH+=`<span>Dichte: <b style="color:var(--accent)">${(r.density*100).toFixed(0)}%</b></span>`;
stH+=`<span>Paare: <b>${r.pairs.length}</b></span>`;
if(r.internal.length)stH+=`<span style="color:#b8a0ff">Internal: <b>${r.internal.length}</b></span>`;
if(r.multi.length)stH+=`<span style="color:#ffd700">Multi: <b>${r.multi.length}</b></span>`;
stH+='</div>';
stats.innerHTML=stH;
// Pairs
let pairsH='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px">';
r.pairs.slice(0,30).forEach(p=>{
  pairsH+=`<span class="rhyme-pair end" title="Score: ${p.score}">${esc(p.words[0])} ‚Üî ${esc(p.words[1])}</span>`});
r.internal.slice(0,15).forEach(p=>{
  pairsH+=`<span class="rhyme-pair internal" title="Internal">${esc(p.words[0])} ‚Üî ${esc(p.words[1])}</span>`});
r.multi.slice(0,10).forEach(p=>{
  pairsH+=`<span class="rhyme-pair multi" title="Multi-syllabic">${esc(p.words[0])} ‚Üî ${esc(p.words[1])}</span>`});
pairsH+='</div>';
map.innerHTML=pairsH;
toast(`Reimschema: ${r.scheme.slice(0,20)}... (${r.pairs.length} Paare, ${(r.density*100).toFixed(0)}%)`)
}catch(e){el.innerHTML=`<div style="color:var(--danger)">${e.message}</div>`}}

// ‚îÄ‚îÄ Auto BPM ‚Üí CPS/MaxChars ‚îÄ‚îÄ
async function autoBpmParams(){
  const btn=document.getElementById('btnAutoBpm');
  const fmt=document.getElementById('sA')?.checked?'ass':'srt';
  // If we have a loaded job, detect BPM from its audio
  if(aJobId){
    btn.disabled=true;btn.textContent='‚è≥';
    try{
      const r=await(await fetch(B+'/api/jobs/'+aJobId+'/detect-bpm',{method:'POST'})).json();
      const p=fmt==='ass'?r.ass:r.srt;
      document.getElementById('sC').value=p.cps;
      document.getElementById('sMC').value=p.max_chars_per_line;
      toast(`BPM ${r.bpm}: CPS=${p.cps}, Chars=${p.max_chars_per_line} (${p.rationale})`);
    }catch(e){
      // Fallback: ask user for BPM manually
      const bpm=parseFloat(prompt('BPM konnte nicht erkannt werden.\nBPM manuell eingeben:','120'));
      if(bpm>0){
        try{
          const r=await(await fetch(B+'/api/bpm-params?bpm='+bpm+'&format='+fmt)).json();
          document.getElementById('sC').value=r.cps;
          document.getElementById('sMC').value=r.max_chars_per_line;
          toast(`BPM ${bpm}: CPS=${r.cps}, Chars=${r.max_chars_per_line}`);
        }catch(e2){toast('BPM Params: '+e2.message,'err')}
      }
    }finally{btn.disabled=false;btn.textContent='‚ö°BPM'}
  }else{
    const bpm=parseFloat(prompt('BPM eingeben:','120'));
    if(!bpm||bpm<=0)return;
    btn.disabled=true;btn.textContent='‚è≥';
    try{
      const r=await(await fetch(B+'/api/bpm-params?bpm='+bpm+'&format='+fmt)).json();
      document.getElementById('sC').value=r.cps;
      document.getElementById('sMC').value=r.max_chars_per_line;
      toast(`BPM ${bpm}: CPS=${r.cps}, Chars=${r.max_chars_per_line}`);
    }catch(e){toast('BPM Params: '+e.message,'err')}
    finally{btn.disabled=false;btn.textContent='‚ö°BPM'}
  }
}

// ‚îÄ‚îÄ Auto CPS Fix ‚îÄ‚îÄ
async function doAutoFixCps(){
if(!aJobId)return;
const maxCps=parseFloat(prompt('Max CPS Limit:','22'))||22;
try{
toast('CPS Fix l√§uft...');
const r=await(await fetch(B+'/api/jobs/'+aJobId+'/auto-fix-cps?max_cps='+maxCps,{method:'POST'})).json();
loadSegs(aJobId);
toast(`CPS Fix: ${r.segments_split} gesplittet, max CPS ${r.max_cps_before}‚Üí${r.max_cps_after}`)
}catch(e){toast('CPS Fix: '+e.message,'err')}}

// ‚îÄ‚îÄ Karaoke HTML Export ‚îÄ‚îÄ
async function doKaraokeHtml(theme){
if(!aJobId)return;
try{
toast('Karaoke HTML generieren...');
const url=B+'/api/jobs/'+aJobId+'/karaoke-html?theme='+theme+'&embed_audio=false';
const resp=await fetch(url,{method:'POST'});
if(!resp.ok)throw new Error(await resp.text());
const blob=await resp.blob();
const a=document.createElement('a');a.href=URL.createObjectURL(blob);
a.download=(aJobId+'_karaoke_'+theme+'.html');a.click();URL.revokeObjectURL(a.href);
toast('Karaoke HTML heruntergeladen ('+theme+')')
}catch(e){toast('Karaoke: '+e.message,'err')}}

// ‚îÄ‚îÄ Export Presets ‚îÄ‚îÄ
async function applyPreset(name){
if(!aJobId)return;
try{
toast('Export Preset: '+name+'...');
const r=await(await fetch(B+'/api/jobs/'+aJobId+'/export-preset/'+name,{method:'POST'})).json();
loadSegs(aJobId);
toast(`Preset "${r.name}": ${r.exported.join(', ')}`)
}catch(e){toast('Preset: '+e.message,'err')}}

// ‚îÄ‚îÄ Gap Scanner ‚îÄ‚îÄ
function doGapScan(){
if(!cSegs.length)return;
const results=[];
for(let i=0;i<cSegs.length-1;i++){
  const gap=cSegs[i+1].start-cSegs[i].end;
  if(gap>2.0){results.push({type:'gap',idx:i,value:gap,
    desc:`${fmt(cSegs[i].end)} ‚Üí ${fmt(cSegs[i+1].start)}: ${gap.toFixed(1)}s L√ºcke`})}
  if(gap<-0.05){results.push({type:'overlap',idx:i,value:Math.abs(gap),
    desc:`#${i+1}‚Üî#${i+2}: ${Math.abs(gap).toFixed(2)}s Overlap`})}}
// Also check first/last
if(cSegs[0].start>3){results.unshift({type:'gap',idx:-1,value:cSegs[0].start,
  desc:`Start: ${cSegs[0].start.toFixed(1)}s Vorlauf`})}
document.getElementById('gapResults').style.display='block';
const el=document.getElementById('gapList');
if(!results.length){el.innerHTML='<div style="color:var(--accent);font-size:.75rem;padding:8px">‚úÖ Keine Probleme gefunden</div>';
toast('Keine Gaps/Overlaps');return}
el.innerHTML=results.map(r=>`<div class="gap-item ${r.type}" onclick="${r.idx>=0?'playSeg('+r.idx+')':''}">
  <span class="gap-badge ${r.type==='gap'?'warn':'err'}">${r.type==='gap'?'GAP':'OVL'}</span>
  <span>${esc(r.desc)}</span>
  <span style="margin-left:auto;font-family:var(--mono);font-size:.65rem;color:var(--dim)">${r.value.toFixed(2)}s</span>
</div>`).join('');
toast(`${results.length} Probleme: ${results.filter(r=>r.type==='gap').length} Gaps, ${results.filter(r=>r.type==='overlap').length} Overlaps`)}

// ‚îÄ‚îÄ CPS Heatmap ‚îÄ‚îÄ
function doSegHeatmap(){
if(!cSegs.length||!wfDur)return;
document.getElementById('heatmapCard').style.display='block';
const cv=document.getElementById('heatCv');
const rect=cv.parentElement.getBoundingClientRect();
cv.width=rect.width*2;cv.height=120;
const ctx=cv.getContext('2d');ctx.clearRect(0,0,cv.width,cv.height);
// Draw background
ctx.fillStyle='var(--bg3)';ctx.fillRect(0,0,cv.width,cv.height);
// Draw segments as colored bars
for(const s of cSegs){
  const dur=s.end-s.start;
  const cps=dur>0?s.text.length/dur:0;
  const conf=s.confidence||0.5;
  const x1=s.start/wfDur*cv.width;
  const x2=s.end/wfDur*cv.width;
  const w=Math.max(1,x2-x1);
  // CPS color: green‚Üíyellow‚Üíorange‚Üíred
  let color;
  if(cps<15)color='rgba(0,229,160,0.7)';
  else if(cps<20)color='rgba(245,166,35,0.7)';
  else if(cps<25)color='rgba(255,140,0,0.85)';
  else color='rgba(231,76,60,0.9)';
  // Top half: CPS
  ctx.fillStyle=color;
  const h=Math.min(cv.height/2,cps*2);
  ctx.fillRect(x1,cv.height/2-h,w,h);
  // Bottom half: confidence
  const ch=conf*(cv.height/2);
  ctx.fillStyle=conf>=.8?'rgba(0,184,255,0.4)':conf>=.6?'rgba(245,166,35,0.4)':'rgba(231,76,60,0.4)';
  ctx.fillRect(x1,cv.height/2,w,ch)}
// Center line
ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=1;
ctx.beginPath();ctx.moveTo(0,cv.height/2);ctx.lineTo(cv.width,cv.height/2);ctx.stroke();
// Labels
ctx.fillStyle='rgba(255,255,255,0.3)';ctx.font='9px sans-serif';
ctx.fillText('CPS ‚Üë',4,12);ctx.fillText('Conf ‚Üì',4,cv.height-4);
toast('Heatmap: oben=CPS, unten=Confidence')}

function seekHM(ev){
if(!wfDur)return;
const r=ev.currentTarget.getBoundingClientRect();
au.currentTime=(ev.clientX-r.left)/r.width*wfDur}

// ‚îÄ‚îÄ Gap Filler ‚îÄ‚îÄ
async function doFillGaps(){
if(!aJobId)return;
const minGap=parseFloat(prompt('Min Gap (Sekunden):','2'))||2;
try{toast('Gaps f√ºllen...');
const r=await(await fetch(B+'/api/jobs/'+aJobId+'/fill-gaps?min_gap='+minGap+'&fill_text=%E2%99%AA',{method:'POST'})).json();
loadSegs(aJobId);
toast(`${r.gaps_filled} Gaps gef√ºllt, ${r.micro_gaps_merged} Micro-Gaps merged (${r.total_gap_duration}s total)`)
}catch(e){toast('Gap fill: '+e.message,'err')}}

// ‚îÄ‚îÄ Redistribute Timing ‚îÄ‚îÄ
async function doRedistribute(){
if(!aJobId)return;
if(!confirm('Alle Timestamps gleichm√§√üig neu verteilen? (Undo m√∂glich)'))return;
try{toast('Timing wird neu verteilt...');
const r=await(await fetch(B+'/api/jobs/'+aJobId+'/redistribute-timing',{method:'POST'})).json();
loadSegs(aJobId);
toast(`Timing verteilt: ${r.count} Segmente √ºber ${r.duration.toFixed(1)}s`)
}catch(e){toast('Redistribute: '+e.message,'err')}}

// ‚îÄ‚îÄ Text Statistics ‚îÄ‚îÄ
async function doTextStats(){
if(!aJobId)return;
try{toast('Text analysieren...');
const r=await(await fetch(B+'/api/jobs/'+aJobId+'/text-stats')).json();
document.getElementById('textStatsCard').style.display='block';
// Stats grid
document.getElementById('textStatsGrid').innerHTML=[
  sv(r.total_words,'W√∂rter'),sv(r.unique_words,'Unique'),
  sv(r.total_syllables,'Silben'),sv(r.total_lines,'Zeilen'),
  sv(r.avg_words_per_line,'‚àÖ W/Zeile'),sv(r.avg_word_length,'‚àÖ Wortl√§nge'),
  sv(r.avg_syllables_per_word,'‚àÖ Silben/W'),
  sv((r.type_token_ratio*100).toFixed(1)+'%','Wortschatz (TTR)',r.type_token_ratio<0.3),
  sv(r.hapax_legomena,'Einmalw√∂rter'),
  sv((r.flow_score*100).toFixed(0)+'%','Flow Score'),
  sv(fmt(r.reading_time_sec),'Lesezeit'),
].join('');
// Top words
let wH='<div style="font-size:.65rem;color:var(--dim);margin-bottom:4px">Top W√∂rter:</div>';
wH+='<div style="display:flex;flex-wrap:wrap;gap:3px">';
r.top_words.slice(0,25).forEach(w=>{
  const sz=Math.max(10,Math.min(18,8+w.count));
  wH+=`<span style="font-size:${sz}px;padding:1px 5px;border-radius:3px;background:var(--bg3);border:1px solid var(--border);font-family:var(--mono)">${esc(w.word)}<sup style="font-size:8px;color:var(--dim)">${w.count}</sup></span>`});
wH+='</div>';
document.getElementById('textStatsWords').innerHTML=wH;
// Syllable distribution
let sH='<div style="font-size:.65rem;color:var(--dim);margin-bottom:4px;margin-top:8px">Silbenverteilung:</div>';
sH+='<div style="display:flex;align-items:flex-end;gap:2px;height:40px">';
const maxSyl=Math.max(...Object.values(r.syllable_distribution));
for(const[syl,count]of Object.entries(r.syllable_distribution)){
  const h=count/maxSyl*36;
  sH+=`<div style="display:flex;flex-direction:column;align-items:center;gap:1px">
    <div style="width:20px;height:${h}px;background:var(--accent);border-radius:2px 2px 0 0;opacity:.7"></div>
    <span style="font-size:8px;color:var(--dim)">${syl}</span></div>`}
sH+='</div>';
document.getElementById('textStatsSyl').innerHTML=sH;
toast(`Text: ${r.total_words} W√∂rter, TTR ${(r.type_token_ratio*100).toFixed(0)}%, Flow ${(r.flow_score*100).toFixed(0)}%`)
}catch(e){toast('Stats: '+e.message,'err')}}

// ‚îÄ‚îÄ Remove Short ‚îÄ‚îÄ
async function doRemoveShort(){
if(!aJobId)return;
try{const r=await(await fetch(B+'/api/jobs/'+aJobId+'/segments/remove-short',{method:'POST'})).json();
loadSegs(aJobId);toast(`${r.removed} kurze Segmente entfernt, ${r.remaining} √ºbrig`)
}catch(e){toast('Remove: '+e.message,'err')}}

// ‚îÄ‚îÄ Normalize Text ‚îÄ‚îÄ
async function doNormalizeText(){
if(!aJobId)return;
try{const r=await(await fetch(B+'/api/jobs/'+aJobId+'/segments/normalize-text',{method:'POST'})).json();
loadSegs(aJobId);toast(`${r.changed}/${r.total} Segmente normalisiert`)
}catch(e){toast('Normalize: '+e.message,'err')}}

// ‚îÄ‚îÄ Export All ‚îÄ‚îÄ
async function doExportAll(){
if(!aJobId)return;
try{toast('Alle Formate exportieren...');
await applyPreset('karaoke');
await doKaraokeHtml('dark');
toast('Alle Formate exportiert!')}catch(e){toast('Export: '+e.message,'err')}}

// ‚îÄ‚îÄ Library ‚îÄ‚îÄ
let libPage=0,libST=null,libPerPage=20;
function toggleLibrary(){const m=document.getElementById('libModal');m.classList.toggle('open');if(m.classList.contains('open')){libPage=0;loadLibrary()}}
async function loadLibrary(){
const q=document.getElementById('libSearch').value.trim();
try{const r=await(await fetch(B+`/api/library?limit=${libPerPage}&offset=${libPage*libPerPage}&q=${encodeURIComponent(q)}`)).json();
const el=document.getElementById('libList');el.innerHTML='';
document.getElementById('libCount').textContent=`${r.total} Eintr√§ge`;
document.getElementById('libPrev').disabled=libPage===0;
document.getElementById('libNext').disabled=(libPage+1)*libPerPage>=r.total;
if(!r.items.length){el.innerHTML='<div class="lib-empty">Keine Transcriptions gefunden</div>';return}
for(const it of r.items){
const d=new Date(it.created_at);const ds=d.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'2-digit'});
const dur=it.duration_sec>0?fmt(it.duration_sec):'';
const conf=it.avg_confidence>0?`${(it.avg_confidence*100).toFixed(0)}%`:'';
const rev=it.needs_review>0?`<span class="li-badge rev">‚ö† ${it.needs_review}</span>`:'';
const bpm=it.bpm>0?`<span style="color:var(--accent)">${it.bpm.toFixed(0)}‚ô©</span>`:'';
const div=document.createElement('div');div.className='lib-item';
div.innerHTML=`<div class="li-title" title="${esc(it.source_filename)}">${esc(it.title)}</div>
<div class="li-meta">${esc(it.backend)} ¬∑ ${esc(it.language||'?')} ¬∑ ${dur} ${conf} ${bpm} ${rev} ¬∑ ${ds}</div>
<button class="li-del" onclick="event.stopPropagation();delLib('${it.id}','${escAttr(it.title)}')" title="L√∂schen">üóë</button>`;
div.onclick=()=>openLib(it);el.appendChild(div)}
}catch(e){toast('Library: '+e.message,'err')}}

async function openLib(item){
toggleLibrary();
// Strategy 1: If job still in active session, use native selJob
if(item.job_id){
  try{const j=await(await fetch(B+'/api/jobs/'+item.job_id)).json();
  if(j.status==='completed'){selJob(item.job_id);toast(`"${item.title}" geladen`);return}}catch(e){}}
// Strategy 2: Reconstruct UI from library record
try{const r=await(await fetch(B+'/api/library/'+item.id)).json();
_persistSession({lib_id:item.id,job_id:r.job_id||null});
await loadFromLibrary(r)}catch(e){toast('Fehler: '+e.message,'err')}}

async function loadFromLibrary(r){
// Show editor section, hide empty state
document.getElementById('es').style.display='none';
const jd=document.getElementById('jd');jd.style.display='flex';jd.style.flexDirection='column';jd.style.gap='12px';

// Header info
document.getElementById('dI').textContent='üìö';
document.getElementById('dF').textContent=r.source_filename||r.title;
document.getElementById('dS').textContent='library';
document.getElementById('dP').style.width='100%';
const st=document.getElementById('dSt');
st.textContent=`${r.backend} ¬∑ ${r.language||'auto'} ¬∑ ${r.segments_count} seg`;
st.style.color='var(--dim)';

// Audio player ‚Äî try job output dir, then uploads
if(r.job_id&&r.source_filename){
  au.src=B+'/data/output/'+r.job_id+'/'+r.source_filename;
  au.onerror=()=>{au.src=B+'/data/uploads/'+r.source_filename};
  document.getElementById('playerSec').style.display='block';
  au.onloadedmetadata=()=>updPT();
  au.ontimeupdate=()=>{updPT();hlSeg();updKaraoke()}
}

// Segments ‚Äî parse segments_json from library
if(r.segments_json){
  try{
    cSegs=JSON.parse(r.segments_json);
    // reconstruct aJobId for segment editing if job output exists
    aJobId=r.job_id||null;
    renderSegs();drawMM();
    // Try loading waveform if job output exists
    if(r.job_id){loadWF(r.job_id).catch(()=>{})}
  }catch(e){console.warn('Segments parse error:',e)}
}

// Downloads section
const dlSec=document.getElementById('dlSec');
if(r.job_id){
  dlSec.style.display='block';
  document.getElementById('zipDl').href=B+'/api/jobs/'+r.job_id+'/download-zip';
  let dlH='';
  // Reconstruct download links from job output directory
  const stem=r.source_filename?r.source_filename.replace(/\.[^.]+$/,''):'output';
  for(const[ext,label]of[['srt','SRT'],['ass','ASS'],['vtt','VTT'],['lrc','LRC'],['txt','TXT']]){
    const fn=stem+'.'+ext;
    dlH+=`<a class="dl" href="${B}/api/jobs/${r.job_id}/download/${fn}" download><span class="x">${ext.toUpperCase()}</span>${label}</a>`}
  dlH+=`<span style="font-size:.65rem;color:var(--dim);margin-left:4px">${r.segments_count} seg ¬∑ ${r.backend} ¬∑ ${r.language||'auto'}${r.has_word_timestamps?' ¬∑ ‚úìwords':''}${r.needs_review>0?` ¬∑ <b style="color:var(--warn)">${r.needs_review}‚ö†</b>`:''}</span>`;
  document.getElementById('dlBtns').innerHTML=dlH
}else{dlSec.style.display='none'}

// Editor section
document.getElementById('edSec').style.display='block';

// Report tab ‚Äî show metadata + confidence summary
const repEl=document.getElementById('repC');
if(repEl){
  let repText=`üìö Library: ${r.title}\n`;
  repText+=`${'‚îÄ'.repeat(50)}\n`;
  repText+=`Backend: ${r.backend}\nLanguage: ${r.language||'auto'}\n`;
  repText+=`Duration: ${fmt(r.duration_sec)}\nSegments: ${r.segments_count}\n`;
  if(r.bpm>0)repText+=`BPM: ${r.bpm.toFixed(1)}\n`;
  repText+=`Confidence: ${(r.avg_confidence*100).toFixed(1)}%\n`;
  repText+=`Needs Review: ${r.needs_review}\n`;
  repText+=`Word Timestamps: ${r.has_word_timestamps?'‚úì':'‚úó'}\n`;
  repText+=`Created: ${new Date(r.created_at).toLocaleString('de-DE')}\n`;
  if(r.tags&&r.tags.length)repText+=`Tags: ${r.tags.join(', ')}\n`;
  repEl.textContent=repText}

// Stats tab ‚Äî basic info from library data
const statsEl=document.getElementById('statsGrid');
if(statsEl){
  statsEl.innerHTML=[
    sv(r.segments_count,'Segments'),
    sv(fmt(r.duration_sec),'Dauer'),
    sv((r.avg_confidence*100).toFixed(0)+'%','‚àÖ Confidence'),
    sv(r.needs_review,'‚ö† Review',r.needs_review>0),
    r.bpm>0?sv(r.bpm.toFixed(1),'‚ô© BPM'):'',
    sv(r.has_word_timestamps?'‚úì':'‚úó','Word-TS'),
  ].join('')}

// Switch to segments tab
stab('seg');
toast(`"${r.title}" aus Library geladen`)}

async function delLib(id,title){if(!confirm(`"${title}" wirklich l√∂schen?`))return;
try{await fetch(B+'/api/library/'+id,{method:'DELETE'});toast('Gel√∂scht');loadLibrary()}catch(e){toast('Err','err')}}

// ‚îÄ‚îÄ Video Render ‚îÄ‚îÄ
async function startRender(){
const bgFile=document.getElementById('vrBg').files[0];
const audioFile=document.getElementById('vrAudio').files[0];
if(!bgFile){toast('Hintergrund-Datei ausw√§hlen!','err');return}
if(!aJobId){toast('Erst transkribieren!','err');return}
const preset=document.getElementById('vrPreset').value;
const pos=document.getElementById('vrPos').value;
toast('Video-Render startet...');
const fd=new FormData();
fd.append('background_file',bgFile);
fd.append('source_job_id',aJobId);
if(audioFile)fd.append('audio_file',audioFile);
fd.append('options',JSON.stringify({preset,position:pos}));
try{const r=await fetch(B+'/api/render-video',{method:'POST',body:fd});
const j=await r.json();
if(r.ok){toast('Render-Job gestartet: '+j.job_id);
  setTimeout(()=>window.open(B+'/api/render/'+j.job_id+'/download','_blank'),5000)}
else toast(j.detail||'Err','err')
}catch(e){toast('Render: '+e.message,'err')}}

// ‚îÄ‚îÄ Session Persistence ‚îÄ‚îÄ
function _persistSession(s){try{localStorage.setItem('kst-session',JSON.stringify(s))}catch(e){}}
function _clearSession(){try{localStorage.removeItem('kst-session')}catch(e){}}
function clearAll(){
  if(!confirm('Seite vollst√§ndig zur√ºcksetzen? Alle geladenen Daten werden verworfen.'))return;
  // Stop audio
  au.pause();au.removeAttribute('src');au.load();
  // Clear state
  uploaded=[];aJobId=null;wfPeaks=null;wfDur=0;cSegs=[];curFil='all';looping=false;loopSeg=null;
  curMediaId='';curMediaEditable=false;lyricsFile=null;
  // Stop polling
  if(poll){clearInterval(poll);poll=null}
  // Clear session & localStorage
  _clearSession();
  // Reset UI
  document.getElementById('jd').style.display='none';
  document.getElementById('es').style.display='';
  document.getElementById('jl').innerHTML='';
  document.getElementById('kLive').innerHTML='';
  document.getElementById('segL').innerHTML='';
  document.getElementById('segCnt').textContent='';
  // Reset waveform
  const wfC=document.querySelector('.waveform canvas');if(wfC){const cx=wfC.getContext('2d');cx.clearRect(0,0,wfC.width,wfC.height)}
  // Reset lyrics
  document.getElementById('lyLabel').textContent='Lyrics (.txt/.lrc) hochladen';
  document.getElementById('lyHint').textContent='Zeilenstruktur wird f√ºr SRT/ASS √ºbernommen';
  document.getElementById('lyDel').style.display='none';
  document.getElementById('lyOpts').style.display='none';
  // Reset minimap
  const mm=document.getElementById('mm');if(mm)mm.innerHTML='';
  // Refresh
  startPoll();
  toast('Seite zur√ºckgesetzt')}
async function _restoreSession(){
  let s;try{s=JSON.parse(localStorage.getItem('kst-session'))}catch(e){return}
  if(!s)return;
  // Try restoring from active job first
  if(s.job_id){
    try{const j=await(await fetch(B+'/api/jobs/'+s.job_id)).json();
    if(j.status==='completed'){selJob(s.job_id);return}}catch(e){}}
  // Try restoring from library
  if(s.lib_id){
    try{const r=await(await fetch(B+'/api/library/'+s.lib_id)).json();
    await loadFromLibrary(r);return}catch(e){}}
  // If job_id exists but not in active jobs, try library search by job_id
  if(s.job_id){
    try{const r=await(await fetch(B+'/api/library?q=&limit=100')).json();
    const match=r.items.find(it=>it.job_id===s.job_id);
    if(match){const full=await(await fetch(B+'/api/library/'+match.id)).json();
      _persistSession({lib_id:match.id,job_id:s.job_id});
      await loadFromLibrary(full);return}}catch(e){}}
  _clearSession()}

// ‚îÄ‚îÄ Demucs Separation Modal ‚îÄ‚îÄ
let demucsJobId=null;
let demucsPollTimer=null;

async function openDemucsModal(){
  const m=document.getElementById('demucsModal');
  m.classList.add('open');
  document.getElementById('demucsResults').style.display='none';
  document.getElementById('demucsProgress').style.display='none';
  document.getElementById('demucsStartBtn').disabled=false;
  demucsJobId=null;
  // Check availability
  const st=document.getElementById('demucsStatus');
  try{
    const r=await(await fetch(B+'/api/separation/check')).json();
    st.textContent=r.available?'‚úÖ Demucs verf√ºgbar':'‚ùå '+r.message;
    st.style.color=r.available?'var(--ok)':'var(--err)';
    document.getElementById('demucsStartBtn').disabled=!r.available;
  }catch(e){st.textContent='Pr√ºfung fehlgeschlagen';st.style.color='var(--err)'}
  // Load audio file list
  try{
    const r=await(await fetch(B+'/api/separation/audio-files')).json();
    const sel=document.getElementById('demucsFile');
    sel.innerHTML='<option value="">‚Äî Datei w√§hlen ‚Äî</option>';
    for(const f of r.files){
      const o=document.createElement('option');o.value=f.filename;
      o.textContent=f.filename+' ('+_fmtSize(f.size)+')';
      sel.appendChild(o);
    }
  }catch(e){console.warn('Audio files:',e)}
}

function _fmtSize(b){if(b<1024)return b+'B';if(b<1048576)return(b/1024).toFixed(1)+'KB';return(b/1048576).toFixed(1)+'MB'}

function closeDemucsModal(){
  document.getElementById('demucsModal').classList.remove('open');
  if(demucsPollTimer){clearInterval(demucsPollTimer);demucsPollTimer=null}
}

async function startDemucs(){
  const filename=document.getElementById('demucsFile').value;
  if(!filename){toast('Bitte Audio-Datei w√§hlen','err');return}
  const body={
    filename,
    model:document.getElementById('demucsModel').value,
    device:document.getElementById('demucsDevice').value,
    stems:document.getElementById('demucsStemMode').value,
    shifts:parseInt(document.getElementById('demucsShifts').value)||1,
    overlap:0.25,
    mp3:document.getElementById('demucsMp3').checked,
    mp3_bitrate:320,
  };
  document.getElementById('demucsStartBtn').disabled=true;
  document.getElementById('demucsProgress').style.display='block';
  document.getElementById('demucsResults').style.display='none';
  document.getElementById('demucsBar').style.width='5%';
  document.getElementById('demucsStage').textContent='Job wird gestartet...';
  try{
    const r=await(await fetch(B+'/api/separation/start',{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)
    })).json();
    demucsJobId=r.job_id;
    toast('Separation gestartet: '+r.job_id);
    // Poll for progress
    demucsPollTimer=setInterval(()=>pollDemucsJob(r.job_id),1500);
  }catch(e){
    toast('Fehler: '+e.message,'err');
    document.getElementById('demucsStartBtn').disabled=false;
    document.getElementById('demucsProgress').style.display='none';
  }
}

async function pollDemucsJob(jobId){
  try{
    const j=await(await fetch(B+'/api/jobs/'+jobId)).json();
    const bar=document.getElementById('demucsBar');
    const stage=document.getElementById('demucsStage');
    bar.style.width=Math.round(j.progress*100)+'%';
    bar.textContent=Math.round(j.progress*100)+'%';
    stage.textContent=j.stage||'';
    if(j.status==='completed'){
      clearInterval(demucsPollTimer);demucsPollTimer=null;
      document.getElementById('demucsProgress').style.display='none';
      document.getElementById('demucsStartBtn').disabled=false;
      bar.style.width='100%';
      // Load stems
      try{
        const stems=await(await fetch(B+'/api/separation/'+jobId+'/stems')).json();
        showDemucsResults(jobId,stems);
      }catch(e){toast('Stems laden: '+e.message,'err')}
      toast('‚úÖ Separation abgeschlossen!');
    }else if(j.status==='failed'||j.status==='cancelled'){
      clearInterval(demucsPollTimer);demucsPollTimer=null;
      document.getElementById('demucsStartBtn').disabled=false;
      stage.textContent='‚ùå '+(j.error||j.status);
      toast('Separation fehlgeschlagen: '+(j.error||j.status),'err');
    }
  }catch(e){console.warn('Poll demucs:',e)}
}

function showDemucsResults(jobId,data){
  const list=document.getElementById('demucsStemList');
  list.innerHTML='';
  const stemNames=Object.keys(data.stems||{});
  const labels={vocals:'üé§ Vocals',drums:'ü•Å Drums',bass:'üé∏ Bass',other:'üéπ Other'};
  for(const name of stemNames){
    const div=document.createElement('div');
    div.style.cssText='display:flex;align-items:center;gap:6px;background:var(--bg3);padding:6px 10px;border-radius:6px;border:1px solid var(--border)';
    div.innerHTML=`<span style="font-size:.8rem">${labels[name]||name}</span>
      <a href="${B}/api/separation/${jobId}/download/${name}" target="_blank"
         style="font-size:.65rem;color:var(--accent);text-decoration:none" title="Download">‚¨áÔ∏è</a>`;
    list.appendChild(div);
  }
  document.getElementById('demucsResults').style.display='block';
}

// ‚îÄ‚îÄ Project Mode ‚îÄ‚îÄ
function _updateKstNavLinks(){
  const q=_projMode?'?pid='+encodeURIComponent(_projMode.pid):'';
  const ed=document.getElementById('navEditor');
  const fi=document.getElementById('navFiles');
  if(ed)ed.href='/editor'+q;
  if(fi)fi.href='/files'+q;
  const be=document.getElementById('projBannerEditor');
  if(be)be.href='/editor'+q;
}
async function _initProjectMode(){
  const urlPid=new URLSearchParams(location.search).get('pid');
  if(!urlPid)return false;
  try{
    const proj=await(await fetch(B+'/api/editor/projects/'+encodeURIComponent(urlPid))).json();
    if(!proj||!proj.id)return false;
    _projMode={pid:proj.id,name:proj.name,source_job_id:proj.source_job_id||null};
    // Show project banner
    const banner=document.getElementById('projBanner');
    if(banner)banner.style.display='flex';
    const bn=document.getElementById('projBannerName');
    if(bn)bn.textContent=proj.name;
    _updateKstNavLinks();
    // If project has a linked job, load its segments
    if(proj.source_job_id){
      try{
        const j=await(await fetch(B+'/api/jobs/'+proj.source_job_id)).json();
        if(j&&j.job_id){selJob(j.job_id);return true}
      }catch(e){}
    }
    // Fallback: try to find job_id from subtitle asset paths
    const assets=proj.assets?Object.values(proj.assets):[];
    for(const a of assets){
      if(a.type==='subtitle'&&a.path){
        const m=a.path.match(/data\/output\/([a-f0-9]+)\//);
        if(m){try{const j=await(await fetch(B+'/api/jobs/'+m[1])).json();if(j&&j.job_id){selJob(j.job_id);return true}}catch(e){}}
      }
    }
    toast('Projekt geladen ‚Äî kein verkn√ºpfter Karaoke-Job gefunden');
    return true;
  }catch(e){toast('Projekt nicht gefunden','err');return false}
}
function exitProjectMode(){
  _projMode=null;
  const banner=document.getElementById('projBanner');
  if(banner)banner.style.display='none';
  _updateKstNavLinks();
  // Remove ?pid= from URL without reload
  const url=new URL(location.href);url.searchParams.delete('pid');
  history.replaceState(null,'',url.pathname+url.search);
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
checkH();checkAI();setInterval(checkH,30000);connectSSE();startPoll();
(async()=>{if(!await _initProjectMode())_restoreSession()})();
window.addEventListener('resize',()=>{if(wfPeaks)drawWF()})

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñà‚ñà NEW FEATURES v3.2
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Theme System ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setTheme(t){
  document.documentElement.setAttribute('data-theme',t==='dark'?'':t);
  document.querySelectorAll('.theme-sw button').forEach(b=>b.classList.toggle('on',
    b.classList.contains('tsw-'+t)));
  try{localStorage.setItem('kst-theme',t)}catch(e){}
  // Redraw canvases
  if(wfPeaks)drawWF();if(specAn)drawSpec()}
(function(){try{const t=localStorage.getItem('kst-theme');if(t&&t!=='dark')setTheme(t)}catch(e){}})();

// ‚îÄ‚îÄ Audio Spectrum Visualizer (Web Audio API) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let audioCtx=null,analyser=null,specAn=null,specRaf=0;
function initSpectrum(){
  if(audioCtx)return;
  try{
    audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    analyser=audioCtx.createAnalyser();
    analyser.fftSize=256;analyser.smoothingTimeConstant=0.82;
    const src=audioCtx.createMediaElementSource(au);
    src.connect(analyser);analyser.connect(audioCtx.destination);
    specAn=new Uint8Array(analyser.frequencyBinCount);
    drawSpec()
  }catch(e){console.warn('Spectrum init failed:',e)}}

function drawSpec(){
  if(!analyser||!specAn)return;
  const cv=document.getElementById('specCv');if(!cv)return;
  const r=cv.parentElement.getBoundingClientRect();
  cv.width=r.width*2;cv.height=64;
  const ctx=cv.getContext('2d');
  const bars=analyser.frequencyBinCount;
  const w=cv.width/bars;
  function frame(){
    specRaf=requestAnimationFrame(frame);
    analyser.getByteFrequencyData(specAn);
    ctx.clearRect(0,0,cv.width,cv.height);
    const accent=getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
    const accent2=getComputedStyle(document.documentElement).getPropertyValue('--accent2').trim();
    for(let i=0;i<bars;i++){
      const v=specAn[i]/255;
      const h=v*cv.height;
      const grad=ctx.createLinearGradient(0,cv.height-h,0,cv.height);
      grad.addColorStop(0,accent);grad.addColorStop(1,accent2+'40');
      ctx.fillStyle=grad;
      ctx.fillRect(i*w,cv.height-h,w-1,h)}}
  frame()}

au.addEventListener('play',()=>{initSpectrum();if(audioCtx?.state==='suspended')audioCtx.resume()});

// ‚îÄ‚îÄ A/B Loop Region ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let abA=null,abB=null,abDragging=false,abStartX=0;
function loopDragStart(e){
  if(!wfDur||e.button!==0||!e.shiftKey)return;
  e.preventDefault();abDragging=true;
  const r=e.currentTarget.getBoundingClientRect();
  abStartX=(e.clientX-r.left)/r.width;
  abA=abStartX*wfDur;abB=abA}
function loopDragMove(e){
  if(!abDragging||!wfDur)return;
  const r=document.getElementById('wfC').getBoundingClientRect();
  const x=(e.clientX-r.left)/r.width;
  abB=Math.max(0,Math.min(1,x))*wfDur;
  renderABLoop()}
function loopDragEnd(e){
  if(!abDragging)return;abDragging=false;
  if(abA!==null&&abB!==null&&Math.abs(abB-abA)>0.3){
    if(abA>abB){const t=abA;abA=abB;abB=t}
    document.getElementById('abClear').style.display='inline-block';
    toast(`A/B Loop: ${fmt(abA)} ‚Üí ${fmt(abB)}`)
  }else{clearABLoop()}}
function renderABLoop(){
  const el=document.getElementById('loopRegion');
  const la=document.getElementById('loopLabelA');
  const lb=document.getElementById('loopLabelB');
  if(abA===null||abB===null||!wfDur){el.style.display='none';la.style.display='none';lb.style.display='none';return}
  let a=Math.min(abA,abB)/wfDur*100,b=Math.max(abA,abB)/wfDur*100;
  el.style.display='block';el.style.left=a+'%';el.style.width=(b-a)+'%';
  la.style.display='block';la.style.left=a+'%';
  lb.style.display='block';lb.style.left=b+'%'}
function clearABLoop(){abA=null;abB=null;renderABLoop();
  document.getElementById('abClear').style.display='none'}
// A/B loop enforcement during playback
au.addEventListener('timeupdate',()=>{
  if(abA!==null&&abB!==null&&abA<abB){
    if(au.currentTime>=abB)au.currentTime=abA;
    if(au.currentTime<abA-0.5)au.currentTime=abA}});

// ‚îÄ‚îÄ Split at Playhead ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function splitAtPlayhead(){
  if(!aJobId||!cSegs.length)return;
  const t=au.currentTime;
  // Find segment containing current time
  let idx=-1;
  for(let i=0;i<cSegs.length;i++){
    if(t>=cSegs[i].start&&t<cSegs[i].end){idx=i;break}}
  if(idx<0){toast('Kein Segment bei Playhead','err');return}
  try{
    const r=await(await fetch(B+'/api/jobs/'+aJobId+'/segments/split',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({index:idx,at_time:t})})).json();
    loadSegs(aJobId);toast(`Segment #${idx+1} gesplittet bei ${fmt(t)}`)
  }catch(e){toast('Split: '+e.message,'err')}}

// ‚îÄ‚îÄ Tap-to-Time Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tttActive=false,tttTaps=[],tttLineIdx=0;
function toggleTapToTime(){
  if(!cSegs.length&&!tttActive){toast('Erst Segmente laden','err');return}
  const ov=document.getElementById('tttOverlay');
  if(tttActive){
    tttActive=false;ov.classList.remove('open');au.pause();
    if(tttTaps.length>1)applyTapTimings();return}
  tttActive=true;tttTaps=[];tttLineIdx=0;
  ov.classList.add('open');renderTTTLines();
  au.currentTime=0;
  toast('Tap-to-Time: Audio startet, SPACE f√ºr jede Zeile dr√ºcken')}

function renderTTTLines(){
  const el=document.getElementById('tttLines');if(!el)return;
  let h='';
  cSegs.forEach((s,i)=>{
    const cls=i<tttLineIdx?'ttt-line done':i===tttLineIdx?'ttt-line active':'ttt-line';
    h+=`<div class="${cls}" id="tttL${i}">${esc(s.text)}</div>`});
  el.innerHTML=h;
  // Scroll active into view
  const act=document.getElementById('tttL'+tttLineIdx);
  if(act)act.scrollIntoView({behavior:'smooth',block:'center'})}

function tttTap(){
  if(!tttActive)return;
  const t=au.currentTime;
  tttTaps.push(t);
  // Flash effect
  const fl=document.getElementById('tttFlash');
  fl.style.opacity='0.15';setTimeout(()=>fl.style.opacity='0',80);
  // Counter pulse
  const ctr=document.getElementById('tttCounter');
  ctr.textContent=tttTaps.length;
  ctr.classList.add('pulse');setTimeout(()=>ctr.classList.remove('pulse'),100);
  // Advance line
  tttLineIdx++;
  if(tttLineIdx>=cSegs.length){
    toast('Alle Zeilen getappt! Anwenden...');
    setTimeout(()=>{tttActive=false;
      document.getElementById('tttOverlay').classList.remove('open');
      au.pause();applyTapTimings()},500);return}
  renderTTTLines();
  // Progress bar
  const pct=tttLineIdx/cSegs.length*100;
  document.getElementById('tttPBar').style.width=pct+'%'}

function tttStartAudio(){
  if(!tttActive)return;
  au.currentTime=0;au.play();
  document.getElementById('tttHintStart').style.display='none';
  document.getElementById('tttHintTap').style.display='block'}

function applyTapTimings(){
  if(tttTaps.length<2||!cSegs.length)return;
  const was=[...cSegs];
  // Each tap = start of that line, end of previous line
  for(let i=0;i<Math.min(tttTaps.length,cSegs.length);i++){
    cSegs[i].start=Math.round(tttTaps[i]*1000)/1000;
    if(i>0)cSegs[i-1].end=cSegs[i].start;
    // Estimate end of last tapped segment
    if(i===tttTaps.length-1&&i<cSegs.length-1){
      const avgDur=tttTaps.length>1?(tttTaps[tttTaps.length-1]-tttTaps[0])/(tttTaps.length-1):2;
      cSegs[i].end=Math.round((cSegs[i].start+avgDur)*1000)/1000}}
  // Save to server
  if(aJobId){
    fetch(B+'/api/jobs/'+aJobId+'/segments/bulk',{
      method:'PUT',headers:{'Content-Type':'application/json'},
      body:JSON.stringify(cSegs)}).then(()=>loadSegs(aJobId))}
  renderSegs();drawMM();
  toast(`Tap-to-Time: ${tttTaps.length} Timestamps angewendet`)}

// ‚îÄ‚îÄ Fullscreen Karaoke Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let fskActive=false;
function toggleFSKaraoke(){
  if(!cSegs.length){toast('Erst Segmente laden','err');return}
  const el=document.getElementById('fskOverlay');
  if(fskActive){fskActive=false;el.classList.remove('open');return}
  fskActive=true;el.classList.add('open');
  if(au.paused)au.play();
  fskRender()}
function fskRender(){
  if(!fskActive)return;
  requestAnimationFrame(fskRender);
  const t=subTime();
  const txt=document.getElementById('fskText');
  const nxt=document.getElementById('fskNext');
  const bar=document.getElementById('fskBar');
  const time=document.getElementById('fskTime');
  // Find current segment
  let ci=-1;
  for(let i=0;i<cSegs.length;i++){
    if(t>=cSegs[i].start&&t<cSegs[i].end){ci=i;break}}
  if(ci<0){
    // Between segments ‚Äî find next
    for(let i=0;i<cSegs.length;i++){if(cSegs[i].start>t){
      txt.innerHTML=`<span style="opacity:.3">‚ô™</span>`;
      nxt.textContent=cSegs[i].text;break};
      if(i===cSegs.length-1){txt.innerHTML='<span style="opacity:.3">‚Äî Ende ‚Äî</span>';nxt.textContent=''}}
  }else{
    const seg=cSegs[ci];
    // Word-level highlighting if available
    const fskWords=_wordsMatch(seg);
    if(fskWords){
      const mode=_getKaraokeMode();
      const hlC=getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()||'#00e5a0';
      let wH='';
      for(const w of seg.words){
        if(t>=w.end){wH+=`<span class="fsk-word hl">${esc(w.word)} </span>`}
        else if(t>=w.start){
          if(mode==='kf'){
            const pct=Math.min(100,Math.round((t-w.start)/(w.end-w.start)*100));
            wH+=`<span class="fsk-word fsk-fill" style="background-image:linear-gradient(90deg,${hlC} ${pct}%,#fff ${pct}%)">${esc(w.word)} </span>`}
          else{wH+=`<span class="fsk-word hl">${esc(w.word)} </span>`}}
        else{wH+=`<span class="fsk-word">${esc(w.word)} </span>`}}
      txt.innerHTML=wH
    }else{txt.innerHTML=`<span class="fsk-word hl">${esc(seg.text)}</span>`}
    nxt.textContent=ci<cSegs.length-1?cSegs[ci+1].text:''}
  // Progress (use real audio time, not offset-shifted)
  const rt=au.currentTime;
  if(wfDur>0)bar.style.width=(rt/wfDur*100)+'%';
  time.textContent=fmt(rt)+' / '+fmt(wfDur||0)}

// ‚îÄ‚îÄ Keyboard Shortcuts (extended) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown',e=>{
  // Tap-to-Time intercepts
  if(tttActive){
    if(e.code==='Space'){e.preventDefault();if(au.paused)tttStartAudio();else tttTap();return}
    if(e.key==='Escape'){toggleTapToTime();return}
    return}
  // Fullscreen karaoke
  if(fskActive){
    if(e.key==='Escape'||e.key==='f'||e.key==='F'){toggleFSKaraoke();return}
    if(e.code==='Space'){e.preventDefault();togglePlay();return}
    if(e.key==='ArrowLeft'){e.preventDefault();skipTo(-5);return}
    if(e.key==='ArrowRight'){e.preventDefault();skipTo(5);return}
    return}
  // Normal mode
  if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA')return;
  if(e.key==='t'||e.key==='T'){e.preventDefault();toggleTapToTime();return}
  if(e.key==='f'&&!e.ctrlKey){e.preventDefault();toggleFSKaraoke();return}
  if(e.key==='s'&&!e.ctrlKey){e.preventDefault();splitAtPlayhead();return}
  if(e.key==='c'&&e.shiftKey&&!e.ctrlKey){e.preventDefault();clearABLoop();return}
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñà‚ñà TEXT EDITOR MODAL ‚Äî plain text editing (one line = one segment)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){
let _open=false, _dirty=false, _origText='';

window.openSubEditor=function(){
  if(!aJobId||!cSegs.length){toast('Erst transkribieren','err');return}
  _open=true;_dirty=false;
  const ta=document.getElementById('subeTa');
  const text=cSegs.map(s=>s.text).join('\n');
  ta.value=text;_origText=text;
  document.getElementById('subEditorBg').classList.add('open');
  _updateInfo();_updateStats();
  ta.focus();
  ta.setSelectionRange(0,0);
};

window.saveTextEditor=async function(){
  if(!aJobId||!cSegs.length)return;
  const ta=document.getElementById('subeTa');
  const lines=ta.value.split('\n');
  // Map lines back to segments ‚Äî update text only, keep timing
  let changed=0;
  for(let i=0;i<cSegs.length;i++){
    const newText=(i<lines.length?lines[i]:'').trim();
    if(cSegs[i].text!==newText){cSegs[i].text=newText;changed++}
  }
  // Handle extra lines: append as info to last segment
  if(lines.length>cSegs.length){
    const extra=lines.slice(cSegs.length).filter(l=>l.trim()).join(' ');
    if(extra){cSegs[cSegs.length-1].text+=' '+extra;changed++}
  }
  if(changed===0){toast('Keine √Ñnderungen');return}
  try{
    toast('Speichere '+changed+' √Ñnderungen‚Ä¶');
    await fetch(B+'/api/jobs/'+aJobId+'/segments/bulk',{method:'PUT',
      headers:{'Content-Type':'application/json'},body:JSON.stringify(cSegs)});
    _dirty=false;_origText=ta.value;
    _updateStats();
    toast('‚úì '+changed+' Segmente aktualisiert');
  }catch(e){toast('Fehler: '+e.message,'err')}
};

function _updateInfo(){
  document.getElementById('subeInfo').textContent=cSegs.length+' Segmente';
}

function _updateStats(){
  const ta=document.getElementById('subeTa');
  const text=ta.value;
  const lines=text.split('\n').length;
  const words=text.trim()?text.trim().split(/\s+/).length:0;
  const chars=text.length;
  const el=document.getElementById('subeStats');
  el.textContent=lines+' Zeilen ¬∑ '+words+' W√∂rter ¬∑ '+chars+' Zeichen';
  el.classList.toggle('sube-dirty',_dirty);
  document.getElementById('subeSaveBtn').style.opacity=_dirty?'1':'.5';
}

// Track dirty state
function _onTaInput(){
  _dirty=this.value!==_origText;
  _updateStats();
}

// Keyboard shortcuts
function _onKeydown(e){
  if(!_open)return;
  if(e.key==='Escape'){e.stopPropagation();closeSubEditor();return}
  if(e.ctrlKey&&e.key==='s'){e.preventDefault();e.stopPropagation();saveTextEditor();return}
}

// Bind events lazily (DOM elements are below this script)
function _bindEvents(){
  const ta=document.getElementById('subeTa');
  const bg=document.getElementById('subEditorBg');
  if(ta&&!ta._bound){ta.addEventListener('input',_onTaInput);ta._bound=true}
  if(bg&&!bg._bound){bg.addEventListener('keydown',_onKeydown);bg._bound=true}
}
// Bind on DOMContentLoaded + also on open (belt & suspenders)
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',_bindEvents)}
else{setTimeout(_bindEvents,0)}

const _origOpen=window.openSubEditor;
window.openSubEditor=function(){_bindEvents();_origOpen();};

// Close + refresh main UI
window.closeSubEditor=function(){
  if(_dirty&&!confirm('Ungespeicherte √Ñnderungen verwerfen?'))return;
  _open=false;_dirty=false;
  document.getElementById('subEditorBg').classList.remove('open');
  renderSegs();drawWF();drawMM();
};

})(); // end IIFE

</script>

<!-- Text Editor Modal -->
<div class="sube-bg" id="subEditorBg" onclick="if(event.target===this)closeSubEditor()">
<div class="sube">
  <div class="sube-head">
    <span style="font-size:1.1rem">üìù</span>
    <h2>Text Editor</h2>
    <span class="sube-info" id="subeInfo">‚Äî</span>
    <div class="modal-close" onclick="closeSubEditor()" title="Schlie√üen">‚úï</div>
  </div>
  <div class="sube-body">
    <div class="sube-hint">Eine Zeile = ein Segment ¬∑ Timings bleiben erhalten ¬∑ Ctrl+S zum Speichern ¬∑ Esc zum Schlie√üen</div>
    <textarea class="sube-ta" id="subeTa" spellcheck="true"></textarea>
  </div>
  <div class="sube-foot">
    <span class="sube-stats" id="subeStats">‚Äî</span>
    <button class="btn-s" id="subeSaveBtn" onclick="saveTextEditor()" style="opacity:.5" title="Alle Text-√Ñnderungen in Segmente √ºbernehmen">üíæ Speichern (Ctrl+S)</button>
    <button class="btn" onclick="closeSubEditor()" title="Text-Editor schlie√üen">‚úï Schlie√üen</button>
  </div>
</div>
</div>

<!-- Tap-to-Time Overlay -->
<div class="ttt-overlay" id="tttOverlay">
  <div id="tttFlash" class="ttt-flash"></div>
  <div class="ttt-counter" id="tttCounter">0</div>
  <div id="tttLines" style="max-height:50vh;overflow-y:auto;width:80vw;display:flex;flex-direction:column;align-items:center;gap:8px"></div>
  <div class="ttt-progress"><div class="ttt-progress-bar" id="tttPBar" style="width:0%"></div></div>
  <div class="ttt-hint" id="tttHintStart">‚ñ∂ SPACE dr√ºcken zum Starten</div>
  <div class="ttt-hint" id="tttHintTap" style="display:none">‚éµ SPACE = n√§chste Zeile &nbsp;|&nbsp; ESC = Abbrechen &amp; anwenden</div>
</div>

<!-- Fullscreen Karaoke Overlay -->
<div class="fsk" id="fskOverlay">
  <div class="fsk-text" id="fskText">‚ô™</div>
  <div class="fsk-next" id="fskNext"></div>
  <div class="fsk-progress" id="fskBar" style="width:0%"></div>
  <div class="fsk-time" id="fskTime"></div>
</div>

</body>
</html>
