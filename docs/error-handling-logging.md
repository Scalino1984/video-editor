# Error Handling & Logging

## Logging Setup

The application uses `src/utils/logging.py` with Rich console output and file rotation.

```python
from src.utils.logging import info, success, warn, error, debug
```

**Never** use stdlib `logging` directly — always import from `src.utils.logging`.

### Verbosity Levels

| Level | Description |
|-------|-------------|
| `SILENT` | No console output |
| `NORMAL` | Standard operational messages |
| `VERBOSE` | Debug-level detail |

### Log Outputs

| Output | Path | Rotation |
|--------|------|----------|
| Console | stdout (Rich formatted) | N/A |
| File | `logs/karaoke.log` | 10 MB, 5 backups |
| Render | `logs/render.log` | 10 MB, 3 backups |

## Request/Job Correlation

### Request ID

- Generated by `RequestIdMiddleware` in `main.py`
- Stored in `ContextVar` (thread-safe, async-safe)
- Propagated via `x-request-id` header (accepts client-provided or generates UUID)
- Included in all log messages via `ContextFormatter`
- Returned in response header `x-request-id`

### Job ID

- Generated as `uuid4().hex[:12]` on job creation
- Used as directory name: `data/output/{job_id}/`
- Logged as prefix: `[{job_id}] message`
- Stored in library DB (`transcriptions.job_id`)
- Available via SSE events (`job_id` field)

## Error Envelope

### API Error Responses

All API errors use FastAPI's `HTTPException`:

```json
{
  "detail": "Human-readable error message"
}
```

| Status | Meaning |
|--------|---------|
| 400 | Bad request (invalid input, bad index) |
| 403 | Access denied (path traversal attempt) |
| 404 | Resource not found |
| 429 | System busy — backpressure (retry later) |
| 500 | Internal server error |

### Job Errors

Failed jobs store the error message:

```json
{
  "job_id": "abc123",
  "status": "failed",
  "error": "Demucs nicht verfügbar",
  "stage": "Fehler"
}
```

### SSE Error Events

```json
{"type": "job_failed", "job_id": "abc123", "error": "..."}
```

## Security: What is NOT Exposed

- **No absolute paths** in client responses (only relative paths or filenames)
- **No stack traces** in API responses (logged server-side only)
- **No secrets/API keys** in logs or responses
- **Path traversal protection** via `resolve() + is_relative_to()` on all file-serving endpoints
